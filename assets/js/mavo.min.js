!function(){"use strict";function e(t,i,s){return i=void 0===i?1:i,(s=s||i+1)-i<=1?function(){if(arguments.length<=i||"string"===r.type(arguments[i]))return t.apply(this,arguments);var e,s,n=arguments[i];for(s in n){var a=Array.prototype.slice.call(arguments);a.splice(i,1,s,n[s]),e=t.apply(this,a)}return e}:e(e(t,i+1,s),i,s-1)}function t(e,r,s){var n=i(s);if("string"===n){var a=Object.getOwnPropertyDescriptor(r,s);!a||a.writable&&a.configurable&&a.enumerable&&!a.get&&!a.set?e[s]=r[s]:(delete e[s],Object.defineProperty(e,s,a))}else if("array"===n)s.forEach((function(i){i in r&&t(e,r,i)}));else for(var o in r)s&&("regexp"===n&&!s.test(o)||"function"===n&&!s.call(r,o))||t(e,r,o);return e}function i(e){if(null===e)return"null";if(void 0===e)return"undefined";var t=(Object.prototype.toString.call(e).match(/^\[object\s+(.*?)\]$/)[1]||"").toLowerCase();return"number"==t&&isNaN(e)?"nan":t}var r=self.Bliss=t((function(e,t){return 2==arguments.length&&!t||!e?null:"string"===r.type(e)?(t||document).querySelector(e):e||null}),self.Bliss);t(r,{extend:t,overload:e,type:i,property:r.property||"_",listeners:new(self.WeakMap?WeakMap:Map),original:{addEventListener:(self.EventTarget||Node).prototype.addEventListener,removeEventListener:(self.EventTarget||Node).prototype.removeEventListener},sources:{},noop:function(){},$:function(e,t){return e instanceof Node||e instanceof Window?[e]:2!=arguments.length||t?Array.prototype.slice.call("string"==typeof e?(t||document).querySelectorAll(e):e||[]):[]},defined:function(){for(var e=0;e<arguments.length;e++)if(void 0!==arguments[e])return arguments[e]},create:function(e,t){return e instanceof Node?r.set(e,t):(1===arguments.length&&(t="string"===r.type(e)?{}:(e=(t=e).tag,r.extend({},t,(function(e){return"tag"!==e})))),r.set(document.createElement(e||"div"),t))},each:function(e,t,i){for(var r in i=i||{},e)i[r]=t.call(e,r,e[r]);return i},ready:function(e,t,i){if("function"!=typeof e||t||(t=e,e=void 0),e=e||document,t&&("loading"!==e.readyState?t():r.once(e,"DOMContentLoaded",(function(){t()}))),!i)return new Promise((function(t){r.ready(e,t,!0)}))},Class:function(e){var t,i,s=["constructor","extends","abstract","static"].concat(Object.keys(r.classProps)),n=e.hasOwnProperty("constructor")?e.constructor:r.noop;function a(e){return this.hasOwnProperty(e)&&-1===s.indexOf(e)}if(2==arguments.length?(i=arguments[0],e=arguments[1]):((i=function(){if(this.constructor.__abstract&&this.constructor===i)throw new Error("Abstract classes cannot be directly instantiated.");i.super&&!t&&i.super.apply(this,arguments),n.apply(this,arguments)}).super=e.extends||null,!i.super||(t=0===(i.super+"").indexOf("class ")),i.prototype=r.extend(Object.create(i.super?i.super.prototype:Object),{constructor:i}),i.prototype.super=i.super?i.super.prototype:null,i.__abstract=!!e.abstract),e.static)for(var o in r.extend(i,e.static,a),r.classProps)o in e.static&&r.classProps[o](i,e.static[o]);for(o in r.extend(i.prototype,e,a),r.classProps)o in e&&r.classProps[o](i.prototype,e[o]);return i},classProps:{lazy:e((function(e,t,i){return Object.defineProperty(e,t,{get:function(){var e=i.call(this);return Object.defineProperty(this,t,{value:e,configurable:!0,enumerable:!0,writable:!0}),e},set:function(e){Object.defineProperty(this,t,{value:e,configurable:!0,enumerable:!0,writable:!0})},configurable:!0,enumerable:!0}),e})),live:e((function(e,t,i){return"function"===r.type(i)&&(i={set:i}),Object.defineProperty(e,t,{get:function(){var e=this["_"+t],r=i.get&&i.get.call(this,e);return void 0!==r?r:e},set:function(e){var r=this["_"+t];r=i.set&&i.set.call(this,e,r);this["_"+t]=void 0!==r?r:e},configurable:i.configurable,enumerable:i.enumerable}),e}))},include:function(){var e=arguments[arguments.length-1],t=2===arguments.length&&arguments[0],i=document.createElement("script");return t?Promise.resolve():new Promise((function(t,s){r.set(i,{async:!0,onload:function(){t(i),i.parentNode&&i.parentNode.removeChild(i)},onerror:function(){s(i)},src:e,inside:document.head})}))},load:function e(t,i){return i=i?new URL(i,location.href):location.href,t=new URL(t,i),(i=e.loading=e.loading||{})[t+""]||(/\.css$/.test(t.pathname)?i[t+""]=new Promise((function(e,i){var s=r.create("link",{href:t,rel:"stylesheet",inside:document.head,onload:function(){e(s)},onerror:function(){i(s)}})})):i[t+""]=r.include(t))},fetch:function(e,i){if(!e)throw new TypeError("URL parameter is mandatory and cannot be "+e);var s,n=t({url:new URL(e,location),data:"",method:"GET",headers:{},xhr:new XMLHttpRequest},i);for(s in n.method=n.method.toUpperCase(),r.hooks.run("fetch-args",n),"GET"===n.method&&n.data&&(n.url.search+=n.data),document.body.setAttribute("data-loading",n.url),n.xhr.open(n.method,n.url.href,!1!==n.async,n.user,n.password),i)if("upload"===s)n.xhr.upload&&"object"==typeof i[s]&&r.extend(n.xhr.upload,i[s]);else if(s in n.xhr)try{n.xhr[s]=i[s]}catch(e){self.console}var a;e=Object.keys(n.headers).map((function(e){return e.toLowerCase()}));for(a in"GET"!==n.method&&-1===e.indexOf("content-type")&&n.xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.headers)void 0!==n.headers[a]&&n.xhr.setRequestHeader(a,n.headers[a]);return e=new Promise((function(e,t){n.xhr.onload=function(){document.body.removeAttribute("data-loading"),0===n.xhr.status||200<=n.xhr.status&&n.xhr.status<300||304===n.xhr.status?e(n.xhr):t(r.extend(Error(n.xhr.statusText),{xhr:n.xhr,get status(){return this.xhr.status}}))},n.xhr.onerror=function(){document.body.removeAttribute("data-loading"),t(r.extend(Error("Network Error"),{xhr:n.xhr}))},n.xhr.ontimeout=function(){document.body.removeAttribute("data-loading"),t(r.extend(Error("Network Timeout"),{xhr:n.xhr}))},n.xhr.send("GET"===n.method?null:n.data)})),e.xhr=n.xhr,e},value:function(e){var t="string"!=typeof e;return r.$(arguments).slice(+t).reduce((function(e,t){return e&&e[t]}),t?e:self)}}),r.Hooks=new r.Class({add:function(e,t,i){if("string"==typeof arguments[0])(Array.isArray(e)?e:[e]).forEach((function(e){this[e]=this[e]||[],t&&this[e][i?"unshift":"push"](t)}),this);else for(var e in arguments[0])this.add(e,arguments[0][e],t)},run:function(e,t){this[e]=this[e]||[],this[e].forEach((function(e){e.call(t&&t.context?t.context:t,t)}))}}),r.hooks=new r.Hooks,r.property,r.Element=function(e){this.subject=e,this.data={},this.bliss={}},r.Element.prototype={set:e((function(e,t){e in r.setProps?r.setProps[e].call(this,t):e in this?this[e]=t:this.setAttribute(e,t)}),0),transition:function(e,t){return new Promise(function(i,s){var n,a;"transition"in this.style&&0!==t?(n=r.extend({},this.style,/^transition(Duration|Property)$/),r.style(this,{transitionDuration:(t||400)+"ms",transitionProperty:Object.keys(e).join(", ")}),r.once(this,"transitionend",(function(){clearTimeout(a),r.style(this,n),i(this)})),a=setTimeout(i,t+50,this),r.style(this,e)):(r.style(this,e),i(this))}.bind(this))},fire:function(e,t){var i=document.createEvent("HTMLEvents");return i.initEvent(e,!0,!0),this.dispatchEvent(r.extend(i,t))},bind:e((function(e,t){var i;1<arguments.length&&("function"===r.type(t)||t.handleEvent)&&(i=t,(t="object"===r.type(arguments[2])?arguments[2]:{capture:!!arguments[2]}).callback=i);var s=r.listeners.get(this)||{};e.trim().split(/\s+/).forEach((function(e){var i;-1<e.indexOf(".")&&(i=(e=e.split("."))[1],e=e[0]),s[e]=s[e]||[],0===s[e].filter((function(e){return e.callback===t.callback&&e.capture==t.capture})).length&&s[e].push(r.extend({className:i},t)),r.original.addEventListener.call(this,e,t.callback,t)}),this),r.listeners.set(this,s)}),0),unbind:e((function(e,t){var i;t&&("function"===r.type(t)||t.handleEvent)&&(i=t,t=arguments[2]),(t=(t="boolean"==r.type(t)?{capture:t}:t)||{}).callback=t.callback||i;var s=r.listeners.get(this);(e||"").trim().split(/\s+/).forEach((function(e){var i,n;if(-1<e.indexOf(".")&&(i=(e=e.split("."))[1],e=e[0]),!s)return e&&t.callback?r.original.removeEventListener.call(this,e,t.callback,t.capture):void 0;for(n in s)if(!e||n===e)for(var a,o=0;a=s[n][o];o++)i&&i!==a.className||t.callback&&t.callback!==a.callback||!!t.capture!=!!a.capture&&(e||t.callback||void 0!==t.capture)||(s[n].splice(o,1),r.original.removeEventListener.call(this,n,a.callback,a.capture),o--)}),this)}),0),when:function(e,t){var i=this;return new Promise((function(r){i.addEventListener(e,(function i(s){t&&!t.call(this,s)||(this.removeEventListener(e,i),r(s))}))}))},toggleAttribute:function(e,t,i){(i=arguments.length<3?null!==t:i)?this.setAttribute(e,t):this.removeAttribute(e)}},r.setProps={style:function(e){for(var t in e)t in this.style?this.style[t]=e[t]:this.style.setProperty(t,e[t])},attributes:function(e){for(var t in e)this.setAttribute(t,e[t])},properties:function(e){r.extend(this,e)},events:function(e){if(1!=arguments.length||!e||!e.addEventListener)return r.bind.apply(this,[this].concat(r.$(arguments)));var t,i=this;if(r.listeners){var s,n=r.listeners.get(e);for(s in n)n[s].forEach((function(e){r.bind(i,s,e.callback,e.capture)}))}for(t in e)0===t.indexOf("on")&&(this[t]=e[t])},once:e((function(e,t){var i=this;r.bind(this,e,(function s(){return r.unbind(i,e,s),t.apply(i,arguments)}),{once:!0})}),0),delegate:e((function(e,t,i){r.bind(this,e,(function(e){e.target.closest(t)&&i.call(this,e)}))}),0,2),contents:function(e){!e&&0!==e||(Array.isArray(e)?e:[e]).forEach((function(e){var t=r.type(e);/^(string|number)$/.test(t)?e=document.createTextNode(e+""):"object"===t&&(e=r.create(e)),e instanceof Node&&this.appendChild(e)}),this)},inside:function(e){e&&e.appendChild(this)},before:function(e){e&&e.parentNode.insertBefore(this,e)},after:function(e){e&&e.parentNode.insertBefore(this,e.nextSibling)},start:function(e){e&&e.insertBefore(this,e.firstChild)},around:function(e){e&&e.parentNode&&r.before(this,e),this.appendChild(e)}},r.Array=function(e){this.subject=e},r.Array.prototype={all:function(e){var t=r.$(arguments).slice(1);return this[e].apply(this,t)}},r.add=e((function(e,t,i,s){i=r.extend({$:!0,element:!0,array:!0},i),"function"==r.type(t)&&(!i.element||e in r.Element.prototype&&s||(r.Element.prototype[e]=function(){return this.subject&&r.defined(t.apply(this.subject,arguments),this.subject)}),!i.array||e in r.Array.prototype&&s||(r.Array.prototype[e]=function(){var e=arguments;return this.subject.map((function(i){return i&&r.defined(t.apply(i,e),i)}))}),i.$&&(r.sources[e]=r[e]=t,(i.array||i.element)&&(r[e]=function(){var t=[].slice.apply(arguments),s=t.shift(),n=i.array&&Array.isArray(s)?"Array":"Element";return r[n].prototype[e].apply({subject:s},t)})))}),0),r.add(r.Array.prototype,{element:!1}),r.add(r.Element.prototype),r.add(r.setProps),r.add(r.classProps,{element:!1,array:!1});var s=document.createElement("_");r.add(r.extend({},HTMLElement.prototype,(function(e){return"function"===r.type(s[e])})),null,!0)}();var jsep=function(e){"use strict";const t="Compound",i="MemberExpression",r="Literal";let s=function(e,t){let i=new Error(e+" at character "+t);throw i.index=t,i.description=e,i},n={"-":1,"!":1,"~":1,"+":1},a={"||":1,"&&":2,"|":3,"^":4,"&":5,"==":6,"!=":6,"===":6,"!==":6,"<":7,">":7,"<=":7,">=":7,"<<":8,">>":8,">>>":8,"+":9,"-":9,"*":10,"/":10,"%":10},o={$:1,_:1},l=function(e){return Math.max(0,...Object.keys(e).map((e=>e.length)))},u=l(n),h=l(a),d={true:!0,false:!1,null:null},c=function(e){return a[e]||0},p=function(e,t,i){return{type:"BinaryExpression",operator:e,left:t,right:i}},v=function(e){return e>=48&&e<=57},m=function(e){return e>=65&&e<=90||e>=97&&e<=122||e>=128&&!a[String.fromCharCode(e)]||o.hasOwnProperty(String.fromCharCode(e))},f=function(e){return m(e)||v(e)},g=function(e){let o,l,g=0,y=e.charAt,b=e.charCodeAt,x=function(t){return y.call(e,t)},M=function(t){return b.call(e,t)},w=e.length,A=function(){let e=M(g);for(;32===e||9===e||10===e||13===e;)e=M(++g)},E=function(){let e,t,i=k();return A(),63!==M(g)?i:(g++,e=E(),e||s("Expected expression",g),A(),58===M(g)?(g++,t=E(),t||s("Expected expression",g),{type:"ConditionalExpression",test:i,consequent:e,alternate:t}):void s("Expected :",g))},C=function(){A();let t=e.substr(g,h),i=t.length;for(;i>0;){if(a.hasOwnProperty(t)&&(!m(M(g))||g+t.length<e.length&&!f(M(g+t.length))))return g+=i,t;t=t.substr(0,--i)}return!1},k=function(){let e,t,i,r,n,a,o,l,u;if(a=O(),t=C(),!t)return a;for(n={value:t,prec:c(t)},o=O(),o||s("Expected expression after "+t,g),r=[a,n,o];(t=C())&&(i=c(t),0!==i);){for(n={value:t,prec:i},u=t;r.length>2&&i<=r[r.length-2].prec;)o=r.pop(),t=r.pop().value,a=r.pop(),e=p(t,a,o),r.push(e);e=O(),e||s("Expected expression after "+u,g),r.push(n,e)}for(l=r.length-1,e=r[l];l>1;)e=p(r[l-1].value,r[l-2],e),l-=2;return e},O=function(){let t,r,a,o;if(A(),t=M(g),v(t)||46===t)return N();if(39===t||34===t)o=P();else if(91===t)o=D();else{for(r=e.substr(g,u),a=r.length;a>0;){if(n.hasOwnProperty(r)&&(!m(M(g))||g+r.length<e.length&&!f(M(g+r.length))))return g+=a,{type:"UnaryExpression",operator:r,argument:O(),prefix:!0};r=r.substr(0,--a)}m(t)?o=S():40===t&&(o=L())}if(!o)return!1;for(A(),t=M(g);46===t||91===t||40===t;)g++,46===t?(A(),o={type:i,computed:!1,object:o,property:S()}):91===t?(o={type:i,computed:!0,object:o,property:E()},A(),t=M(g),93!==t&&s("Unclosed [",g),g++):40===t&&(o={type:"CallExpression",arguments:T(41),callee:o}),A(),t=M(g);return o},N=function(){let e,t,i="";for(;v(M(g));)i+=x(g++);if(46===M(g))for(i+=x(g++);v(M(g));)i+=x(g++);if(e=x(g),"e"===e||"E"===e){for(i+=x(g++),e=x(g),"+"!==e&&"-"!==e||(i+=x(g++));v(M(g));)i+=x(g++);v(M(g-1))||s("Expected exponent ("+i+x(g)+")",g)}return t=M(g),m(t)?s("Variable names cannot start with a number ("+i+x(g)+")",g):46===t&&s("Unexpected period",g),{type:r,value:parseFloat(i),raw:i}},P=function(){let e="",t=x(g++),i=!1;for(;g<w;){let r=x(g++);if(r===t){i=!0;break}if("\\"===r)switch(r=x(g++),r){case"n":e+="\n";break;case"r":e+="\r";break;case"t":e+="\t";break;case"b":e+="\b";break;case"f":e+="\f";break;case"v":e+="\v";break;default:e+=r}else e+=r}return i||s('Unclosed quote after "'+e+'"',g),{type:r,value:e,raw:t+e+t}},S=function(){let t,i=M(g),n=g;for(m(i)?g++:s("Unexpected "+x(g),g);g<w&&(i=M(g),f(i));)g++;return t=e.slice(n,g),d.hasOwnProperty(t)?{type:r,value:d[t],raw:t}:"this"===t?{type:"ThisExpression"}:{type:"Identifier",name:t}},T=function(e){let i=[],r=!1,n=0;for(;g<w;){A();let a=M(g);if(a===e){r=!0,g++,41===e&&n&&n>=i.length&&s("Unexpected token "+String.fromCharCode(e),g);break}if(44===a){if(g++,n++,n!==i.length)if(41===e)s("Unexpected token ,",g);else if(93===e)for(let e=i.length;e<n;e++)i.push(null)}else{let e=E();e&&e.type!==t||s("Expected comma",g),i.push(e)}}return r||s("Expected "+String.fromCharCode(e),g),i},L=function(){g++;let e=E();if(A(),41===M(g))return g++,e;s("Unclosed (",g)},D=function(){return g++,{type:"ArrayExpression",elements:T(93)}},j=[];for(;g<w;)o=M(g),59===o||44===o?g++:(l=E())?j.push(l):g<w&&s('Unexpected "'+x(g)+'"',g);return 1===j.length?j[0]:{type:t,body:j}};return g.version="0.4.0",g.toString=function(){return"JavaScript Expression Parser (JSEP) v"+g.version},g.addUnaryOp=function(e){return u=Math.max(e.length,u),n[e]=1,this},g.addBinaryOp=function(e,t){return h=Math.max(e.length,h),a[e]=t,this},g.addIdentifierChar=function(e){return o[e]=1,this},g.addLiteral=function(e,t){return d[e]=t,this},g.removeUnaryOp=function(e){return delete n[e],e.length===u&&(u=l(n)),this},g.removeAllUnaryOps=function(){return n={},u=0,this},g.removeIdentifierChar=function(e){return delete o[e],this},g.removeBinaryOp=function(e){return delete a[e],e.length===h&&(h=l(a)),this},g.removeAllBinaryOps=function(){return a={},h=0,this},g.removeLiteral=function(e){return delete d[e],this},g.removeAllLiterals=function(){return d={},this},e.default=g,Object.defineProperty(e,"__esModule",{value:!0}),e}({});function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}!function(e){"use strict";var t="Compound",i="MemberExpression",r="Literal",s=function(e,t){var i=new Error(e+" at character "+t);throw i.index=t,i.description=e,i},n={"-":!0,"!":!0,"~":!0,"+":!0},a={"||":1,"&&":2,"|":3,"^":4,"&":5,"==":6,"!=":6,"===":6,"!==":6,"<":7,">":7,"<=":7,">=":7,"<<":8,">>":8,">>>":8,"+":9,"-":9,"*":10,"/":10,"%":10},o=function(e){var t,i=0;for(var r in e)(t=r.length)>i&&e.hasOwnProperty(r)&&(i=t);return i},l=o(n),u=o(a),h={true:!0,false:!1,null:null},d=function(e){return a[e]||0},c=function(e,t,i){return{type:"||"===e||"&&"===e?"LogicalExpression":"BinaryExpression",operator:e,left:t,right:i}},p=function(e){return 48<=e&&e<=57},v=function(e){return 36===e||95===e||65<=e&&e<=90||97<=e&&e<=122||128<=e&&!a[String.fromCharCode(e)]},m=function(e){return 36===e||95===e||65<=e&&e<=90||97<=e&&e<=122||48<=e&&e<=57||128<=e&&!a[String.fromCharCode(e)]},f=function(e){for(var o,f,g=0,y=e.charAt,b=e.charCodeAt,x=function(t){return y.call(e,t)},M=function(t){return b.call(e,t)},w=e.length,A=function(){for(var e=M(g);32===e||9===e||10===e||13===e;)e=M(++g)},E=function(){var e,t,i=k();return A(),63!==M(g)?i:(g++,(e=E())||s("Expected expression",g),A(),58===M(g)?(g++,(t=E())||s("Expected expression",g),{type:"ConditionalExpression",test:i,consequent:e,alternate:t}):void s("Expected :",g))},C=function(){A();for(var t=e.substr(g,u),i=t.length;0<i;){if(a.hasOwnProperty(t)&&(!v(M(g))||g+t.length<e.length&&!m(M(g+t.length))))return g+=i,t;t=t.substr(0,--i)}return!1},k=function(){var e,t,i,r,n,a,o,l,u;if(a=O(),!(t=C()))return a;for(n={value:t,prec:d(t)},(o=O())||s("Expected expression after "+t,g),r=[a,n,o];(t=C())&&0!==(i=d(t));){for(n={value:t,prec:i},u=t;2<r.length&&i<=r[r.length-2].prec;)o=r.pop(),t=r.pop().value,a=r.pop(),e=c(t,a,o),r.push(e);(e=O())||s("Expected expression after "+u,g),r.push(n,e)}for(e=r[l=r.length-1];1<l;)e=c(r[l-1].value,r[l-2],e),l-=2;return e},O=function(){var t,i,r;if(A(),t=M(g),p(t)||46===t)return N();if(39===t||34===t)return P();if(91===t)return j();for(r=(i=e.substr(g,l)).length;0<r;){if(n.hasOwnProperty(i)&&(!v(M(g))||g+i.length<e.length&&!m(M(g+i.length))))return g+=r,{type:"UnaryExpression",operator:i,argument:O(),prefix:!0};i=i.substr(0,--r)}return!(!v(t)&&40!==t)&&L()},N=function(){for(var e,t,i="";p(M(g));)i+=x(g++);if(46===M(g))for(i+=x(g++);p(M(g));)i+=x(g++);if("e"===(e=x(g))||"E"===e){for(i+=x(g++),"+"!==(e=x(g))&&"-"!==e||(i+=x(g++));p(M(g));)i+=x(g++);p(M(g-1))||s("Expected exponent ("+i+x(g)+")",g)}return t=M(g),v(t)?s("Variable names cannot start with a number ("+i+x(g)+")",g):46===t&&s("Unexpected period",g),{type:r,value:parseFloat(i),raw:i}},P=function(){for(var e,t="",i=x(g++),n=!1;g<w;){if((e=x(g++))===i){n=!0;break}if("\\"===e)switch(e=x(g++)){case"n":t+="\n";break;case"r":t+="\r";break;case"t":t+="\t";break;case"b":t+="\b";break;case"f":t+="\f";break;case"v":t+="\v";break;default:t+=e}else t+=e}return n||s('Unclosed quote after "'+t+'"',g),{type:r,value:t,raw:i+t+i}},S=function(){var t,i=M(g),n=g;for(v(i)?g++:s("Unexpected "+x(g),g);g<w&&(i=M(g),m(i));)g++;return t=e.slice(n,g),h.hasOwnProperty(t)?{type:r,value:h[t],raw:t}:"this"===t?{type:"ThisExpression"}:{type:"Identifier",name:t}},T=function(e){for(var i,r,n=[],a=!1,o=0;g<w;){if(A(),(i=M(g))===e){a=!0,g++,41===e&&o&&o>=n.length&&s("Unexpected token "+String.fromCharCode(e),g);break}if(44===i){if(g++,++o!==n.length)if(41===e)s("Unexpected token ,",g);else if(93===e)for(var l=n.length;l<o;l++)n.push(null)}else(r=E())&&r.type!==t||s("Expected comma",g),n.push(r)}return a||s("Expected "+String.fromCharCode(e),g),n},L=function(){var e,t;for(t=40===(e=M(g))?D():S(),A(),e=M(g);46===e||91===e||40===e;)g++,46===e?(A(),t={type:i,computed:!1,object:t,property:S()}):91===e?(t={type:i,computed:!0,object:t,property:E()},A(),93!==(e=M(g))&&s("Unclosed [",g),g++):40===e&&(t={type:"CallExpression",arguments:T(41),callee:t}),A(),e=M(g);return t},D=function(){g++;var e=E();if(A(),41===M(g))return g++,e;s("Unclosed (",g)},j=function(){return g++,{type:"ArrayExpression",elements:T(93)}},I=[];g<w;)59===(o=M(g))||44===o?g++:(f=E())?I.push(f):g<w&&s('Unexpected "'+x(g)+'"',g);return 1===I.length?I[0]:{type:t,body:I}};if(f.version="0.3.4",f.toString=function(){return"JavaScript Expression Parser (JSEP) v"+f.version},f.addUnaryOp=function(e){return l=Math.max(e.length,l),n[e]=!0,this},f.addBinaryOp=function(e,t){return u=Math.max(e.length,u),a[e]=t,this},f.addLiteral=function(e,t){return h[e]=t,this},f.removeUnaryOp=function(e){return delete n[e],e.length===l&&(l=o(n)),this},f.removeAllUnaryOps=function(){return n={},l=0,this},f.removeBinaryOp=function(e){return delete a[e],e.length===u&&(u=o(a)),this},f.removeAllBinaryOps=function(){return a={},u=0,this},f.removeLiteral=function(e){return delete h[e],this},f.removeAllLiterals=function(){return h={},this},"undefined"==typeof exports){var g=e.jsep;(e.jsep=f).noConflict=function(){return e.jsep===f&&(e.jsep=g),f}}else"undefined"!=typeof module&&module.exports?exports=module.exports=f:exports.parse=f}(this),function(){if(self.Element&&(Element.prototype.matches||(Element.prototype.matches=Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||null),Element.prototype.matches)){var e=self.Stretchy={selectors:{base:'textarea, select:not([size]), input:not([type]), input[type="'+"text number url email tel".split(" ").join('"], input[type="')+'"]',filter:"*"},script:document.currentScript||i("script").pop(),resize:function(t){if(e.resizes(t)){var i,r=getComputedStyle(t),s=0;!t.value&&t.placeholder&&(i=!0,t.value=t.placeholder);var n=t.nodeName.toLowerCase();if("textarea"==n)t.style.height="0","border-box"==r.boxSizing?s=t.offsetHeight:"content-box"==r.boxSizing&&(s=-t.clientHeight+parseFloat(r.minHeight)),t.style.height=t.scrollHeight+s+"px";else if("input"==n)if(t.style.width="1000px",t.offsetWidth){t.style.width="0","border-box"==r.boxSizing?s=t.offsetWidth:"padding-box"==r.boxSizing?s=t.clientWidth:"content-box"==r.boxSizing&&(s=parseFloat(r.minWidth));var a=Math.max(s,t.scrollWidth-t.clientWidth);t.style.width=a+"px";for(var o=0;o<10&&(t.scrollLeft=1e10,0!=t.scrollLeft);o++)a+=t.scrollLeft,t.style.width=a+"px"}else t.style.width=t.value.length+1+"ch";else if("select"==n){if(-1==t.selectedIndex)return;var l,u=0<t.selectedIndex?t.selectedIndex:0,h=document.createElement("_");for(var d in h.textContent=t.options[u].textContent,t.parentNode.insertBefore(h,t.nextSibling),r){var c=r[d];/^(width|webkitLogicalWidth|length)$/.test(d)||"string"!=typeof c||(h.style[d]=c,/appearance$/i.test(d)&&(l=d))}h.style.width="",0<h.offsetWidth&&(t.style.width=h.offsetWidth+"px",r[l]&&"none"===r[l]||(t.style.width="calc("+t.style.width+" + 2em)")),h.parentNode.removeChild(h),h=null}i&&(t.value="")}},resizeAll:function(t){i(t||e.selectors.base).forEach((function(t){e.resize(t)}))},active:!0,resizes:function(t){return t&&t.parentNode&&t.matches&&t.matches(e.selectors.base)&&t.matches(e.selectors.filter)},init:function(){e.selectors.filter=e.script.getAttribute("data-filter")||(i("[data-stretchy-filter]").pop()||document.body).getAttribute("data-stretchy-filter")||e.selectors.filter,e.resizeAll(),self.MutationObserver&&!e.observer&&(e.observer=new MutationObserver((function(t){e.active&&t.forEach((function(t){"childList"==t.type&&e.resizeAll(t.addedNodes)}))})),e.observer.observe(document.documentElement,{childList:!0,subtree:!0}))},$$:i};"loading"!==document.readyState?requestAnimationFrame(e.init):document.addEventListener("DOMContentLoaded",e.init),window.addEventListener("load",(function(){e.resizeAll()}));var t=function(t){e.active&&e.resize(t.target)};document.documentElement.addEventListener("input",t),document.documentElement.addEventListener("change",t)}function i(e,t){return e instanceof Node||e instanceof Window?[e]:[].slice.call("string"==typeof e?(t||document).querySelectorAll(e):e||[])}}(),Stretchy.selectors.filter=".mv-editor:not([property]), .mv-autosize",async function(e,t){var i,r,s;self.$=self.$||e,self.$$=self.$$||t;let n=self.Mavo=e.Class((r=i=class i{constructor(r){if(this.treeBuilt=i.promise(),this.dataLoaded=i.promise(),this.deleted=[],this.element=r,this.inProgress=!1,this.index=Object.keys(n.all).length+1,Object.defineProperty(n.all,this.index-1,{value:this,configurable:!0}),this.id=i.getAttribute(this.element,"mv-app","id")||"mavo".concat(this.index),this.id in n.all){for(var s=2;this.id+s in n.all;s++);this.id+=s}n.all[this.id]=this,this.element.setAttribute("mv-app",this.id),this.observe({attribute:"lang",deep:!1},(()=>{var e=i.getClosestAttribute(this.element,"lang")||i.locale;this.locale=i.Locale.get(e)}))(),this.autoEdit=this.element.classList.contains("mv-autoedit"),this.autoSave=this.element.hasAttribute("mv-autosave"),this.autoSaveDelay=1e3*(this.element.getAttribute("mv-autosave")||0),i.setAttributeShy(this.element,"typeof",""),i.hooks.run("init-start",this),t(n.selectors.primitive,this.element).forEach((t=>{if(e(n.selectors.property,t)){let e=i.Primitive.getConfig(t);(e.attribute||e.hasChildren)&&!t.hasAttribute("mv-list-item")||t.setAttribute("mv-group","")}})),this.expressions=new i.Expressions(this),n.observers=n.observers||new i.Observers,n.observers.observer.observe(this.element,{characterData:!0,childList:!0,subtree:!0,attributes:!0}),i.hooks.run("init-tree-before",this),this.root=new i.Group(this.element,this),this.treeBuilt.resolve(),i.hooks.run("init-tree-after",this),this.permissions=new i.Permissions;var a=["source","storage","init","uploads"];a.forEach((e=>this.updateBackend(e))),this.observe({deep:!1,attribute:!0},(({attribute:e})=>{if(0===e.indexOf("mv-")){var t,i;let r=null==e||null===(t=e.replace(/^mv-/,""))||void 0===t||null===(i=t.split("-"))||void 0===i?void 0:i[0];a.includes(r)&&(this.updateBackend(r),("source"===r||!this.source&&("storage"===r||"init"===r&&!this.root.data))&&this.load())}})),this.permissions.can("login",(()=>{let e;if(null!==i.Functions.url("login")&&1===this.index?e="login":null!==i.Functions.url(this.id+"-login")&&(e=this.id+"-login"),void 0!==e){const t=new URL(location.href);t.searchParams.delete(e),history.replaceState(null,"",t),this.primaryBackend.login()}})),e.bind(this.element,"mv-login.mavo",(e=>{e.backend!=(this.source||this.storage)||"loading"===this.inProgress||this.root.data||this.unsavedChanges||this.load()})),this.bar=new i.UI.Bar(this),this.needsEdit=this.calculateNeedsEdit(),this.setUnsavedChanges(!1),this.permissions.onchange((({action:e,value:t})=>{var i=this.element.getAttribute("mv-permissions")||"";i=i.trim().split(/\s+/).filter((t=>t!=e)),t&&i.push(e),this.element.setAttribute("mv-permissions",i.join(" "))})),this.permissions.can(["edit","add","delete"],(()=>{this.autoEdit&&this.edit()})),this.observe({attribute:"mv-mode"},(({element:e})=>{if(this.permissions.edit||this.permissions.add||this.permissions.delete){let t=n.Node.children(e);e:for(let i=0;i<t.length;i++){let r,s=t[i],a=s.mode;if(s.element==e)r=s.element.getAttribute("mv-mode"),s.modes=r;else{if(s.modes)continue e;r=n.getStyle(s.element.parentNode,"--mv-mode")}s.mode=r,a!=s.mode&&s["edit"==s.mode?"edit":"done"]()}}})),this.primaryBackend?this.permissions.can("read",(()=>this.load())):requestAnimationFrame((()=>{this.dataLoaded.resolve(),this.expressions.update(),this.element.dispatchEvent(new Event("mv-load",{bubbles:!0}))})),e.bind(this.element,"mv-load.mavo",(()=>{if(location.hash){var e=()=>{var e=document.getElementById(location.hash.slice(1));return(e||!location.hash)&&this.element.contains(e)&&requestAnimationFrame((()=>{i.scrollIntoViewIfNeeded(e)})),e};e()||this.observe({attribute:"id",once:!0},e)}requestAnimationFrame((()=>Stretchy.resizeAll()))})),this.dataLoaded.then((async()=>{await i.defer(),this.permissions.can("save",(()=>{if(this.autoSave){let t=n.debounce((()=>{this.save()}),this.autoSaveDelay);e.bind(this.element,"mv-change.mavo:autosave",(e=>{e.node.saved&&this.autoSave&&t()}))}}),(()=>{e.unbind(this.element,"mv-change.mavo:autosave")}))})),this.element.addEventListener("keydown",(e=>{var t=e.target;if(this.permissions.save&&"S"==e.key&&e[n.superKey]&&!e.altKey)e.preventDefault(),this.save();else if("ArrowUp"===e.key||"ArrowDown"===e.key){if(t.matches("textarea, input[type=range], input[type=number]"))return;if(t.matches(".mv-editor")){var r=!0;t=t.parentNode}var s=i.Node.get(t);if(null!=s&&s.closestCollection){var a=s.getCousin("ArrowUp"===e.key?-1:1,{wrap:!0});a&&(r&&a.editing?(a.edit(),a.editor.focus()):a.element.focus(),e.preventDefault())}}})),e.bind(this.element,"click submit",n.Actions.listener),i.hooks.run("init-end",this)}get editing(){return this.root.editing}observe(e={},t){var i;let r=Object.assign({element:this.element},e);return null===(i=n.observers)||void 0===i?void 0:i.observe(r,t)}unobserve(e,t){var i;let r=Object.assign({element:this.element},e);return null===(i=n.observers)||void 0===i?void 0:i.unobserve(r,t)}getData(e){let t={context:this,options:e};return t.data=this.root.getData(e),n.hooks.run("getdata-end",t),t.data}toJSON(){return n.toJSON(this.getData())}message(e,t={}){return new n.UI.Message(this,e,t)}error(e,...t){this.message(e,{type:"error",dismiss:["button","timeout"]}),t.length}render(e){var t={context:this,data:e};n.hooks.run("render-start",t),t.data&&this.root.render(t.data),this.unsavedChanges=!1,n.hooks.run("render-end",t)}edit(){var t;null!==(t=this.bar)&&void 0!==t&&t.edit&&this.bar.edit.click(),this.root.edit(),e.bind(this.element,"mouseenter.mavo:edit mouseleave.mavo:edit",(e=>{if(e.target.matches(n.selectors.multiple)){e.target.classList.remove("mv-has-hovered-item");var t=e.target.parentNode.closest(n.selectors.multiple);t&&t.classList.toggle("mv-has-hovered-item","mouseenter"==e.type)}}),!0),this.setUnsavedChanges()}done(){this.root.done(),e.unbind(this.element,".mavo:edit"),this.unsavedChanges=!1}setUnsavedChanges(e){var t=!!e;return e||this.walk((i=>{if(i.unsavedChanges)return t=!0,!1===e&&(i.unsavedChanges=!1),!1})),this.unsavedChanges=t}updateBackend(t){let r,s,a=this[t],o={};if(1==this.index&&(r=n.Functions.url(t)),r||(r=n.Functions.url("".concat(this.id,"-").concat(t))),!r){const e="mv-"+t;if(r=this.element.getAttribute(e)||null,r)if(r=r.trim(),"none"==r)r=null;else{let t=e+"-",r=i.getAttributes(this.element,RegExp("^"+t));o=Object.fromEntries(r.map((e=>[e.replace(t,""),this.element.getAttribute(e)])))}}var l;r?null!=a&&null!==(l=a.equals)&&void 0!==l&&l.call(a,r)||(this[t]=r=n.Backend.create(r,{format:this.element.getAttribute("mv-format"),...o,mavo:this},a),s=!0,e.bind(r,"mv-login mv-logout",(t=>{e.fire(this.element,t.type,{backend:r})}))):this[t]=null;if(s=s||(r?!r.equals(a):!!a),s){var u,h;this.storage||this.source||!this.init||(this.source=this.init,this.init=null);var d=this.storage?this.storage.permissions:new i.Permissions({edit:!0,save:!1});d.parent=null===(u=this.source)||void 0===u?void 0:u.permissions,this.permissions.parent=d,this.primaryBackend=this.storage||this.source,this.sourceBackend=this.source||this.storage||this.init;let e=t=>{t.target===this.sourceBackend?this.push(t.data):t.target.removeEventListener("mv-remotedatachange",e)};null===(h=this.sourceBackend)||void 0===h||h.addEventListener("mv-remotedatachange",e)}return s}async push(e,{conflictPolicy:t="stop"}={}){if(this.unsavedChanges)if("ask"===t){if(!confirm(this._("remote-data-conflict")))return}else if("stop"===t)return;return this.load({data:e})}async load({backend:e,data:t}={}){var r;let s=e;if((e=null!==(r=e)&&void 0!==r?r:this.sourceBackend)||t){let r=this.autoSave;if(this.autoSave=!1,void 0===t){this.inProgress="loading",await e.ready,t=null;try{t=await e.load()}catch(i){if(!s&&this.init&&this.init!==e){await this.init.ready;try{t=await this.init.load(),e=this.init}catch(e){}}if(i&&null===t){let e=i instanceof Response||i instanceof XMLHttpRequest?i:i.xhr;if(404!==(null==e?void 0:e.status)){let t=this._("problem-loading");e&&(t+=e.status?this._("http-error",i):": "+this._("cant-connect")),this.error(t,i)}}}this.inProgress=!1}this.render(t),await i.defer(),this.dataLoaded.resolve(),this.element.dispatchEvent(new CustomEvent("mv-load",{detail:e,bubbles:!0})),this.autoSave=r}}async store(){if(!this.storage)return;let e;this.inProgress="saving";try{e=await this.storage.store(this.getData())}catch(i){if(i){var t=this._("problem-saving");i instanceof XMLHttpRequest&&(t+=": "+(i.status?this._("http-error",i):this._("cant-connect"))),this.error(t,i)}e=null}return this.inProgress=!1,e}upload(e,t="images/"+e.name){return this.uploadBackend?(this.inProgress="uploading",this.uploadBackend.upload(e,t).then((e=>(this.inProgress=!1,e))).catch((e=>(this.error(this._("error-uploading"),e),this.inProgress=!1,null)))):Promise.reject()}async save(){n.hooks.run("save-start",this);let t=await this.store();t&&(e.fire(this.element,"mv-save",t),this.lastSaved=Date.now(),this.root.save(),this.unsavedChanges=!1)}walk(){return this.root.walk(...arguments)}calculateNeedsEdit(){var e=!1;return this.walk((t=>!e&&(e=!(t.modes||t instanceof i.Group),!t.modes)),void 0,{descentReturn:!0}),e}changed(e){!this.root||this.expressions.active&&this.expressions.updateThrottled(e)}setDeleted(...e){var t;if(this.deleted.forEach((e=>e.destroy())),this.deleted.length=0,null===(t=this.deletionNotice)||void 0===t||t.close(),e.length){if(this.deleted.push(...e),1==e.length)var i=e[0].name;else{var r={},s=[];for(var n in e.forEach((e=>{r[e.name]=(r[e.name]||0)+1})),r)s.push(this._("n-items",{name:n,n:r[n]}));i=s.join(", ")}var a=this.deletionNotice=this.message([this._("item-deleted",{name:i}),{tag:"button",type:"button",textContent:this._("undo"),events:{click:()=>{this.undoDelete(),this.deletionNotice.close(!0)}}}],{classes:"mv-deleted",dismiss:{button:!0,timeout:2e4}});a.closed.then((e=>{!e&&this.deleted.length&&(this.deleted.forEach((e=>e.destroy())),this.deleted.length=0),this.deletionNotice==a&&(this.deletionNotice=null)}))}}undoDelete(){this.deleted.forEach((e=>e.collection.add(e,e.index))),this.deleted.length=0}destroy(){var e;i.hooks.run("mavo-destroy-start",this),this.editing&&this.done(),this.observer.destroy(),null===(e=this.bar)||void 0===e||e.destroy(),i.all[this.id]=i.all[this.index-1]=null,this.root.destroy(),i.hooks.run("mavo-destroy-end",this)}static get(e){if(e instanceof Element){for(let t in n.all)if(n.all[t].element==e)return n.all[t];return null}let t="number"==typeof e?Object.keys(n.all)[e]:e;return n.all[t]||null}static init(e=document){return(Array.isArray(arguments[0])?arguments[0]:t(n.selectors.init,e)).filter((e=>!n.get(e))).map((e=>new n(e)))}static observe(e,t){return n.observers=n.observers||new i.Observers,n.observers.observe(e,t)}static unobserve(e,t){n.observers.unobserve(e,t)}static warn(e,t={}){n.warn.history=n.warn.history||new Set,n.warn.history.has(e),!1!==t.once&&n.warn.history.add(e)}static thenAll(i){return t(i).forEach((t=>{"promise"==e.type(t)&&(t=t.catch((e=>e)))})),Promise.all(i).then((e=>i.length==e.length?e:n.thenAll(i)))}static promise(e){let t,i,r=new Promise(((r,s)=>{"function"==typeof e?e(r,s):e instanceof Promise&&(e.then(r),e.catch(s)),t=r,i=s}));return r.resolve=e=>(t(e),r),r.reject=e=>(i(e),r),r}},_defineProperty(i,"version","v0.3.0"),_defineProperty(i,"all",{}),_defineProperty(i,"superKey",0===navigator.platform.indexOf("Mac")?"metaKey":"ctrlKey"),_defineProperty(i,"base",["blob:","about:"].includes(location.protocol)?(null===(s=document.currentScript)||void 0===s?void 0:s.src)||"https://mavo.io":location),_defineProperty(i,"dependencies",[e.ready().then((()=>n.Plugins.load()))]),_defineProperty(i,"polyfillsNeeded",{blissfuljs:Array.from&&document.documentElement.closest&&self.URL&&"searchParams"in URL.prototype,"Intl.~locale.en":self.Intl,IntersectionObserver:self.IntersectionObserver,Symbol:self.Symbol,"Element.prototype.remove":Element.prototype.remove,"Element.prototype.before":Element.prototype.before,"Element.prototype.after":Element.prototype.after,"Element.prototype.prepend":Element.prototype.prepend,"Array.prototype.flat":Array.prototype.flat,"Array.prototype.flatMap":Array.prototype.flatMap}),_defineProperty(i,"polyfills",[]),_defineProperty(i,"defer",(e=>new Promise((t=>void 0===e?requestAnimationFrame(t):setTimeout(t,e))))),_defineProperty(i,"UI",{}),_defineProperty(i,"hooks",new e.Hooks),_defineProperty(i,"properties",new Set),_defineProperty(i,"attributes",["mv-app","mv-storage","mv-source","mv-init","mv-path","mv-format","mv-attribute","mv-default","mv-mode","mv-edit","mv-editor","mv-permisssions","mv-rel","mv-value"]),r),{live:{inProgress(t){e.toggleAttribute(this.element,"mv-progress",t,t),e.toggleAttribute(this.element,"aria-busy",!!t,!!t),this.element.style.setProperty("--mv-progress-text",t?'"'.concat(this._(t),'"'):"")},unsavedChanges(e){this.element.classList.toggle("mv-unsaved-changes",e)},needsEdit(e){this.bar&&this.bar.toggle("edit",e&&this.permissions.edit)},storage(e){if(e!==this._storage&&!e){let e=new Mavo.Permissions({edit:!0,save:!1});e.parent=this.permissions.parent,this.permissions.parent=e}},primaryBackend(e){if((e=e||null)!=this._primaryBackend)return e},uploadBackend:{get(){var e;const t=this.uploads;return null!=t&&t.upload?(t.permissions.login&&t.login(),this.uploads):null!==(e=this.storage)&&void 0!==e&&e.upload?this.storage:void 0}}},lazy:{locale:()=>document.documentElement.lang||"en-GB"}});["toNode","isProxy","route","parent","property","mavo","groupedBy","as"].forEach((t=>{e.lazy(n,t,(()=>Symbol(t)))})),Object.defineProperty(n.all,"length",{get:function(){return Object.keys(this).length}});{let e=n.selectors={init:"[mv-app], [data-mv-app]",property:"[property]",group:"[typeof], [mv-group]",list:"[mv-list]",multiple:"[mv-list-item]",formControl:"input, select, option, textarea",textInput:["text","email","url","tel","search","number"].map((e=>"input[type=".concat(e,"]"))).join(", ")+", input:not([type]), textarea",ui:".mv-ui"};e.primitive=e.property+":not(".concat(e.group,", ").concat(e.list,")"),e.childGroup=e.property+":is(".concat(e.group,")"),e.scope=":is(".concat(e.group,", ").concat(e.multiple,", ").concat(e.list,")"),e.item=e.multiple+", "+e.group,e.output="[property=output], .mv-output"}if(e.each(n.polyfillsNeeded,((e,t)=>{t||n.polyfills.push(e)})),n.ready=n.thenAll(n.dependencies),n.inited=n.promise(),await n.defer(),0<n.polyfills.length){var a="https://cdn.polyfill.io/v2/polyfill.min.js?unknown=polyfill&features="+n.polyfills.map((e=>e+"|gated")).join(",");n.dependencies.push(e.include(a))}if(await e.ready(),Mavo.attributeStartsWith("data-mv-").forEach((e=>{let t=e.ownerElement,i=e.name.replace("data-","");Mavo.setAttributeShy(t,i,e.value)})),t("[mv-list]:not([property])").forEach((e=>e.setAttribute("property",e.getAttribute("mv-list")))),t("[mv-list-item]:not([property])").forEach((e=>e.setAttribute("property",e.getAttribute("mv-list-item")))),n.containers={TR:"TBODY",OPTION:"OPTGROUP"},t("[mv-list]").forEach((t=>{if(!e(":scope > [mv-list-item]",t))if(1!==t.children.length||t.children[0].matches("[property]")){let i=Object.entries(n.containers).filter((([e,i])=>i===t.tagName))[0]||"div";e.create(i,{className:"mv-container","mv-list-item":"",contents:[...t.childNodes],inside:t})}else t.children[0].setAttribute("mv-list-item","")})),t("[mv-list-item], [mv-multiple]").forEach((t=>{let i;if(!t.hasAttribute("mv-list-item")){let e=t.getAttribute("mv-multiple");if(t.setAttribute("mv-list-item",e),!t.hasAttribute("property"))if(e)t.setAttribute("property",e);else{let e=n.Node.getImplicitPropertyName(t)||n.Node.generatePropertyName("collection",t);t.setAttribute("property",e)}i=!0,Mavo.warn("@mv-multiple is deprecated. Please use @mv-list-item and @mv-list instead")}t.hasAttribute("property")||t.setAttribute("property",t.getAttribute("mv-list-item"));let r=t.parentNode,s=r,a=Mavo.Node.getProperty(t);if(!r.hasAttribute("mv-list")){if(1!==r.children.length||r.matches("[mv-app], [property], [mv-list-item]")){let i=n.containers[t.tagName]||"div";s=e.create(i,{className:"mv-container",around:t})}s.setAttribute("mv-list",""),a&&s.setAttribute("property",a),Mavo.moveAttribute("mv-initial-items",t,s),Mavo.moveAttribute("mv-order",t,s),Mavo.moveAttribute("mv-accepts",t,s),Mavo.moveAttribute("mv-alias",t,s),i?(Mavo.moveAttribute("mv-value",t,s),Mavo.moveAttribute("mv-mode",t,s),Mavo.moveAttribute("mv-multiple-path",t,s,{rename:"mv-path"})):Mavo.warn("Please wrap @mv-list-item elements with @mv-list elements")}let o=s.getAttribute("property"),l=t.getAttribute("property");if(!o&&l)s.setAttribute("property",l);else if(o!==l||!o){let e=Mavo.Node.getProperty(s)||Mavo.Node.generatePropertyName("item",s);o||s.setAttribute("property",e),t.setAttribute("property",e)}})),t("[property='']").forEach((e=>{let t=Mavo.Node.getProperty(e)||Mavo.Node.generatePropertyName("prop",e);e.setAttribute("property",t)})),t(n.selectors.init).forEach((function(e){n.get(e)||e.setAttribute("mv-progress","Loading")})),window.CSSPropertyRule){document.documentElement.classList.add("mv-supports-atproperty")}await n.ready,n.init(),n.inited.resolve()}(Bliss,Bliss.$),function(e,t){function i(){var e=r.getTarget();const i="mv-target-within";for(t(".mv-target-within").forEach((e=>e.classList.remove(i)));null!==(s=e)&&void 0!==s&&s.classList;){var s;e.classList.add(i),e=e.parentNode}}var r=e.extend(Mavo,{load:(t,i=(()=>{var e,t;return null!==(e=null===(t=document.currentScript)||void 0===t?void 0:t.src)&&void 0!==e?e:location})())=>e.load(t,i),readFile:(e,t="DataURL")=>{var i=new FileReader;return new Promise(((r,s)=>{i.onload=()=>r(i.result),i.onerror=i.onabort=s,i["readAs"+t](e)}))},toJSON:e=>{if(null===e)return"";if("string"==typeof e)return e;try{return JSON.stringify(e,null,"\t")}catch(e){return e}},safeToJSON:function(e){var t=new WeakSet;return JSON.stringify(e,((e,i)=>{if("object"==typeof i&&null!==i){if(t.has(i))return;t.add(i)}return i}))},isPlainObject:t=>{var i;return"object"===e.type(t)&&"Object"===(null===(i=Object.getPrototypeOf(t).constructor)||void 0===i?void 0:i.name)},primitivify:(e,t)=>(e&&(t&&"object"==typeof t&&(Object.assign(e,t),t=Mavo.value(t)),e.valueOf=e.toJSON=e[Symbol.toPrimitive]=()=>t),e),objectify:(t,i)=>{var s=Mavo.value(t);if("object"!=typeof t||null===t){if(null===t)t={[Symbol.toStringTag]:"Null",toJSON:()=>null};else{var n=t.constructor;(t=new n(s))[Symbol.toStringTag]=n.name}r.primitivify(t,s)}return e.extend(t,i)},value:e=>null!=e&&e.valueOf?e.valueOf():e,toArray:e=>void 0===e?[]:Array.isArray(e)?e:[e],union:(e,t)=>e instanceof Set&&t?(t.forEach((t=>e.add(t))),e):new Set([...e||[],...t||[]]),getStyle:(e,t)=>{if(e&&e instanceof Element){let i=getComputedStyle(e).getPropertyValue(t);return null==i?void 0:i.trim()}},data:function(e,t,i){if(!e)return null;var s,n=r.elementData.get(e)||{};return 2==arguments.length?s=n[t]:void 0===i?delete n[t]:s=n[t]=i,r.elementData.set(e,n),s},elementData:new WeakMap,elementPath:function(e,t){if(Array.isArray(t)){var i=(a=t).reduce(((e,t)=>e.children[t>>0]||e),e),r=a[a.length-1];if(r!=r>>0){var s=+(r+"").split(".")[1];0>r>>0&&(i=i.firstChild,s--);for(var n=0;n<s;n++)i=i.nextSibling}return i}for(var a=[],o=t;o&&o!=e;o=o.parentNode){for(var l=0,u=o===t&&1!==t.nodeType,h=(s=u?1:0,o);h=h["previous".concat(u?"":"Element","Sibling")];)u?(s++,1==h.nodeType&&(u=!1)):l++;0<s&&(l=l-1+"."+s),a.unshift(l)}return o?a:null},revocably:{add:function(e,t){var i=r.revocably.isRemoved(e);return null!=i&&i.parentNode?i.parentNode.replaceChild(e,i):e&&t&&!e.parentNode&&("function"==typeof t?t(e):t.appendChild(e)),i},remove:function(e,t){if(e){var i=r.data(e,"commentstub");return i||(t=t||e.id||e.className||e.nodeName,i=r.data(e,"commentstub",document.createComment(t))),e.parentNode&&e.parentNode.replaceChild(i,e),i}},isRemoved:function(e){if(!e||e.parentNode)return!1;var t=r.data(e,"commentstub");return!(null==t||!t.parentNode)&&t},setAttribute:function(e,t,i){void 0===r.data(e,"attribute-"+t)&&r.data(e,"attribute-"+t,e.getAttribute(t)),e.setAttribute(t,i)},restoreAttribute:function(t,i){var s=r.data(t,"attribute-"+i);void 0!==s&&(e.toggleAttribute(t,i,s),r.data(t,"attribute-"+i,void 0))}},inView:{is:e=>{var t=e.getBoundingClientRect();return(0<=t.bottom&&t.bottom<=innerHeight||0<=t.top&&t.top<=innerHeight)&&(0<=t.right&&t.right<=innerWidth||0<=t.left&&t.left<=innerWidth)},when:(t,i="".concat(innerHeight/2,"px ").concat(innerWidth/2,"px"))=>{var s=r.inView.observer=r.inView.observer||new IntersectionObserver((function(t,i){t.forEach((t=>{0<t.intersectionRatio&&(i.unobserve(t.target),e.fire(t.target,"mv-inview",{entry:t}))}))}),{rootMargin:i});return new Promise((e=>{r.inView.is(t)&&e(),s.observe(t);var i=r=>{t.removeEventListener("mv-inview",i),r.stopPropagation(),e()};t.addEventListener("mv-inview",i)}))}},scrollIntoViewIfNeeded:e=>{e&&!Mavo.inView.is(e)&&e.scrollIntoView({behavior:"smooth"})},setAttributeShy:function(e,t,i){e.hasAttribute(t)||e.setAttribute(t,i)},getAttribute:function(e,...t){for(let i,r=0;i=t[r];r++){let t=e.getAttribute(i);if(t)return t}return null},getClosestAttribute:function(e,t){var i,r;return null!==(i=null===(r=e.closest("[".concat(t,"]")))||void 0===r?void 0:r.getAttribute(t))&&void 0!==i?i:null},moveAttribute(e,t,i,r={}){let s=t.getAttribute(e);if(null!==s){let n=r.rename||e;i.setAttribute(n,s),t.removeAttribute(e)}},getTarget:function(){var e=location.hash.substr(1);return document.getElementById(e)},XPath:function(e,t=document){var i,r=t.ownerDocument||t,s=[];if(r.evaluate)for(var n=r.evaluate(e,t,null,XPathResult.ANY_TYPE,null);i=n.iterateNext();)s.push(i);return s},attributeStartsWith:function(e,t=document.documentElement){return r.XPath('.//@*[starts-with(name(), "'.concat(e,'")]'),t)},getAttributes:function(e,t){return e.getAttributeNames().filter((e=>t.test(e)))},properlyCasedAttributesCache:{},getProperAttributeCase(e,t){var i,s;const n=e.closest("svg, math, :root").tagName;null!==(s=(i=r.properlyCasedAttributesCache)[n])&&void 0!==s||(i[n]={});let a=r.properlyCasedAttributesCache[n][t];if(a)return a;const o=e.tagName;return a=(new DOMParser).parseFromString("<".concat(n,"><").concat(o," ").concat(t,'=""></').concat(o,"></").concat(n,">"),"text/html").body.firstElementChild.firstElementChild.attributes[0].name,r.properlyCasedAttributesCache[n][t]=a,a},usePropertyInsteadOfAttribute:function(e,t){return!(-1<["href","src"].indexOf(t)||t.startsWith("on")||"http://www.w3.org/2000/svg"==e.namespaceURI)},in:function(e,t){if(t)return"object"==typeof t&&e in t||void 0!==t[e]},getCanonicalProperty:function(e,t){if(e&&(t||0===t)){if(r.in(t,e))return t;if(t.toLowerCase){var i=t.toLowerCase();if(r.in(i,e))return i;var s=Object.keys(e),n=s.map((e=>e.toLowerCase())).indexOf(i);if(-1<n)return s[n]}}},subset:function(t,i,r){if(3==arguments.length){if(i.length){var s=i[i.length-1],n=e.value(t,...i.slice(0,-1));return Array.isArray(n)&&Array.isArray(r)?n.splice(s,1,...r):n&&(n[i[i.length-1]]=r),t}return r}return"object"==typeof t&&null!=i&&i.length?i.reduce(((e,t,r)=>{var s;let n,a=null!=t&&null!==(s=t.startsWith)&&void 0!==s&&s.call(t,"id=")?t.substring(3):null;if(null!==a){let t=e.findIndex((e=>Mavo.Functions.get(e,"id")==a));n=-1<t?e[t]:{id:a},i[r]=-1<t?t:e.length}else n=Mavo.Functions.get(e,t),i[r]=t;return n}),t):t},clone:function(e){return e&&"object"==typeof e?JSON.parse(r.safeToJSON(e)):e},shallowClone:function(t){return t&&"object"==typeof t?Array.isArray(t)?[...t]:e.extend({},t):t},debounce:function(e,t){if(!t)return e;var i,r=null;return function(){var s=this,n=arguments;i=function(){e.apply(s,n),removeEventListener("beforeunload",i)},clearTimeout(r),r=setTimeout(i,t),addEventListener("beforeunload",i)}},escapeRegExp:e=>e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),observeResize:function(e,t){if(self.ResizeObserver){var i=null,r=t instanceof ResizeObserver?t:new ResizeObserver((e=>{var r=e[e.length-1].contentRect;i&&i.width==r.width&&i.height==r.height||(t(e),i=r)}));return r.observe(e),r}},Observer:class{constructor(e,t,i,r={}){i instanceof MutationObserver&&(this.observer=i),this.observer=this.observer||new MutationObserver(i),this.callback=i,this.update(e,t,r),this.run()}update(t,i,r){var s;this.element=t,this.attribute=i,this.options=e.extend({},r),void 0!==r&&(r.attributes||r.childList||r.characterData)||(this.attribute&&Object.assign(this.options,{attributes:!0,attributeFilter:"all"==this.attribute?void 0:Mavo.toArray(this.attribute),attributeOldValue:!!r.oldValue}),(!this.attribute||"all"==this.attribute)&&Object.assign(this.options,{characterData:!0,childList:!0,subtree:!0,characterDataOldValue:!!r.oldValue})),null!==(s=this.observer)&&void 0!==s&&s.running&&(this.stop(),this.run())}flush(){var e;let t=null===(e=this.observer)||void 0===e?void 0:e.takeRecords();t&&this.callback(t)}stop(){var e;return null===(e=this.observer)||void 0===e||e.disconnect(),this.running=!1,this}run(){return this.observer&&(this.observer.observe(this.element,this.options),this.running=!0),this}pause(){this.runOnResume=this.running,this.stop()}resume(){!1!==this.runOnResume&&this.run(),delete this.runOnResume}destroy(){this.stop(),this.observer=this.element=null}},rr:function(e){return e(),e},wrap:(e,t)=>0>e?t-1:e>=t?0:e,options:(e,{map:t}={})=>{var i,r=t?new Map:{};return null===(i=e.trim().match(/(?:\\[,;]|[^,;])+/g))||void 0===i||i.forEach((e=>{if(e){var i=(e=e.trim().replace(/\\([,;])/g,"$1")).match(/^\s*((?:\\:|[^:])*?)\s*:\s*(.+)$/);let s,n;i?(s=i[1].replace(/\\:/g,":"),n="false"!==i[2]&&i[2]):(s=e,n=!0),t?r.set(s,n):r[s]=n}})),r},BucketMap:class{constructor({arrays:e=!1}={}){this.map=new Map,this[Symbol.iterator]=this.map[Symbol.iterator],this.arrays=e}set(e,t){var i;this.arrays?(i=this.map.get(e)||[]).push(t):(i=this.map.get(e)||new Set).add(t);this.map.set(e,i)}delete(e,t){if(2==arguments.length){var i=this.map.get(e);if(i)if(this.arrays){let e=i.indexOf(t);-1<e&&i.splice(e,1)}else i.delete(t)}else this.map.delete(e)}forEach(...e){return this.map.forEach(...e)}}});r.Observers=class extends Map{constructor({observer:e,callback:t}={}){super();let i=r.Observers;this.callback=t||i.callback,this.observer=e||(i.observer=i.observer||new MutationObserver(this.callback))}applyRecord(e){for(let[t,i]of this.entries())if(r.Observers.matchesRecord(t,e)){let r=Mavo.Node.get(e.target,!0);i.call(this,{node:r,element:e.target,type:e.type,attribute:e.attributeName,record:e}),t.once&&this.unobserve(t,i)}}static matchesRecord(e,t){var i;if(!1===e.active)return!1;let r=t.target;if(e.selector&&(null===(i=r.matches)||void 0===i||!i.call(r,e.selector)))return!1;if(e.attribute){var s,n;if("attributes"!==t.type)return!1;if(!0!==e.attribute&&e.attribute!==t.attributeName&&(null===(s=(n=e.attribute).includes)||void 0===s||!s.call(n,t.attributeName)))return!1}else if("attributes"===t.type&&!1===e.attribute)return!1;return!e.element||(!1===e.deep?r===e.element:e.element.contains(r))}flush(){let e=this.observer.takeRecords();e&&this.callback(e)}observe(e={},t){return this.set(e,t),t}unobserve(e,t){let i=this.find(e,t);for(let[e,t]of i.entries())this.delete(e)}pause(e){let t=this.find(e);for(let[e,i]of t.entries())e._active=!1!==e.active&&!1!==e._active,e.active=!1;return this.flush(),t}resume(e){e instanceof r.Observers||(e=this.find(e)),this.flush();for(let[t,i]of e.entries())t.active=t.active||t._active,delete t._active}find(e={},t){let i=Object.keys(e),r=new Mavo.Observers;for(let[s,n]of this.entries())t&&t!==n||i.every((t=>s[t]===e[t]))&&r.set(s,n);return r}},r.Observers.callback=e=>{if(0!==this.size)for(let t of e)r.observers.applyRecord(t)},e.proxy=e.classProps.proxy=e.overload((function(e,t,i){return Object.defineProperty(e,t,{get:function(){return this[i][t]},set:function(e){this[i][t]=e},configurable:!0,enumerable:!0}),e})),document.addEventListener("mv-load",i),addEventListener("hashchange",i),Mavo.observe({attribute:"id"},i)}(Bliss,Bliss.$),function(e,t){var i=Mavo.Locale=e.Class({constructor:function(e,t){this.lang=e,this.phrases={},this.extend(t)},get fallback(){return i.all[this.baseLang]?i.all[this.baseLang]:this===i.default?void 0:i.default},extend:function(t){e.extend(this.phrases,t)},phrase:function(e,t){var i=e.toLowerCase(),r=this.phrases[i];if(void 0===r&&this.fallback&&(r=this.fallback.phrase(i)),void 0===r)r=i.replace(/\b-\b/g," ");else if(t){var s,n,a=null!==(s=null===(n=r.match(/\{\w+(?=\})/g))||void 0===n?void 0:n.map((e=>e.slice(1))))&&void 0!==s?s:[];Mavo.Functions.unique(a).forEach((e=>{e in t&&(r=r.replace(RegExp("{".concat(e,"}"),"gi"),t[e]))}))}return r},live:{lang:function(e){this.baseLang=i.getBaseLang(e),e==this.baseLang&&(this.baseLang=null)}},static:{all:{},register:function(e,t){i.all[e]?i.all[e].extend(t):i.all[e]=new i(e,t)},match:function(e=""){return i.all[e]||i.all[i.getBaseLang(e)]},get:function(e){return i.match(e)||i.default},getBaseLang:function(e){return e.split("-")[0]},lazy:{default:()=>i.match(Mavo.locale)||i.all.en}}});Mavo.prototype._=function(e,t){return this.locale&&e?this.locale.phrase(e,t):e},Mavo.ready.then((()=>{t("datalist.mv-phrases[lang]").forEach((e=>{var i=t("option",e).reduce(((e,t)=>(e[t.value]=t.textContent.trim(),e)),{});Mavo.Locale.register(e.lang,i)}))}))}(Bliss,Bliss.$),Mavo.Locale.register("en",{second:"second",seconds:"seconds",minute:"minute",minutes:"minutes",hour:"hour",hours:"hours",day:"day",days:"days",week:"week",weeks:"weeks",month:"month",months:"months",year:"year",years:"years",edit:"Edit",editing:"Editing",save:"Save",import:"Import",export:"Export",logout:"Logout",login:"Login",loading:"Loading",uploading:"Uploading",saving:"Saving",dismiss:"Dismiss","logged-in-as":"Logged in to {id} as ","login-to":"Login to {id}","error-uploading":"Error uploading file","cannot-load-uploaded-file":"Cannot load uploaded file",filename:"Filename?","problem-saving":"Problem saving data","problem-loading":"Problem loading data","cannot-parse":"Cant understand this file","http-error":"HTTP error {status}: {statusText}","cant-connect":"Cant connect to the Internet","add-item":"Add {name}","add-item-before":"Add new {name} before","add-item-after":"Add new {name} after","drag-to-reorder":"Drag to reorder {name}","delete-item":"Delete this {name}","item-deleted":"{name} deleted","n-items":"{n} {name} items",undo:"Undo","gh-updated-file":"Updated {name}","gh-login-fork-options":"You have your own copy of this page, would you like to use it?","gh-use-my-fork":"Yes, show me my data.","remote-data-conflict":"There is new data but you have unsaved changes. Loading it will overwrite your changes. Load new data?"}),function(e,t){Mavo.attributes.push("mv-plugins");let i=Mavo.Plugins={loaded:{},async load(){i.plugins=new Set;let r={};if(t("[mv-plugins]").forEach((e=>{e.getAttribute("mv-plugins").trim().split(/\s+/).forEach((e=>{let[t,s]=e.split("@");i.plugins.add(t),r[t]=s}))})),i.plugins.size){let t=await fetch(i.url+"/plugins.json"),s=(await t.json()).plugin;return Mavo.thenAll(s.filter((e=>i.plugins.has(e.id))).map((async t=>{if(i.loaded[t.id])return Promise.resolve();let s,n="mavo-".concat(t.id,".js");if(t.repo){let a=r[t.id]||"latest";s="https://cdn.jsdelivr.net/gh/".concat(t.repo,"@").concat(a,"/").concat(n);try{return await e.include(i.loaded[t.id],s)}catch(e){s="https://cdn.jsdelivr.net/gh/".concat(t.repo,"/").concat(n)}}else s="".concat(i.url,"/").concat(t.id,"/").concat(n);return e.include(i.loaded[t.id],s)})))}},register:function(t,r={}){if(!i.loaded[t]){for(let t in Mavo.hooks.add(r.hooks),r.extend){let i="Mavo"==t?Mavo:Mavo[t];"function"===e.type(i)?e.Class(i,r.extend[t]):e.extend(i,r.extend[t])}let s=[];if(r.ready&&s.push(r.ready),r.dependencies){let e=document.currentScript?document.currentScript.src:location,t=r.dependencies.map((t=>Mavo.load(t,e)));s.push(...t)}s.length&&Mavo.dependencies.push(...s),i.loaded[t]=r,r.init&&Promise.all(s).then((()=>r.init()))}},url:"https://plugins.mavo.io"}}(Bliss,Bliss.$),function(e,t){var i=Math.max,r=Math.min;Mavo.attributes.push("mv-bar");let s=Mavo.UI.Bar=class{constructor(t){if(this.mavo=t,this.element=e(".mv-bar",this.mavo.element),this.template=this.mavo.element.getAttribute("mv-bar")||"",Mavo.observers.pause(),this.element)for(let t in this.custom=!0,this.template+=" "+(this.element.getAttribute("mv-bar")||""),this.template=this.template.trim(),s.controls)this[t]=e(".mv-".concat(t),this.element),this[t]&&(this.template=this.template||"with",this.template+=" ".concat(t));else this.element=e.create({className:"mv-bar mv-ui",start:"HTML"===this.mavo.element.tagName?document.body:this.mavo.element,innerHTML:"<button>&nbsp;</button>"});this.element.classList.contains("mv-compact")&&(this.noResize=!0),this.controls=s.getControls(this.template),this.controls.length&&(this.targetHeight=this.element.offsetHeight),this.custom||(this.element.innerHTML="");for(let t of this.controls){let i=s.controls[t];for(let r in this[t]&&this[t].remove(),i.create?this[t]=i.create.call(this.mavo,this[t]):!this[t]&&(this[t]=e.create("button",{type:"button",className:"mv-".concat(t),textContent:this.mavo._(t)})),this.add(t),i.permission?this.permissions.can(i.permission,(()=>{this.toggle(t,!i.condition||i.condition.call(this.mavo))}),(()=>{this.remove(t)})):i.condition&&!i.condition.call(this.mavo)&&this.remove(t),i.events)e.bind(this[t],r,i.events[r].bind(this.mavo))}for(let t in s.controls){let i=s.controls[t];i.action&&e.delegate(this.mavo.element,"click",".mv-"+t,(e=>{(!i.permission||this.permissions.is(i.permission))&&(i.action.call(this.mavo),e.preventDefault())}))}this.controls.length&&!this.noResize&&(this.resize(),self.ResizeObserver&&(this.resizeObserver=Mavo.observeResize(this.element,(()=>{this.resize()})))),Mavo.observers.resume()}resize(){var e,i;return this.targetHeight?(null===(e=this.resizeObserver)||void 0===e||e.disconnect(),this.element.classList.remove("mv-compact","mv-tiny"),t("button, .mv-button",this.element).forEach((e=>{e.title===e.textContent&&(e.title="")})),this.element.offsetHeight>1.6*this.targetHeight&&(this.element.classList.add("mv-compact"),this.element.offsetHeight>1.2*this.targetHeight&&(this.element.classList.add("mv-tiny"),t("button, .mv-button",this.element).forEach((e=>{e.title||(e.title=e.textContent)})))),void(null===(i=this.resizeObserver)||void 0===i||i.observe(this.element))):void(this.targetHeight=this.element.offsetHeight)}add(e){let t=s.controls[e];t.prepare&&t.prepare.call(this.mavo),Mavo.revocably.add(this[e],this.element),this.resizeObserver||this.noResize||requestAnimationFrame((()=>this.resize()))}remove(e){let t=s.controls[e];Mavo.revocably.remove(this[e],"mv-"+e),t.cleanup&&t.cleanup.call(this.mavo),this.resizeObserver||this.noResize||requestAnimationFrame((()=>this.resize()))}toggle(e,t){return this[t?"add":"remove"](e)}get permissions(){return this.mavo.permissions}destroy(){this.resizeObserver.disconnect(),this.resizeObserver=null}static getControls(e,t=s.controls){var n;if("none"===(e=null===(n=e)||void 0===n?void 0:n.trim()))return[];let a=Object.keys(t);if(!e)return a.filter((e=>!t[e].optional));let o=/^with\s|\bno-\w+\b/.test(e),l=(e=e.replace(/\b^with\s+/g,"")).split(/\s+/);a=new Set(a),l=new Set(l);for(let e of l)e.startsWith("no-")?(l.delete(e),e=e.slice(3),l.has(e)||a.delete(e)):a.has(e)||l.delete(e);if(!o)return[...l];for(let e of a){t[e].optional&&!l.has(e)&&a.delete(e)}if(a=[...a],0===l.size)return a;let u=[...l].map((e=>a.indexOf(e))),h=r(...u),d=i(...u),c=a.slice(0,h),p=a.slice(d+1);return[...c,...a.slice(h,d+1).filter((e=>!l.has(e))),...l,...p]}};s.controls={status:{create:function(t){return t||e.create({className:"mv-status"})},prepare:function(){let t=this.primaryBackend;if(null!=t&&t.user){let i=t.user,r=[i.name||""];i.avatar&&r.unshift(e.create("img",{className:"mv-avatar",src:i.avatar})," "),i.url&&(r=[e.create("a",{href:i.url,target:"_blank",contents:r})]),this.bar.status.textContent="",e.contents(this.bar.status,[{tag:"span",innerHTML:this._("logged-in-as",t)}," ",...r])}},permission:"logout"},edit:{action:function(){this.editing?(this.done(),this.bar.edit.textContent=this._("edit")):(this.edit(),this.bar.edit.textContent=this._("editing"))},permission:["edit","add","delete"],cleanup:function(){var e;this.editing&&(this.done(),null!==(e=this.bar)&&void 0!==e&&e.edit&&(this.bar.edit.textContent=this._("edit")))},condition:function(){return this.needsEdit}},save:{action:function(){this.save()},events:{"mouseenter focus":function(){this.element.classList.add("mv-highlight-unsaved")},"mouseleave blur":function(){this.element.classList.remove("mv-highlight-unsaved")}},permission:"save",condition:function(){return!this.autoSave||0<this.autoSaveDelay}},export:{create:function(t){let i;return i=t?t.matches("a")?t:e.create("a",{className:"mv-button",around:t}):e.create("a",{className:"mv-export mv-button",textContent:this._("export")}),i.setAttribute("download",this.id+".json"),i},events:{mousedown:function(){this.bar.export.href="data:application/json;charset=UTF-8,"+encodeURIComponent(this.toJSON())}},permission:"edit",optional:!0},import:{create:function(t){let i=t||e.create("span",{role:"button",tabIndex:"0",className:"mv-import mv-button",textContent:this._("import"),events:{focus:()=>{r.focus()}}}),r=e.create("input",{type:"file",inside:i,events:{change:t=>{let i=t.target.files[0];if(i){let t=e.extend(new FileReader,{onload:()=>{this.inProgress=!1;try{let e=JSON.parse(t.result);this.render(e)}catch(e){this.error(this._("cannot-parse"))}},onerror:()=>{this.error(this._("problem-loading"))}});this.inProgress="uploading",t.readAsText(i)}}}});return i},optional:!0},login:{action:function(){this.primaryBackend.login()},permission:"login"},logout:{action:function(){this.primaryBackend.logout()},permission:"logout"}}}(Bliss,Bliss.$),function(e){Mavo.UI.Message=e.Class({constructor:function(t,i,r={}){if(this.mavo=t,this.message=i,this.closed=Mavo.promise(),this.options=r,this.element=e.create({className:"mv-ui mv-message"+(r.type?" mv-"+r.type:""),["string"==e.type(this.message)?"innerHTML":"contents"]:this.message,events:{click:()=>Mavo.scrollIntoViewIfNeeded(this.mavo.element)},[this.mavo.bar?"after":"start"]:(this.mavo.bar||this.mavo).element}),r.style&&e.style(this.element,r.style),r.classes&&this.element.classList.add(...r.classes.split(/\s+/)),"error"==r.type?this.element.setAttribute("role","alert"):this.element.setAttribute("aria-live","polite"),r.dismiss=r.dismiss||{},"string"==typeof r.dismiss||Array.isArray(r.dismiss)){var s={};Mavo.toArray(r.dismiss).forEach((e=>{s[e]=!0})),r.dismiss=s}if(r.dismiss.button&&e.create("button",{type:"button",className:"mv-close mv-ui",textContent:"",events:{click:()=>this.close()},start:this.element,title:this.mavo._("dismiss")}),r.dismiss.timeout){var n="number"==typeof r.dismiss.timeout?r.dismiss.timeout:5e3;e.bind(this.element,{mouseenter:()=>clearTimeout(this.closeTimeout),mouseleave:Mavo.rr((()=>this.closeTimeout=setTimeout((()=>this.close()),n)))})}r.dismiss.submit&&this.element.addEventListener("submit",(e=>{e.preventDefault(),this.close(e.target)}))},async close(t){clearTimeout(this.closeTimeout);var i=this.element.style.transition?1e3*parseFloat(window.getComputedStyle(this.element,null).transitionDuration):400;await e.transition(this.element,{opacity:0},i),e.remove(this.element),this.closed.resolve(t)}})}(Bliss,Bliss.$),function(e){var t=Mavo.Permissions=e.Class({constructor:function(i){this.triggers=[],this.hooks=new e.Hooks,this.parentChanged=t.prototype.parentChanged.bind(this),this.set(i)},set:function(e){for(var t in e)this[t]=e[t]},on:function(e){return Mavo.toArray(e).forEach((e=>this[e]=!0)),this},off:function(e){return(e=Array.isArray(e)?e:[e]).forEach((e=>this[e]=!1)),this},can:function(e,t,i){this.observe(e,!0,t),i&&this.cannot(e,i)},cannot:function(e,t){this.observe(e,!1,t)},observe:function(e,t,i){e=Mavo.toArray(e),this.is(e,t)&&i(),this.triggers.push({actions:e,value:t,callback:i,active:!0})},is:function(e,t=!0){var i=Mavo.toArray(e).map((e=>!!this[e])).reduce(((e,t)=>e||t));return t?i:!i},onchange:function(e){this.hooks.add("change",e),t.actions.forEach((t=>{e.call(this,{action:t,value:this[t]})}))},parentChanged:function(t={}){void 0!==this["_"+t.action]||t.from==t.value||(this.fireTriggers(t.action),this.hooks.run("change",e.extend({context:this},t)))},changed:function(e,t,i){(t=!!t)==(i=!!i)||(this["_"+e]=t,this.fireTriggers(e),this.hooks.run("change",{action:e,value:t,from:i,context:this}))},fireTriggers:function(e){this.triggers.forEach((t=>{var i=this.is(t.actions,t.value);t.active&&-1<t.actions.indexOf(e)&&i?(t.active=!1,t.callback()):!i&&(t.active=!0)}))},or:function(e){return t.actions.forEach((t=>{this[t]=this[t]||e[t]})),this},live:{parent:function(e){var i=this._parent;if(i!=e){if(this._parent=e,i){let e=i.hooks.change.indexOf(this.parentChanged);-1<e&&i.hooks.change.splice(e,1)}t.actions.forEach((t=>{this.parentChanged({action:t,value:e?e[t]:void 0,from:i?i[t]:void 0})})),e&&e.onchange(this.parentChanged)}}},static:{actions:[],register:function(i,r){return Array.isArray(i)?void i.forEach((e=>t.register(e,r))):(e.live(t.prototype,i,{get:function(){var e=this["_"+i];return void 0===e&&this.parent?this.parent[i]:e},set:function(e,t){r&&r.call(this,e,t),this.changed(i,e,t)}}),void t.actions.push(i))}}});t.register(["read","save"]),t.register("login",(function(e){e&&this.logout&&(this.logout=!1)})),t.register("logout",(function(e){e&&this.login&&(this.login=!1)})),t.register("edit",(function(e){e&&(this.add=this.delete=!0)})),t.register(["add","delete"],(function(e){e||(this.edit=!1)}))}(Bliss,Bliss.$),function(e){var t,i,r=Math.min,s=Mavo.Backend=(i=t=class extends EventTarget{constructor(e,t={}){super(),_defineProperty(this,"ready",Promise.resolve()),_defineProperty(this,"oAuthParams",(()=>"")),this.permissions=new Mavo.Permissions,this.update(e,t)}update(e,t={}){var i,r;(this.source=e,this.url=new URL(this.source,Mavo.base),this.options=t,this.mavo=t.mavo,this.format=Mavo.Formats.create(t.format,this),null!==(i=this.constructor.key)&&void 0!==i?i:t.key)&&(this.key=null!==(r=t.key)&&void 0!==r?r:this.constructor.key)}async get(e=new URL(this.url)){"data:"!=e.protocol&&!1!==this.constructor.useCache&&e.searchParams.set("timestamp",Date.now());try{let t=await fetch(e.href);return t.ok?t.text():Promise.reject(t)}catch(e){return null}}async load(){await this.ready;let e=await this.get();return"string"==typeof e?(e=e.replace(/^\ufeff/,""),this.format.parse(e)):e}async store(e,{path:t,format:i=this.format}={}){await this.ready;var r="string"==typeof e?e:await i.stringify(e);return await this.put(r,t),{data:e,serialized:r}}async login(){}async logout(){}put(){return Promise.reject()}isAuthenticated(){return!!this.accessToken}toString(){return"".concat(this.id," (").concat(this.url,")")}equals(e){return e===this||e&&this.id==e.id&&this.source==e.source}async request(t,i,r="GET",s={}){var n;if((s=Object.assign({},s)).method=s.method||r,s.responseType=s.responseType||"json",s.headers=Object.assign({"Content-Type":"application/json; charset=utf-8"},s.headers||{}),this.isAuthenticated()&&(s.headers.Authorization=s.headers.Authorization||"Bearer ".concat(this.accessToken)),s.body=i,t=new URL(t,this.constructor.apiDomain),"GET"==s.method&&!1!==this.constructor.useCache&&t.searchParams.set("timestamp",Date.now()),"object"===e.type(s.body))if("GET"===s.method||"HEAD"===s.method){for(let e in s.body){let i=void 0===s.body[e]?"delete":"set";t.searchParams[i](e,s.body[e])}delete s.body}else s.body=JSON.stringify(s.body);let a;try{a=await fetch(t,s)}catch(e){this.mavo.error("Something went wrong while connecting to "+this.id,e)}if(null!==(n=a)&&void 0!==n&&n.ok)return"HEAD"===s.method||"response"===s.responseType?a:a[s.responseType]();throw a}oAuthenticate(e){return this.ready.then((()=>this.isAuthenticated()?Promise.resolve():new Promise(((t,i)=>{var s=this.id.toLowerCase();if(e)this.accessToken=localStorage["mavo:".concat(s,"token")],this.accessToken&&t(this.accessToken);else{var n={width:r(1e3,innerWidth-100),height:r(800,innerHeight-100)};n.top=(screen.height-n.height)/2,n.left=(screen.width-n.width)/2;var a={url:location.href,backend:this.id};this.authPopup=open("".concat(this.constructor.oAuth,"?client_id=").concat(this.key,"&state=").concat(encodeURIComponent(JSON.stringify(a)))+this.oAuthParams(),"popup","width=".concat(n.width,",height=").concat(n.height,",left=").concat(n.left,",top=").concat(n.top)),this.authPopup||(this.mavo.error("Login popup was blocked! Please check your popup blocker settings."),i(Error("Login popup was blocked! Please check your popup blocker settings."))),addEventListener("message",(e=>{if(e.source===this.authPopup)for(var r in e.data.backend==this.id&&(this.accessToken=localStorage["mavo:".concat(s,"token")]=e.data.token),this.accessToken||i(Error("Authentication error")),t(this.accessToken),Mavo.all){var n=Mavo.all[r].primaryBackend;n&&n.id===this.id&&n!==this&&!n.isAuthenticated()&&n.login(!0)}}))}}))))}oAuthLogout(){if(this.isAuthenticated()){var t=this.id.toLowerCase();localStorage.removeItem("mavo:".concat(t,"token")),delete this.accessToken,this.permissions.off(["edit","add","delete","save"]).on("login"),e.fire(this,"mv-logout")}return Promise.resolve()}static create(e,t={},i){let r;return t.type&&(r=Mavo.Functions.get(s,t.type)),e&&!r&&(r=s.types.find((i=>i.test(e,t)))||s.Remote),r&&(null==i?void 0:i.constructor)===r&&i.constructor.prototype.hasOwnProperty("update")?(i.update(e,t),i):r?new r(e,t):null}static register(e){return s[e.name]=e,s.types.push(e),e}},_defineProperty(t,"types",[]),i);s.register(class extends s{constructor(e,t){super(e,t),_defineProperty(this,"id","Element"),this.permissions.on(["read","edit","save"])}update(t,i){var r,s,n;super.update(t,i),null===(r=this.observer)||void 0===r||r.disconnect(),this.element=null!==(s=e(this.source))&&void 0!==s?s:e.create("script",{type:"application/json",id:this.source.slice(1),inside:document.body}),this.observer=null!==(n=this.observer)&&void 0!==n?n:new MutationObserver((()=>{e.fire(this,"mv-remotedatachange")})),this.observer.observe(this.element,{childList:!0,characterData:!0,subtree:!0})}async get(){return this.element.textContent}async put(e){this.observer.disconnect();let t=this.element.textContent=e;return this.observer.observe(this.element,{childList:!0,characterData:!0,subtree:!0}),t}static test(e){return 0===e.indexOf("#")}}),s.register(class extends s{constructor(e,t){super(e,t),_defineProperty(this,"id","Remote"),this.permissions.on("read")}static test(){return!1}}),s.register(class extends s{constructor(e,t){super(e,t),_defineProperty(this,"id","Local"),this.permissions.on(["read","edit","save"])}update(e,t){super.update(e,t),this.key=t.key||this.mavo.id}get(){return Promise[this.key in localStorage?"resolve":"reject"](localStorage[this.key])}put(e){return e?localStorage[this.key]=e:delete localStorage[this.key],Promise.resolve(e)}static test(e){return"local"==e}})}(Bliss,Bliss.$),function(e){var t=Mavo.Formats={},i=t.Base=e.Class({abstract:!0,constructor:function(e){this.backend=e},proxy:{mavo:"backend"},parse:function(e){return this.constructor.parse(e,this)},stringify:function(e){return this.constructor.stringify(e,this)},static:{parse:e=>Promise.resolve(e),stringify:e=>Promise.resolve(e),extensions:[],dependencies:[],ready:function(){return Promise.all(this.dependencies.map((t=>e.include(t.test(),t.url))))}}});t.JSON=e.Class({extends:t.Base,static:{parse:e=>Promise.resolve(e?JSON.parse(e):null),stringify:e=>Promise.resolve(Mavo.toJSON(e)),extensions:[".json",".jsonld"]}}),t.Text=e.Class({extends:t.Base,constructor:function(){this.property=this.mavo.root.getNames("Primitive")[0]},static:{extensions:[".txt"],parse:(e,t)=>Promise.resolve({[t?t.property:"content"]:e}),stringify:(e,t)=>Promise.resolve(e[t?t.property:"content"])}});var r=t.CSV=e.Class({extends:t.Base,constructor:function(){this.property=this.mavo.root.getNames("Collection")[0],this.options=e.extend({},t.CSV.defaultOptions)},static:{extensions:[".csv",".tsv"],defaultOptions:{header:!0,dynamicTyping:!0,skipEmptyLines:!0},dependencies:[{test:()=>self.Papa,url:"https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.4/papaparse.min.js"}],ready:i.ready,parse:async(e,t)=>{await r.ready();var i=Papa.parse(e,r.defaultOptions),s=t?t.property:"content";if(t&&(t.options.delimiter=i.meta.delimiter,t.options.linebreak=i.meta.linebreak),i.meta.aborted)throw i.meta.errors.pop();return{[s]:i.data}},stringify:async(e,t)=>{await r.ready();var i=t?t.property:"content",s=t?t.options:r.defaultOptions;return Papa.unparse(e[i],s)}}});Object.defineProperty(t,"create",{value:function(e,i){if(e&&"object"==typeof e)return e;if("string"==typeof e)for(var r in e=e.toLowerCase(),t){var s=t[r];if(r.toLowerCase()==e)return new s(i)}if(!e){var n,a,o=null!==(n=null===(a=(i.url?i.url.pathname:i.source).match(/\.\w+$/))||void 0===a?void 0:a[0])&&void 0!==n?n:".json";s=t.JSON;for(var r in t)-1<t[r].extensions.indexOf(o)&&(s=t[r]);return new s(i)}}})}(Bliss,Bliss.$),function(e,t){var i=Mavo.Node=class{constructor(t,r,s={}){if(!t||!r)throw new Error("Mavo.Node constructor requires an element argument and a mavo object");var n={context:this,options:s};this.uid=i.all.push(this)-1,this.property=null,this.element=t,this.isHelperVariable=this.element.matches("meta"),e.extend(this,n.options),i.elements.set(t,[...i.elements.get(this.element)||[],this]),this.mavo=r,this.group=this.parent=this.parentGroup=n.options.group,this.template=n.options.template,this.alias=this.element.getAttribute("mv-alias"),this.template?this.template.copies.add(this):this.copies=new Set,this.fromTemplate("property","type","storage","path")||(this.property=i.getProperty(t),this.type=Mavo.Group.normalize(t),this.storage=this.element.getAttribute("mv-storage"),this.path=this.getPath()),this.modes=this.element.getAttribute("mv-mode"),Mavo.hooks.run("node-init-start",n),this.mode=Mavo.getStyle(this.element,"--mv-mode")||"read",this.collection=n.options.collection,this.collection&&(this.group=this.parentGroup=this.collection.parentGroup);var a=this.template;if(null!=a&&a.expressions){this.expressions=new Set;for(let e of a.expressions)this.expressions.add(new Mavo.DOMExpression({template:e,item:this,mavo:this.mavo}))}if(!(this instanceof Mavo.Primitive)){var o=Mavo.DOMExpression.search(this.element).filter((e=>"mv-value"==e.originalAttribute))[0];o&&(o.mavoNode=this,this.expressionText=o,this.storage=this.storage||"none",this.modes=this.modes||"read")}Mavo.hooks.run("node-init-end",n)}get editing(){return"edit"==this.mode}get isRoot(){return!this.property}get name(){return Mavo.Functions.readable(this.property||this.type).toLowerCase()}get saved(){return"none"!==this.storage}get properties(){let e=this.liveData.data[Mavo.route];return e?Object.keys(e):[]}postInit(){"edit"==this.modes&&this.edit()}destroy(){this.template&&this.template.copies.delete(this),this.expressions&&this.expressions.forEach((e=>e.destroy())),this.itembar&&this.itembar.destroy(),delete i.all[this.uid],this.propagate("destroy")}getLiveData(){return this.liveData.proxy}isDataNull(e={}){var t={context:this,options:e,result:!this.saved&&!e.live};return Mavo.hooks.run("node-isdatanull",t),t.result}walk(e,t=[],i={}){var r=(t,s)=>{if(!1!==(n=e(t,s)))for(let e in t.children){let a=t.children[e];var n;if(a instanceof Mavo.Node)if(!1===(n=r.call(a,a,[...s,e]))&&!i.descentReturn)return!1}return!1!==n};return r(this,t)}walkUp(e){for(var t=this;t=t.parentGroup;){var i=e(t);if(void 0!==i)return i}}edit({force:t}={}){return this.mode="edit",!(!t&&"edit"!=this.mode)&&(e.fire(this.element,"mv-edit",{mavo:this.mavo,node:this}),void Mavo.hooks.run("node-edit-end",this))}done({force:t}={}){return this.mode=Mavo.getStyle(this.element.parentNode,"--mv-mode")||"read",!(!t&&"read"!=this.mode)&&(e.unbind(this.element,".mavo:edit"),e.fire(this.element,"mv-done",{mavo:this.mavo,node:this}),this.propagate("done"),void Mavo.hooks.run("node-done-end",this))}save(){this.unsavedChanges=!1,this.propagate("save")}propagate(e){for(let t in this.children){let i=this.children[t];i instanceof Mavo.Node&&("function"==typeof e?e.call(i,i):e in i&&i[e]())}}fromTemplate(...e){return this.template&&e.forEach((e=>this[e]=this.template[e])),!!this.template}async render(t,i={}){if(i.live=i.live||Mavo.in(Mavo.isProxy,t),i.root=i.root||this,delete this.pending,"promise"===e.type(t)){let e=this.pending=t;try{t=await e}catch(e){t=e}if(this.pending!==e)return;delete this.pending}i.live&&(t=Mavo.clone(t)),this.oldData=this.data,this.data=t,i.live||(t=Mavo.subset(t,this.inPath));var r,s={context:this,data:t,options:i};if(Mavo.hooks.run("node-render-start",s),!this.isHelperVariable&&!i.live)if(!Array.isArray(this.children)&&Array.isArray(s.data)){if(this.isRoot){var n=this.children.main instanceof Mavo.Collection?"main":this.getNames(((e,t)=>{var i,r;return t instanceof Mavo.Collection&&!(null!==(i=t.expressions)&&void 0!==i&&null!==(r=i[0])&&void 0!==r&&r.isDynamicObject)}))[0];n&&(s.data={[n]:s.data})}this.isRoot&&n||(this.inPath.push("0"),s.data=s.data[0])}else 1==(null===(r=this.childrenNames)||void 0===r?void 0:r.length)&&this.childrenNames[0]===this.property&&null!==s.data&&Mavo.isPlainObject(s.data)&&(s.data=s.data[this.property]);this===i.root&&(this.expressionsEnabled=!1);var a=this.editing;a&&this.done();var o=this.dataRender(s.data,i);return a&&this.edit(),this===i.root&&(this.save(),this.expressionsEnabled=!0,o&&requestAnimationFrame((()=>this.mavo.expressions.update(this)))),Mavo.hooks.run("node-render-end",s),o}dataChanged(t,i={}){var r=e.extend({action:t,property:this.property,mavo:this.mavo,node:this},i);e.fire(i.element||this.element,"mv-change",r),this.mavo.changed(r)}toString(){return"#".concat(this.uid,": ").concat(this.constructor.name," (").concat(this.property,")")}getClosestCollection(){var e=this.closestItem;return e?e.collection:null}getClosestItem(){var e,t;return Array.isArray(null===(e=this.collection)||void 0===e?void 0:e.children)?this:(null===(t=this.parentGroup)||void 0===t?void 0:t.closestItem)||null}getPath(){var e,t=(null===(e=this.parent)||void 0===e?void 0:e.path)||[];return this.property?[...t,this.property]:t}pathFrom(e){for(var t=this.path,i=e.path,r=0;r<t.length&&i[r]==t[r];r++);return t.slice(r)}getDescendant(e){return e.reduce(((e,t)=>e.children[t]),this)}getCousin(e,t={}){if(!this.closestCollection)return null;var i=this.closestCollection,r=Math.abs(e),s=0>e?-1:1;if(i.length<r+1)return null;var n=this.closestItem.index+e;t.wrap&&(n=Mavo.wrap(n,i.length));for(var a=0;a<i.length;a++){var o=n+a*s;t.wrap&&(o=Mavo.wrap(o,i.length));var l=i.children[o];if(l)break}if(!l||l==this.closestItem)return null;if(this.collection)return l;var u=this.pathFrom(this.closestItem);return l.getDescendant(u)}contains(e){do{if(e===this)return!0;e=e.parent}while(e);return!1}eval(e,t){return new Mavo.Expression(e).eval(this.getLiveData(),t)}static create(e,t,i={}){if(e.hasAttribute("mv-list"))return new Mavo.Collection(e,t,i);let r=e.matches(Mavo.selectors.group);return new Mavo[r?"Group":"Primitive"](e,t,i)}static getImplicitPropertyName(e){return e.getAttribute("itemprop")||e.getAttribute("mv-list")||e.getAttribute("mv-list-item")||e.name||e.id||[...e.classList].filter((e=>!e.startsWith("mv-")))[0]}static getProperty(e){if(!e.hasAttribute("property"))return null;let t=e.getAttribute("property");return!t&&(t=i.getImplicitPropertyName(e))&&e.setAttribute("property",t),t}static generatePropertyName(e,i=document.documentElement){let r=i.closest(Mavo.selectors.init),s=new Set(t("[property]",r).map((e=>e.getAttribute("property"))));for(let t="";1e3>t;t++){let i=e+t;if(!s.has(i))return i}}static get(e,t){let r=i.elements.get(e)||[];return r=r.filter((e=>!(e instanceof Mavo.ImplicitCollection))),2>r.length||!t?r[0]:r[0]instanceof Mavo.Group?r[1]:void 0}static getClosest(e,t){let r;do{var s;r=i.get(e,t)}while(!r&&(e=null===(s=e)||void 0===s?void 0:s.parentNode));return r}static getClosestItem(e){var t=i.getClosest(e);return t instanceof Mavo.Primitive&&!t.collection?t.parent:t}static children(e){var i=Mavo.Node.get(e);return i?[i]:(i=t(Mavo.selectors.property,e).map((e=>Mavo.Node.get(e))).filter((t=>!e.contains(t.parentGroup.element))).map((e=>e.collection||e)),Mavo.Functions.unique(i))}};e.Class(i,{toJSON:Mavo.prototype.toJSON,lazy:{closestCollection:function(){return this.getClosestCollection()},closestItem:function(){return this.getClosestItem()},inPath:function(){return(this.element.getAttribute("mv-path")||"").split("/").filter((e=>e.length))}},live:{store:function(t){e.toggleAttribute(this.element,"mv-storage",t)},unsavedChanges:function(e){return!e||this.saved&&this.editing||(e=!1),Array.isArray(this.children)||this.element.classList.toggle("mv-unsaved-changes",e),e},mode:function(t){if(this._mode!=t){if(this.modes&&t!=this.modes&&(t=this.modes),this._mode=t,!Array.isArray(this.children)&&-1<[null,"","read","edit"].indexOf(this.element.getAttribute("mv-mode"))){var i=this.modes||"edit"==t;let r=Mavo.observers.pause({attribute:"mv-mode"});e.toggleAttribute(this.element,"mv-mode",t,i),Mavo.observers.resume(r)}return t}},modes:function(e){return e&&"read"!=e&&"edit"!=e?null:(this._modes=e,void(e&&this.mode!=e&&(this.mode=e)))},collection:function(e){this.parent=e||this.parentGroup},index:function(e){this._index!==e&&(this._index=e,this.liveData.updateKey())},expressionsEnabled:{get:function(){return!1!==this._expressionsEnabled&&(!this.parent||this.parent.expressionsEnabled)}}},static:{all:[],elements:new WeakMap}}),Mavo.observe({attribute:"mv-storage"},(function({node:e}){e&&(e.storage=e.element.getAttribute("mv-storage"))}))}(Bliss,Bliss.$),function(e,t){var i=Mavo.Group=class extends Mavo.Node{constructor(e,i,r){super(e,i,r),this.children={},this.group=this,Mavo.hooks.run("group-init-start",this),Mavo.Primitive.getValueAttribute(this.element)&&(this.children[this.property]=new Mavo.Primitive(this.element,this.mavo,{group:this}));let s=t("[property]:not(:scope ".concat(Mavo.selectors.scope," [property])"),this.element),n=s.map((e=>Mavo.Node.getProperty(e)));for(let e,t=0;e=s[t];t++){let i=Mavo.Node.getProperty(e),r=this.children[i],s={template:this.template?this.template.children[i]:null,group:this};r?r.add(e):n.lastIndexOf(i)===t?this.children[i]=Mavo.Node.create(e,this.mavo,s):this.children[i]=new Mavo.ImplicitCollection(e,this.mavo,s)}this.childrenNames=Object.keys(this.children),this.vocab=Mavo.getClosestAttribute(this.element,"vocab"),this.postInit(),Mavo.hooks.run("group-init-end",this)}get isRoot(){return!this.property}getNames(e="Node"){var t="function"==typeof e?e:(t,i)=>i instanceof Mavo[e];return Object.keys(this.children).filter((e=>t(e,this.children[e])))}getData(e={}){var t={context:this,options:e};if(this.isDataNull(e))return null;for(var r in t.data=Mavo.shallowClone(Mavo.subset(this.data,this.inPath))||{},this.children){var s=this.children[r];if(s.saved)var n=s.getData(t.options);s.saved&&null!==Mavo.value(n)?t.data[s.property]=n:delete t.data[s.property]}return this.childrenNames.length||this.isRoot||this.collection?1===this.childrenNames.length&&this.property in this.children?t.data=t.data[this.property]:t.data&&"object"==typeof t.data&&(this.type&&this.type!=i.DEFAULT_TYPE&&(t.data["@type"]=this.type),this.vocab&&(t.data["@context"]=this.vocab)):t.data=null,t.data=Mavo.subset(this.data,this.inPath,t.data),Mavo.hooks.run("node-getdata-end",t),t.data}edit(e={}){return!1!==super.edit()&&Promise.all(Object.keys(this.children).map((t=>this.children[t].edit(e))))}dataRender(t,i={}){if(!t)return;let r,s,n,a=!1;if("object"!=typeof t){s=!0;let i=this.property;if(!(this.property in this.children)){let r=e.type(t),s=e=>(this.children[e]instanceof Mavo.Primitive)+(this.children[e].datatype==r);i=Object.keys(this.children).filter((e=>!this.children[e].expressionText)).sort(((e,t)=>s(e)-s(t))).reverse()[0]}i||(i=this.property,r=!0),t={[i]:t},this.data=Mavo.subset(this.data,this.inPath,t)}if(this.propagate((r=>{let s=t[r.property];if(r.alias){let i=r.alias.split(" ");for(let a=0;a<i.length;a++){let o=i[a];if(void 0!==t[o]){r.currentAlias=o,n=n||e.extend({},t),s=t[r.currentAlias];break}}}a=r.render(s,i)||a})),n&&this.propagate((e=>{e.currentAlias&&(t[e.property]=n[e.currentAlias],!(e.currentAlias in this.children)&&delete t[e.currentAlias])})),!s||r){let e=Mavo.subset(this.oldData,this.inPath);for(let i in t)if(!(i in this.children)){let r=t[i];a=a||t[i]!==this.liveData.data[i],this.liveData.set(i,r),!1===this.expressionsEnabled||"object"==typeof r||e&&e[i]==r||this.dataChanged("propertychange",{property:i})}}return a}static normalize(e){if(e.matches(Mavo.selectors.group)){var t=Mavo.getAttribute(e,"typeof","mv-group")||i.DEFAULT_TYPE;return e.setAttribute("typeof",t),t}return null}};e.Class(i,{lazy:{liveData:function(){return new Mavo.Data(this,{})}},static:{all:new WeakMap,DEFAULT_TYPE:"Item"}})}(Bliss,Bliss.$),async function(e,t){var i=Mavo.Primitive=class extends Mavo.Node{constructor(t,r,s){if(super(t,r,s),this.liveData=new Mavo.Data(this),this.fromTemplate("config","attribute","templateValue","originalEditor")||(this.config=i.getConfig(t),this.attribute=this.config.attribute,this.attribute&&!document.xmlVersion&&(this.attribute=this.attribute.toLowerCase())),this.datatype=this.config.datatype,"modes"in this.config&&(this.modes=this.config.modes,this.element.setAttribute("mv-mode",this.config.modes)),Mavo.hooks.run("primitive-init-start",this),this.expressionText=this.expressionText||Mavo.DOMExpression.search(this.element,this.attribute),this.expressionText&&!this.expressionText.mavoNode&&(this.expressionText.mavoNode=this,this.storage=this.storage||"none",this.modes="read",this.element.setAttribute("aria-live","polite")),this.config.init&&this.config.init.call(this,this.element),this.config.initOnce&&!this.config.initOnce.called&&(this.config.initOnce.call(this,this.element),this.config.initOnce.called=!0),this.config.changeEvents&&e.bind(this.element,this.config.changeEvents,(e=>{e.target===this.element&&(this.value=this.getValue())})),this.expressionText)this.setValue(this.expressionText.value,{silent:!0});else{if(this.element.hasAttribute("aria-label")?this.label=this.element.getAttribute("aria-label"):(this.label=Mavo.Functions.readable(this.property),this.pauseObserver(),this.element.setAttribute("aria-label",this.label),this.resumeObserver()),this.element.hasAttribute("mv-editor")){this.originalEditorUpdated({force:!0});let e=this.editorValue;this.datatype||"number"!=typeof e&&"boolean"!=typeof e||(this.datatype=typeof e)}else this.element.hasAttribute("mv-options")&&this.updateOptions();if(this.templateValue=this.getValue(),this._default=this.element.getAttribute("mv-default"),null!==this.default)""===this.default?(this._default=this.templateValue,this.defaultSource="template"):(this.defaultExpression=Mavo.DOMExpression.search(this.element,"mv-default"),this.defaultExpression&&(this.defaultExpression.output=e=>this.default=e),this.defaultSource="attribute");else if(this.modes)this._default=this.templateValue,this.defaultSource="template";else{if(this._default=this.editorValue,this.options){var n;let e=this.options.keys().next().value;this._default=null!==(n=this._default)&&void 0!==n?n:e}this.defaultSource="editor"}this.setValue(this.initialValue,{silent:!0})}this.postInit(),Mavo.hooks.run("primitive-init-end",this)}get initialValue(){let e,t=!this.template||this.template.templateValue!=this.templateValue||"edit"==this.modes;return e=void 0===this.default&&t?this.templateValue:this.default,void 0===e&&(e=this.emptyValue),e}get editorValue(){let t=this.editor||this.originalEditor;if(t){if(i.isFormControl(t))return i.getValue(t,{datatype:this.datatype});let r=e(Mavo.selectors.output+", "+Mavo.selectors.formControl,t);if(r)return i.getValue(r)}}set editorValue(r){if(this.config.setEditorValue&&"boolean"!==this.datatype)return this.config.setEditorValue.call(this,r);if(this.editor)if(i.isFormControl(this.editor)){if(this.editor.matches("select")){var s;void 0===(null===(s=[...this.editor.options].find((e=>Mavo.toArray(r).map((e=>e.toString())).includes(e.value))))||void 0===s?void 0:s.textContent)?e.create("option",{className:"mv-volatile",textContent:r,inside:this.editor,selected:!0,disabled:!0}):t(".mv-volatile",this.editor).forEach((e=>e.remove()))}i.setValue(this.editor,r,{config:this.editorDefaults})}else{var n=e(Mavo.selectors.output+", "+Mavo.selectors.formControl,this.editor);n&&i.setValue(n,r)}}destroy(){var e;super.destroy(),null===(e=this.originalEditorObserver)||void 0===e||e.destroy()}isDataNull(e){return super.isDataNull(e)||null===this._value||void 0===this._value}getData(e={}){var t={context:this,options:e};return this.isDataNull(e)?null:(t.data=this.value,""!==t.data||this.templateValue&&this.initialValue===this.templateValue||(t.data=null),this.inPath.length&&(t.data=Mavo.subset(this.data,this.inPath,t.data)),Mavo.hooks.run("node-getdata-end",t),t.data)}get pausedObserver(){var e;return 0<(null===(e=this.observerPauses)||void 0===e?void 0:e.length)}pauseObserver(){Mavo.observers.flush(),this.observerPauses=this.observerPauses||[],this.observerPauses.push(1)}resumeObserver(){var e,t;Mavo.observers.flush(),null===(e=this.observerPauses)||void 0===e||null===(t=e.pop)||void 0===t||t.call(e)}save(){this.savedValue=this.value,this.unsavedChanges=!1}initEdit(){!this.editor&&this.originalEditor&&(this.editor=this.originalEditor.cloneNode(!0)),this.editorUpdated(),this.initEdit=null}updateOptions(){let e=Mavo.options(this.element.getAttribute("mv-options"),{map:!0});for(let[t,i]of e)!0===i&&e.set(t,t);this.options=e}generateDefaultEditor(){if(this.element.hasAttribute("mv-options")){this.options||this.updateOptions();let t=[...this.options].map((([e,t])=>({tag:"option",value:e,textContent:t})));this.editor=e.create("select",{className:"mv-editor mv-options-select",contents:t})}else{let t=this.config.editor;t&&"boolean"!=this.datatype||(t=Mavo.Elements.defaultConfig[this.datatype||"string"].editor),this.editor=e.create("function"===e.type(t)?t.call(this):t)}this.editorValue=this.value}updateEditType(){var e,t;let i=null!==(e=null===(t=this.element.getAttribute("mv-edit-type"))||void 0===t?void 0:t.trim())&&void 0!==e?e:"auto";var r;"auto"===i&&(i=null!==(r=this.config.editType)&&void 0!==r?r:"auto");return"auto"===i&&(i=this.attribute?"popup":"inline"),this.editType=i}editorUpdated(){this.editor||this.generateDefaultEditor(),e.bind(this.editor,{"input change":()=>{this.value=this.editorValue},"mv-change":t=>{"output"===t.property&&(t.stopPropagation(),e.fire(this.editor,"input"))}}),this.editor.matches("textarea")||this.editor.addEventListener("focus",(()=>{var e,t;null===(e=(t=this.editor).select)||void 0===e||e.call(t)}));for(let e of Mavo.getAttributes(this.element,/^mv-editor-/)){let t=this.element.getAttribute(e);e=e.replace(/^mv-editor-/,""),this.editor.setAttribute(e,t)}"placeholder"in this.editor&&!this.editor.placeholder&&(this.editor.placeholder="number"===this.editor.type?this.editor.min||0:"(".concat(this.label,")")),this.editor.matches("select")||delete this.options}originalEditorUpdated({force:t}={}){var i;let r=this.originalEditor,s=this.element.getAttribute("mv-editor");try{this.originalEditor=e(s)}catch(e){this.originalEditor=null}if(t||r!==this.originalEditor){if(this.originalEditor){if(this.editor&&(this.editor=this.originalEditor.cloneNode(!0),this.setValue(this.value,{force:!0,silent:!0})),"editor"==this.defaultSource&&(this.default=this.originalEditor.value),!this.template||this.originalEditor!==this.template.originalEditor){var n;null===(n=this.originalEditorObserver)||void 0===n||n.destroy(),this.originalEditorObserver=new Mavo.Observer(this.originalEditor,"all",(()=>{let e=[this];if(this.copies)for(let t of this.copies)t.originalEditor===this.originalEditor&&e.push(t);for(let t of e)t.originalEditorUpdated({force:!0}),t.setValue(t.value,{force:!0,silent:!0})}))}}else this.editor&&(this.generateDefaultEditor(),this.editorUpdated());let e=null!==(i=this.editor)&&void 0!==i?i:this.originalEditor;if(null!=e&&e.matches("select:not(.mv-options-select")){let t=[...e.options].filter((e=>!e.classList.contains("mv-volatile"))).map((e=>[e.value,e.textContent]));this.options=new Map(t)}}}edit(t={}){var r;let s=this.editing;if(!1===super.edit(t))return!1;if(!t.force&&s&&!this.initEdit)return!0;if("object"===e.type(this._value))return!1;if(s||(-1===this.element.tabIndex&&Mavo.revocably.setAttribute(this.element,"tabindex","0"),e.bind(this.element,"click.mavo:edit",(e=>{"edit"!==this.mode||e.target.closest("summary, a")&&e.preventDefault()}))),this.config.edit)this.config.edit.call(this),this.initEdit=null;else{if(this.pauseObserver(),this.initEdit&&this.initEdit(),this.editor.classList.toggle("mv-editor","popup"!==this.editType),"popup"===this.editType){this.popup||(this.popup=new Mavo.UI.Popup(this)),this.popup.prepare();let t=["mousedown","focus","dragover","dragenter"].map((e=>e+".mavo:edit")).join(" ");e.bind(this.element,t,(()=>this.popup.show()))}else"inline"===this.editType&&(this.editor.isConnected||(this.editorValue=this.value,this.config.hasChildren?this.element.textContent="":i.setText(this.element,""),!this.contentExpression&&(this.contentExpression=Mavo.DOMExpression.search(this.element,null)),this.contentExpression&&(this.contentExpression.active=!1),this.element.prepend(this.editor)),this.collection||Mavo.revocably.restoreAttribute(this.element,"tabindex"));this.resumeObserver()}if(this.closestCollection&&"inline"===this.editType&&null!==(r=this.editor)&&void 0!==r&&r.matches(Mavo.selectors.textInput)){let t=this.editor.matches("textarea");t||e.bind(this.editor,"paste.mavo:edit",(t=>{if(this.closestCollection.editing&&t.clipboardData){let r=t.clipboardData.getData("text/plain");const s=/\r?\n|\r/;if(s.test(r)){var i;t.preventDefault();let n=r.split(s);this.editor.setRangeText(n[0]),e.fire(this.editor,"input");let a=this.closestCollection,o=(null===(i=closestItem)||void 0===i?void 0:i.index)||0;for(let e=1;e<n.length;e++){this.closestItem;let t=a.add(void 0,o+e);a.editItem(t),this.getCousin(e).render(n[e])}}}})),e.bind(this.editor,"keydown.mavo:edit",(e=>{if(this.closestCollection.editing)if("Enter"!=e.key||!e.shiftKey&&t){if("Backspace"==e.key&&this.empty){let t=this.getCousin(1)||this.getCousin(-1);this.closestCollection.delete(this.closestItem),t&&(t.edit(),t.editor.focus()),e.preventDefault()}}else{if(this.bottomUp)return;let i=this.closestItem,r=this.closestCollection.add(void 0,(null==i?void 0:i.index)+1);this.closestCollection.editItem(r);let s=this.getCousin(1);requestAnimationFrame((()=>{s.edit(),s.editor.focus()})),t&&e.preventDefault()}}))}return!0}done(i){var r;if(!1===super.done(i))return!1;if(e.unbind(this.element,".mavo:edit"),this.pauseObserver(),this.config.done)this.config.done.call(this);else{var s;if("popup"===this.editType)null===(s=this.popup)||void 0===s||s.close();else"inline"===this.editType&&this.editor&&(this.editor.remove(),this.contentExpression&&(this.contentExpression.active=!0,this.contentExpression.update({force:!0})),this.setValue(this.editorValue,{silent:!0,force:!0}));null!==(r=this.editor)&&void 0!==r&&r.matches("select")&&t(".mv-volatile",this.editor).forEach((e=>{e.selected||e.remove()})),this.resumeObserver(),this.collection||Mavo.revocably.restoreAttribute(this.element,"tabindex")}}dataRender(t,{live:i,root:r}={}){var s=this._value;return"object"===e.type(t)&&(Symbol.toPrimitive in t?t=t[Symbol.toPrimitive]("default"):this.editing&&this.done()),void 0===t?!this.modes&&this.value===this.templateValue&&(this.value=this.closestCollection?this.default:this.templateValue):this.value=t,this._value!==s}find(e,t={}){if(this.property==e&&t.exclude!==this)return this}getValue(){return this.editing&&this.editor&&this.editor!==this.element?this.editorValue:i.getValue(this.element,{config:this.config,attribute:this.attribute,datatype:this.datatype})}setValue(e,t={}){void 0===e&&(e=null);let r=this.datatype;if(this.datatype||"number"!=typeof e&&"boolean"!=typeof e||(this.datatype=typeof e),e=i.safeCast(e,this.datatype),!t.force&&e===this._value&&r==this.datatype)return e;if(this.pauseObserver(),this.editor&&this.editorValue!=e&&(this.editorValue=e),"popup"==this.editType||!this.editor||this.editor!==document.activeElement&&!this.element.contains(this.editor))if(this.config.setValue)this.config.setValue.call(this,this.element,e);else if(!t.dataOnly){let t;this.options&&(t=this.options.get(e)),i.setValue(this.element,e,{config:this.config,attribute:this.attribute,datatype:this.datatype,presentational:t,node:this})}return this.empty=!e&&0!==e,this._value=e,this.liveData.update(),t.silent||(this.saved&&(this.unsavedChanges=this.mavo.unsavedChanges=!0),this.dataChanged("propertychange",{value:e})),this.resumeObserver(),e}dataChanged(e="propertychange",t){return super.dataChanged(e,t)}async upload(e,t=e.name){if(!this.mavo.uploadBackend||!self.FileReader)return;var i=URL.createObjectURL(e);this.pauseObserver(),this.element.setAttribute(this.attribute,i),this.resumeObserver();var r=(this.element.getAttribute("mv-upload-path")||"")+"/"+t;let s=await this.mavo.upload(e,r);var n=Mavo.getClosestAttribute(this.element,"mv-upload-url");n&&(s=new URL(r,new URL(n,location))+""),this.value=s,this.element.matches("a")||(this.pauseObserver(),this.element.setAttribute(this.attribute,i),this.resumeObserver())}createUploadPopup(t,i="file",r){var s={context:this,type:t,kind:i,ext:r,mainInput:e.create("input",{type:"url",placeholder:"http://example.com/".concat(i,".").concat(r),className:"mv-output","aria-label":"URL to ".concat(i)})};if(this.mavo.uploadBackend&&self.FileReader){var n=e=>e&&(!t||0===e.type.indexOf(t.replace("*","")));return s.events={paste:e=>{var r=Array.from(e.clipboardData.items).find((e=>"file"===e.kind)),s=null==r?void 0:r.type.split("/")[1];if(r&&n(r)){var a=e.clipboardData.getData("text")||"pasted-".concat(i,"-").concat(Date.now(),".").concat(s),o=prompt(this.mavo._("filename"),a);""===o&&(o=a),null!==o&&(this.upload(r.getAsFile(),o,t),e.preventDefault())}},"drag dragstart dragend dragover dragenter dragleave drop":e=>{e.preventDefault(),e.stopPropagation()},"dragover dragenter":()=>{s.popup.classList.add("mv-dragover"),this.element.classList.add("mv-dragover")},"dragleave dragend drop":()=>{s.popup.classList.remove("mv-dragover"),this.element.classList.remove("mv-dragover")},drop:e=>{var t=e.dataTransfer.files[0];t&&n(t)&&this.upload(t)}},Mavo.hooks.run("primitive-createuploadpopup-beforecreate",s),s.popup=e.create({className:"mv-upload-popup",contents:[s.mainInput,{tag:"input",type:"file","aria-label":"Upload ".concat(i),accept:t,events:{change:e=>{var t=e.target.files[0];t&&n(t)&&this.upload(t)}}},{className:"mv-tip",innerHTML:"<strong>Tip:</strong> You can also drag & drop or paste!"}],events:s.events}),e.bind(this.element,s.events),Mavo.hooks.run("primitive-createuploadpopup-beforereturn",s),s.popup}return s.mainInput}static getText(e){var t=e.nodeType===Node.TEXT_NODE?e:e.firstChild;return(null==t?void 0:t.nodeType)===Node.TEXT_NODE?t.nodeValue:""}static setText(e,t){var i=e.nodeType===Node.TEXT_NODE?e:e.firstChild;(null==i?void 0:i.nodeType)===Node.TEXT_NODE?i.nodeValue=t:e.prepend(t)}static getValueAttribute(e,t=Mavo.Elements.search(e)){var i=e.getAttribute("mv-attribute")||t.attribute;return i&&"null"!==i&&"none"!==i||(i=null),i}static safeCast(e,t){var r=i.cast(e,t);return"boolean"==t?!!e&&(!!("true"===e||0<e)||e):"number"==t?/^[-+]?[0-9.e]+$/i.test(e+"")?r:e:null==e?e:r}static cast(e,t){return"number"===t?+e:"boolean"===t?!!e:"string"===t?e+"":e}static getValue(e,{config:t,attribute:r,datatype:s}={}){return t||(t=i.getConfig(e,r)),r=t.attribute,s=t.datatype,t.getValue&&r==t.attribute?t.getValue(e):(n=r in e&&Mavo.usePropertyInsteadOfAttribute(e,r)?e[r]:r?e.getAttribute(r):e.getAttribute("content")||i.getText(e)||null,i.safeCast(n,s));var n}static getConfig(e,t,r){let s=e.getAttribute("mv-edit-as");if(s&&s in Mavo.Elements)return Mavo.Elements[s];void 0===t&&(t=e.getAttribute("mv-attribute")||void 0),("null"==t||"none"==t)&&(t=null);var n=void 0===t||t==i.getValueAttribute(e);!r&&n&&(r=e.getAttribute("datatype")||void 0);var a=Mavo.Elements.search(e,t,r);return void 0===(a=Object.assign({},a)).attribute&&(a.attribute=t||null),void 0===a.datatype&&(a.datatype=r),a}static async setValue(t,r,s={}){var n;if(null!==(n=i.pending.get(t))&&void 0!==n&&delete n[s.attribute],"promise"===e.type(r)){var a;i.pending.has(t)||i.pending.set(t,{});let e=r;i.pending.get(t)[s.attribute]=e;try{r=await e}catch(e){r=e}if(i.pending.get(t)[s.attribute]!==e)return;null!==(a=i.pending.get(t))&&void 0!==a&&delete a[s.attribute]}if(1===t.nodeType&&(s.config||(s.config=i.getConfig(t,s.attribute)),s.attribute=void 0===s.attribute?s.config.attribute:s.attribute,s.datatype=void 0===s.datatype?s.config.datatype:s.datatype,s.config.setValue&&s.attribute==s.config.attribute))return s.config.setValue(t,r,s.attribute);if(null!==r||s.datatype||(r=""),s.attribute){if(s.attribute in t&&Mavo.usePropertyInsteadOfAttribute(t,s.attribute)&&t[s.attribute]!==r)try{t[s.attribute],t[s.attribute]=r}catch(e){}"boolean"==s.datatype?r!=t.hasAttribute(s.attribute)&&e.toggleAttribute(t,s.attribute,r,r):t.getAttribute(s.attribute)!=r&&t.setAttribute(s.attribute,r)}else{var o,l=null!==(o=s.presentational)&&void 0!==o?o:i.format(r,s);s.node&&!s.config.hasChildren?i.setText(t,l):t.textContent=l,l!==r&&t.setAttribute&&t.setAttribute("content",r)}}static format(t,r={}){if("number"===e.type(t)||"number"==r.datatype){var s;if(null===t)return"";if(!(r.attribute||(null===(s=r.element)||void 0===s?void 0:s.matches("style, pre"))))return i.formatNumber(t)}return Array.isArray(t)?t.map(i.format).join(", "):"object"===e.type(t)?Mavo.toJSON(t):t}static isFormControl(e){return e.matches(Mavo.selectors.formControl)||e.matches('[mv-edit-as="formControl"]')}};e.Class(i,{lazy:{emptyValue:function(){switch(this.datatype){case"boolean":return!1;case"number":return 0}return""},editorDefaults:function(){return this.editor&&i.getConfig(this.editor)},editType:function(){return this.updateEditType()}},live:{editor:function(e){var t;this._editor===e||(null===(t=this._editor)||void 0===t||t.replaceWith(e),this._editor=e,"editor"===this.defaultSource&&(this.default=this.editorValue),this.editorUpdated())},default:function(e){this.value==this._default&&(this.value=e)},value:function(e){return this.setValue(e)},datatype:function(t){t!==this._datatype&&("boolean"==t&&!this.attribute&&(this.attribute=Mavo.Elements.defaultConfig.boolean.attribute),e.toggleAttribute(this.element,"datatype",t,t&&"string"!==t))},empty:function(t){let i=t&&!this.modes&&(!this.attribute||!e(Mavo.selectors.property,this.element))&&("boolean"!==this.datatype||this.attribute===Mavo.Elements.defaultConfig.boolean.attribute);this.element.classList.toggle("mv-empty",!!i)}},static:{all:new WeakMap,pending:new Map,lazy:{formatNumber:()=>{var e=new Intl.NumberFormat(Mavo.locale,{maximumFractionDigits:2});return function(t){return t===1/0||t===-1/0?0>t?"-":"":e.format(t)}}}}}),Mavo.observe({id:"primitive"},(function({node:e,type:t,attribute:i,record:r,element:s}){if(e instanceof Mavo.Primitive&&e.config&&!e.pausedObserver)if("mv-default"!==i||e.defaultExpression){if("aria-label"===i)e.label=s.getAttribute("aria-label"),Mavo.in("placeholder",e.editor)&&(e.editor.placeholder="number"===e.editor.type?e.editor.min||0:"(".concat(e.label,")"));else if("mv-editor"===i)e.originalEditorUpdated();else if("mv-edit-type"===i){let t=e.editing;t&&e.done({force:!0}),e.updateEditType(),t&&e.edit({force:!0})}else if("mv-options"===i)e.updateOptions(),e.editor&&e.generateDefaultEditor();else if(i&&0===i.indexOf("mv-editor-")){var n;null===(n=e.editor)||void 0===n||n.setAttribute(i.slice(10),s.getAttribute(i))}else if(!1!==e.config.observer){let r=e.config.subtree;var a;if(!(r||e.editing&&"edit"!==e.modes))r=i===e.attribute||(null===(a=e.config.observedAttributes)||void 0===a?void 0:a.includes(i))||"characterData"===t&&!e.attribute;r&&(e.value=e.getValue())}}else e.default=s.getAttribute("mv-default");else{var o;let e=Mavo.Node.getClosest(s.parentNode,!0);null!=e&&null!==(o=e.config)&&void 0!==o&&o.subtree&&(e.value=e.getValue())}})),await e.ready();let r=["checkbox","color","date","datetime-local","email","file","month","number","password","radio","range","search","submit","tel","text","time","url","week","datetime"],s=Mavo.attributeStartsWith("mv-edit-").filter((e=>("mv-edit-type"!==e.name||r.includes(e.value))&&!["mv-edit-as"].includes(e.name))).map((e=>e.name));if(Mavo.attributeStartsWith("mv-editor-"),e("[mv-edit]")&&s.unshift("mv-edit"),0<s.length){let e=[...new Set(s)];for(let i of e){let e=i.replace(/^mv-edit(-|$)/,"mv-editor$1"),r=t("[".concat(i,"]"));for(let t of r)Mavo.setAttributeShy(t,e,t.getAttribute(i))}}}(Bliss,Bliss.$),function(e){Mavo.UI.Popup=e.Class({constructor:function(t){this.primitive=t,this.position=()=>{var t=this.primitive.element.getBoundingClientRect(),i=t.left,r=t.bottom,s=!1;if(this.element.offsetHeight&&(this.height=this.element.getBoundingClientRect().height||this.height),this.height+r+20>innerHeight)if(20<t.top-this.height){s=!0;r=t.top-this.height-20}else r=innerHeight-this.height-20;this.element.classList.toggle("mv-point-down",s),e.style(this.element,{top:"".concat(r,"px"),left:"".concat(i,"px")})},this.element=e.create("div",{className:"mv-popup",hidden:!0,contents:{tag:"fieldset",contents:[{tag:"legend",textContent:this.primitive.label+":"},this.editor]},events:{keyup:e=>{(13==e.keyCode||27==e.keyCode)&&(this.element.contains(document.activeElement)&&this.primitive.element.focus(),e.stopPropagation(),this.hide())},transitionend:this.position}}),this.editor.matches("select")&&(this.editor.size=Math.min(10,this.editor.children.length)),this.hideCallback=e=>{this.element.contains(e.target)||this.primitive.element.contains(e.target)||this.hide()}},show:function(){e.unbind([this.primitive.element,this.element],".mavo:showpopup"),this.shown=!0,this.element.style.transition="none",this.element.removeAttribute("hidden"),this.position(),this.element.setAttribute("hidden",""),this.element.style.transition="",document.body.appendChild(this.element),setTimeout((()=>{this.element.removeAttribute("hidden")}),100),e.bind(document,"focus click",this.hideCallback,!0),window.addEventListener("scroll",this.position,{passive:!0})},hide:function(){e.unbind(document,"focus click",this.hideCallback,!0),window.removeEventListener("scroll",this.position,{passive:!0}),this.element.setAttribute("hidden",""),this.shown=!1,setTimeout((()=>{e.remove(this.element)}),1e3*parseFloat(getComputedStyle(this.element).transitionDuration)||400)},prepare:function(){e.bind(this.primitive.element,{"click.mavo:edit":()=>{this.show()},"keyup.mavo:edit":e=>{-1<[13,113].indexOf(e.keyCode)&&(this.show(),this.editor.focus())}}),this.element.contains(this.editor)||this.element.append(this.editor)},close:function(){this.hide(),e.unbind(this.primitive.element,".mavo:edit .mavo:preedit .mavo:showpopup")},proxy:{editor:"primitive"}})}(Bliss,Bliss.$),function(e,t){var i=Math.max,r=Math.min,s=Mavo.Elements={};Object.defineProperties(s,{register:{value:function(t,i){if("object"!=typeof arguments[0]){if(i.extend){var r=s[i.extend];i=e.extend(e.extend({},r),i)}if(-1<t.indexOf("@")){var n=t.split("@");i.selector=i.selector||n[0]||"*",void 0===i.attribute&&(i.attribute=n[1])}return i.selector=i.selector||t,i.id=t,Array.isArray(i.attribute)?i.attribute.forEach((r=>{var n=e.extend({},i);n.attribute=r,s["".concat(t,"@").concat(r)]=n})):s[t]=i,s}for(let e in arguments[0])s.register(e,arguments[0][e])}},search:{value:function(t,i,r){var n=s.matches(t,i,r);0===n.length&&r&&(n=s.matches(t,i));var a=n[n.length-1];if(a)return a;var o=e.extend({},s.defaultConfig[r||"string"]);return o.attribute=void 0===i?o.attribute:i,o}},matches:{value:function(e,t,i){var r=[];for(var n in s){var a=s[n];if((void 0===t&&a.default||t===a.attribute)&&(void 0===i||"string"===i||i===a.datatype)){var o=a.selector||n;e.matches(o)&&(!a.test||a.test(e,t,i))&&r.push(a)}}return r}},isSVG:{value:e=>"http://www.w3.org/2000/svg"==e.namespaceURI},defaultConfig:{value:{string:{editor:{tag:"input"}},number:{editor:{tag:"input",type:"number"}},boolean:{attribute:"content",editor:{tag:"input",type:"checkbox"}}}}}),s.register({"@hidden":{datatype:"boolean"},"@y":{test:s.isSVG,datatype:"number"},"@x":{default:!0,test:s.isSVG,datatype:"number"},media:{default:!0,selector:"img, video, audio",attribute:"src",editor:function(){var e=this.element.nodeName.toLowerCase();return e="img"==e?"image":e,Mavo.setAttributeShy(this.element,"mv-upload-path",e+"s"),this.createUploadPopup(e+"/*",e,"png")}},"a, link":{default:!0,attribute:"href"},"a[mv-upload-path], link[mv-upload-path]":{default:!0,attribute:"href",editor:function(){var e=this.element.getAttribute("type"),t=e&&!/\/\*$/.test(e)?e.split("/")[1]:"pdf";return this.createUploadPopup(e,void 0,t)}},"video, audio":{attribute:["autoplay","buffered","loop"],datatype:"boolean"},details:{attribute:"open",datatype:"boolean"},"input, select, optgroup, option, button, textarea, fieldset":{attribute:"disabled",datatype:"boolean"},formControl:{selector:"input",default:!0,attribute:"value",modes:"edit",editType:"self",changeEvents:"input change",edit:()=>{},done:()=>{},init:function(){this._editor=this.element}},select:{extend:"formControl",selector:"select",subtree:!0},"select[multiple]":{extend:"select",selector:"select[multiple]",getValue:e=>Array.from(e.selectedOptions).map((e=>e.value)).join(),setValue:(e,t)=>{t=Array.isArray(t)?t:(t+"").split(/\s*,/),Array.from(e.options).forEach((e=>{e.selected=!1,(t=t.map((e=>e+""))).includes(e.value)&&(e.selected=!0)}))}},option:{attribute:null,modes:"read",default:!0},textarea:{extend:"formControl",selector:"textarea",attribute:null,getValue:e=>e.value,setValue:(e,t)=>e.value=t},formNumber:{extend:"formControl",selector:"input[type=range], input[type=number]",datatype:"number",setValue:function(t,i){t.value=i,t.setAttribute("value",i);var r=i>t.value?"max":"min";isNaN(i)||t.value==i||Mavo.data(t,"boundObserver")||(0===Mavo.observers.find({element:t,id:"oob"}).size&&Mavo.observe({id:"oob",element:t,attribute:r,once:!0},(()=>t.value=i)),requestAnimationFrame((()=>{e.bind(t,"input mv-change",(function i(){Mavo.unobserve({element:t,id:"oob"}),e.unbind(t,"input mv-change",i)}))})))},observedAttributes:["min","max"]},checkbox:{extend:"formControl",selector:"input[type=checkbox]",attribute:"checked",datatype:"boolean",changeEvents:"click"},"input[type=checkbox]":{attribute:"indeterminate",datatype:"boolean"},radio:{extend:"formControl",selector:"input[type=radio]",attribute:"checked",modes:"edit",getValue:t=>{if(t.form)return t.form[t.name].value;let i=e('input[type=radio][name="'.concat(t.name,'"]:checked'));return i&&i.value},setValue:(t,i)=>{if(t.form)return void(t.form[t.name].value=i);let r=e('input[type=radio][name="'.concat(t.name,'"][value="').concat(i,'"]'));r&&(r.checked=!0)},initOnce:function(){function e(e){e.name;for(let i of t('input[type=radio][name="'.concat(e.name,'"]'))){let e=Mavo.Node.get(i,!0);e&&(e.value=e.getValue())}}document.addEventListener("change",(t=>{t.target.matches("input[type=radio]")&&e(t.target)})),Mavo.observe({attribute:"value",selector:"input[type=radio]"},(t=>e(t.element)))},observedAttributes:["value"]},counter:{extend:"formControl",selector:"button, .counter",attribute:"mv-clicked",datatype:"number",init:function(e){"mv-clicked"===this.attribute&&(e.setAttribute("mv-clicked","0"),e.addEventListener("click",(()=>{let t=+e.getAttribute("mv-clicked")||0;this.value=++t})))}},meter:{default:!0,selector:"meter, progress",attribute:"value",datatype:"number",edit:function(){var t,s,n,a,o,l,u;let h=null!==(t=null!==(s=this.element.min)&&void 0!==s?s:this.element.getAttribute("min"))&&void 0!==t?t:0,d=null!==(n=null!==(a=this.element.max)&&void 0!==a?a:this.element.getAttribute("max"))&&void 0!==n?n:1;h=+h,d=+d;let c=d-h,p=null!==(o=null!==(l=null!==(u=this.element.step)&&void 0!==u?u:this.element.getAttribute("step"))&&void 0!==l?l:this.element.getAttribute("mv-editor-step"))&&void 0!==o?o:1<c?1:c/100;p=+p,e.bind(this.element,"mousemove.mavo:edit",(e=>{var t=this.element.getBoundingClientRect().left,s=i(0,(e.clientX-t)/this.element.offsetWidth),n=h+c*s,a=n%p;n=i(h,r(n+=a>p/2?p-a:-a,d)),this.pauseObserver(),this.element.setAttribute("value",n),this.resumeObserver()})),e.bind(this.element,"mouseleave.mavo:edit",(()=>{this.pauseObserver(),this.element.setAttribute("value",this.value),this.resumeObserver()})),e.bind(this.element,"click.mavo:edit",(()=>{this.value=this.getValue()})),e.bind(this.element,"keydown.mavo:edit",(e=>{if(e.target==this.element&&(37==e.keyCode||39==e.keyCode)){var t=p*(39==e.keyCode?1:-1)*(e.shiftKey?10:1),s=this.value+t;s=i(h,r(s,d)),this.element.setAttribute("value",s),e.preventDefault()}}))},observedAttributes:["min","max"]},meta:{default:!0,attribute:"content"},block:{default:!0,selector:"p, div, dt, dd, h1, h2, h3, h4, h5, h6, article, section, address, pre",editor:function(){var t=getComputedStyle(this.element),i=0===t.display.indexOf("inline")?"input":"textarea",r=e.create(i);if("textarea"==i){var s=this.element.offsetWidth;s&&(r.width=s),r.style.whiteSpace={normal:"pre-wrap",nowrap:"pre"}[t.whiteSpace]||"inherit"}return r},setEditorValue:function(e){this.datatype&&"string"!=this.datatype&&(e+="");var t=getComputedStyle(this.element);return e=e||"",-1<["normal","nowrap"].indexOf(t.whiteSpace)&&(e=e.replace(/\r?\n/g," ")),-1<["normal","nowrap","pre-line"].indexOf(t.whiteSpace)&&(e=e.replace(/^[ \t]+|[ \t]+$/gm,"").replace(/[ \t]+/g," ")),this.editor.value=e,!0}},time:{attribute:"datetime",default:!0,init:function(){if(!this.fromTemplate("dateType")){var e=Mavo.DOMExpression.search(this.element,null),t=this.element.getAttribute("datetime")||"YYYY-MM-DD";let n=this.element.getAttribute("mv-editor-type");if(n in this.config.dateTypes)this.dateType=n;else for(let e in this.config.dateTypes)if(this.config.dateTypes[e].test(t)){this.dateType=e;break}var i,r,s;if(!e)this.element.textContent=null!==(i=null===(r=(s=this.config.defaultFormats)[this.dateType])||void 0===r?void 0:r.call(s,this.property))&&void 0!==i?i:"",this.mavo.expressions.extract(this.element,null),(e=Mavo.DOMExpression.search(this.element,null))&&this.mavo.treeBuilt.then((()=>{e.update()}))}},dateTypes:{month:/^[Y\d]{4}-[M\d]{2}$/i,time:/^[H\d]{2}:[M\d]{2}/i,"datetime-local":/^[Y\d]{4}-[M\d]{2}-[D\d]{2} [H\d]{2}:[Mi\d]{2}/i,date:/^[Y\d]{4}-[M\d]{2}-[D\d]{2}$/i},defaultFormats:{date:e=>"[readable_datetime(".concat(e,', "days")]'),month:e=>"[readable_datetime(".concat(e,", 'months')] "),time:e=>"[time(".concat(e,")]"),time:e=>"[hour(".concat(e,", '00')]:[minute(").concat(e,", '00')]"),"datetime-local":function(e){return this.date(e)+" "+this.time(e)}},editor:function(){return{tag:"input",type:this.dateType}}},"circle@r":{default:!0,datatype:"number"},circle:{attribute:["cx","cy"],datatype:"number"},text:{default:!0,editType:"popup"},".mv-toggle":{default:!0,attribute:"aria-checked",datatype:"boolean",edit:function(){Mavo.revocably.setAttribute(this.element,"role","checkbox"),e.bind(this.element,"click.mavo:edit keyup.mavo:edit keydown.mavo:edit",(e=>{("click"==e.type||" "==e.key||"Enter"==e.key)&&("keydown"!=e.type&&(this.value=!this.value),e.preventDefault(),e.stopPropagation())}))},done:function(){Mavo.revocably.restoreAttribute(this.element,"role"),e.unbind(this.element,".mavo:edit")}}})}(Bliss,Bliss.$),function(e,t){Mavo.attributes.push("mv-list","mv-list-item","mv-order","mv-accepts","mv-initial-items");var i=Mavo.Collection=class extends Mavo.Node{constructor(t,i,r){var s;(super(t,i,r),this.firstItemElement=this.templateElement=e(Mavo.selectors.multiple,this.element),this.children=[],this.liveData=new Mavo.Data(this,[]),this.marker=document.createComment("mv-marker"),Mavo.data(this.marker,"collection",this),this.templateElement.after(this.marker),this.addButton=this.createAddButton(),this.templateElement.hasAttribute("mv-like")&&Mavo.warn("@mv-like is deprecated and will be removed in the next version of Mavo"),this.fromTemplate("templateElement","accepts","initialItems"))||(this.accepts=this.element.getAttribute("mv-accepts"),this.accepts=new Set(null===(s=this.accepts)||void 0===s?void 0:s.split(/\s+/)),this.initialItems=+(this.element.getAttribute("mv-initial-items")||1),this.templateElement=this.templateElement.cloneNode(!0));this.initializeData(),this.postInit(),Mavo.hooks.run("collection-init-end",this)}initializeData(){let e=this.add(this.firstItemElement,void 0,{silent:!0});if(0===this.initialItems)e?this.delete(e,{silent:!0}):this.firstItemElement.remove();else if(1<this.initialItems)for(let e=1;e<this.initialItems;e++)this.add()}createAddButton(){var i='button[class~="mv-add-'.concat(this.property,'"]'),r=this.parentGroup.element,s=t(i,r).filter((e=>!this.element.contains(e)&&!Mavo.data(e,"collection")))[0];return s?(s.compareDocumentPosition(this.marker)&Node.DOCUMENT_POSITION_FOLLOWING&&Mavo.setAttributeShy(this.templateElement,"mv-order","desc"),Mavo.revocably.remove(s)):s=e.create("button",{type:"button",className:"mv-ui",textContent:this.mavo._("add-item",this)}),s.classList.add("mv-add","mv-add-".concat(this.property)),Mavo.data(s,"collection",this),Mavo.setAttributeShy(s,"mv-action","add(".concat(this.property,")")),s}get length(){return this.children.length}getData(e={}){var t={context:this,options:e};return t.data=this.children.map((e=>e.getData(t.options))).filter((e=>null!==Mavo.value(e))),t.data=Mavo.subset(this.data,this.inPath,t.data),Mavo.hooks.run("node-getdata-end",t),t.data}createItem(e){var t;e||(e=this.templateElement.cloneNode(!0));var i=this.itemTemplate||(null===(t=this.template)||void 0===t?void 0:t.itemTemplate)||null,r=Mavo.Node.create(e,this.mavo,{collection:this,template:i,property:this.property,type:this.type});return this.itemTemplate||(this.itemTemplate=i||r),r}add(t,i,r={}){var s,n,a;if((t=t instanceof Node?Mavo.Node.get(t)||this.createItem(t):t||this.createItem()).collection!=this){t.collection&&(t.collection.splice({remove:t}),t.collection.dataChanged("delete"));let e=t.getData(),i=t.editing;t.element.remove(),t.destroy(),t=this.createItem(),i&&this.editItem(t),t.render(e)}void 0===i&&(i=this.bottomUp?0:this.length);var o=null!==(s=null===(n=this.children)||void 0===n||null===(a=n[i])||void 0===a?void 0:a.element)&&void 0!==s?s:this.marker;e.before(t.element,o);var l={context:this,item:t};return l.previousIndex=t.index,l.changed=this.splice({remove:l.item},{index:i,add:l.item}),this.mavo.expressions.active&&!r.silent&&requestAnimationFrame((()=>{l.changed.forEach((e=>{e.dataChanged(e==l.item&&void 0===l.previousIndex?"add":"move"),e.unsavedChanges=!0})),this.unsavedChanges=this.mavo.unsavedChanges=!0,this.mavo.expressions.update(l.item)})),Mavo.hooks.run("collection-add-end",l),l.item}splice(...e){e.forEach((e=>{void 0===e.index&&e.remove&&isNaN(e.remove)&&(e.index=this.children.indexOf(e.remove),e.remove=1)})),e.sort(((e,t)=>t.index-e.index));var t=[],i=[];e.forEach((e=>{-1<e.index&&(e.remove||e.add)&&(e.remove=e.remove||0,e.add=Mavo.toArray(e.add),i.push(...this.children.splice(e.index,+e.remove,...e.add)))})),i=new Set(i);for(let e=0;e<this.length;e++){let r=this.children[e];i.delete(r),r&&r.index!==e&&(r.index=e,t.push(r))}return i.forEach((e=>{var t;null===(t=e.expressions)||void 0===t||t.forEach((t=>{e.mavo.expressions.unregister(t)}))})),this.liveData.update(),t}async delete(t,{silent:i,undoable:r=!i,transition:s=!i,destroy:n=!r}={}){return t.element.classList.remove("mv-highlight"),this.splice({remove:t}),!i&&s&&(await e.transition(t.element,{opacity:0}),t.element.style.opacity=""),e.remove(t.element),i||(this.unsavedChanges=t.unsavedChanges=this.mavo.unsavedChanges=!0,t.collection.dataChanged("delete",{index:t.index})),r?this.mavo.setDeleted(t):n&&t.destroy(),t}move(e,t){var i=e.index+t+(0<t);i=Mavo.wrap(i,this.children.length+1),this.add(e,i)}editItem(e,t={}){var i;null===(i=e.preEdit)||void 0===i||i.resolve("abort");let r=t.immediately||Mavo.inView.is(e.element);return e.preEdit=Mavo.promise(r?Promise.resolve():Mavo.inView.when(e.element)),e.preEdit.then((i=>{if("abort"!==i)return e.itembar||(e.itembar=new Mavo.UI.Itembar(e)),e.itembar.add(),e.edit(t)}))}doneItem(e){var t,i;null===(t=e.itembar)||void 0===t||t.remove(),null===(i=e.preEdit)||void 0===i||i.resolve("abort")}edit(t={}){if(!1===super.edit())return!1;if(!this.addButton.parentNode){if(this.bottomUp&&this.children[0])var r=this.children[0].element;r=r||this.marker,Mavo.revocably.add(this.addButton,(t=>e[this.bottomUp?"before":"after"](t,r)))}return i.dragula.then((()=>{this.getDragula()})),Promise.all(this.children.map((e=>this.editItem(e,t))))}done(){return!1!==super.done()&&(Mavo.revocably.remove(this.addButton),void this.propagate((e=>this.doneItem(e))))}dataChanged(e,t={}){return t.element=t.element||this.marker,super.dataChanged(e,t)}dataRender(e,t={}){if(void 0!==e){e=null===e?[]:Mavo.toArray(e).filter((e=>null!==e));for(var i=!1,r=0;r<this.children.length;r++){var s=this.children[r];r<e.length?i=s.render(e[r],t)||i:(i=!0,this.delete(s,{silent:!0}),r--)}if(e.length>r){for(var n=document.createDocumentFragment(),a=r;a<e.length;a++){i=(s=this.createItem()).render(e[a],t)||i,this.children.push(s),s.index=a,n.appendChild(s.element);var o={context:this,item:s};Mavo.hooks.run("collection-add-end",o)}this.marker.before(n)}if(this.liveData.update(),e.length>r)for(a=r;a<this.children.length;a++)this.children[a].dataChanged("add");return i}}isCompatible(e){return e&&this.itemTemplate.constructor==e.itemTemplate.constructor&&(e===this||e.template==this||this.template==e||this.template&&this.template==e.template||e.accepts.has(this.property))}destroy(){var e;super.destroy(),null===(e=this.dragula)||void 0===e||e.destroy(),this.dragula=null,this.propagate("destroy")}getDragula(){if(this.dragula)return this.dragula;if(this.template){let e=this.template.getDragula().containers;return-1===e.indexOf(this.marker.parentNode)&&e.push(this.marker.parentNode),this.dragula=this.template.dragula||this.template.getDragula()}return this.dragula=dragula({containers:[this.marker.parentNode],isContainer:e=>!!this.accepts.size&&Array.from(e.childNodes).some((e=>{var t=i.get(e);return t&&this.accepts.has(t.property)})),moves:(e,t,i)=>i.classList.contains("mv-drag-handle")&&i.closest(Mavo.selectors.multiple)==e,accepts:function(e,t,r,s){var n;if(e.contains(t))return!1;var a=null!==(n=null==s?void 0:s.previousElementSibling)&&void 0!==n?n:t.lastElementChild,o=i.get(a)||i.get(s);if(!o)return!1;var l=Mavo.Node.get(e);return null==l?void 0:l.collection.isCompatible(o)}}),this.dragula.on("drop",(e=>{if(e.parentNode){var t=Mavo.Node.get(e),r=e.nextElementSibling,s=e.previousElementSibling,n=i.get(s)||i.get(r),a=Mavo.Node.get(s)||Mavo.Node.get(r);if(a&&a.collection!=n&&(a=null),!t.collection.isCompatible(n))return this.dragula.cancel(!0);var o=a?a.index+(a.element===s):n.length;n.add(t,o)}})),i.dragulas.push(this.dragula),this.dragula}getClosestCollection(){return this}static get(e){var t=Mavo.data(e,"collection");if(t)return t;var i=Mavo.Node.get(e);return(null==i?void 0:i.collection)||null}static async delete(e,t={}){if(0===(e=e.filter((e=>!!e.collection))).length)return[];if(1===e.length){return[await e[0].collection.delete(e[0],t)]}let i=new Mavo.BucketMap({arrays:!0}),r=new Set,s=e.map((async e=>{r.add(e.collection);let t=await e.collection.delete(e,{silent:!0,undoable:!1,destroy:!1});return t.unsavedChanges=!0,i.set(e.mavo,e),t})),n=await Promise.all(s);return!1!==t.silent&&(r.forEach((e=>{e.unsavedChanges=e.mavo.unsavedChanges=!0,e.dataChanged("delete")})),!1!==t.undoable&&i.forEach(((e,t)=>{t.setDeleted(...e)}))),n}};e.Class(i,{lazy:{bottomUp:function(){return/^desc\b/i.test(this.element.getAttribute("mv-order"))}},static:{dragulas:[],lazy:{dragula:()=>e.include(self.dragula,"https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js")}}})}(Bliss,Bliss.$),Bliss,Bliss.$,Mavo.ImplicitCollection=class extends Mavo.Node{constructor(e,t,i){super(e,t,i),this.children=[],this.liveData=new Mavo.Data(this,[]),this.add(e),this.postInit(),Mavo.hooks.run("implicit-collection-init-end",this)}get length(){return this.children.length}getData(e={}){var t={context:this,options:e,data:[]};if(this.children.forEach((i=>{i.isDataNull()||t.data.push(i.getData(e))})),this.data){var i=Mavo.toArray(Mavo.subset(this.data,this.inPath));i.length>t.data.length&&(t.data=t.data.concat(i.slice(t.data.length)))}return Array.isArray(t.data)&&1>=t.data.length&&(t.data=1===t.data.length?t.data[0]:null),t.data=Mavo.subset(this.data,this.inPath,t.data),Mavo.hooks.run("node-getdata-end",t),t.data}add(e){var t,i,r,s=Mavo.Node.create(e,this.mavo,{collection:this,template:null!==(t=null===(i=this.template)||void 0===i||null===(r=i.children)||void 0===r?void 0:r[this.length])&&void 0!==t?t:null,property:this.property,type:this.type});return s.index=this.length,this.children.push(s),this.liveData.update(),s}edit(e={}){return!1!==super.edit()&&Promise.all(this.children.map((t=>t.edit(e))))}dataRender(e,t={}){if(void 0!==e){var i=(e=null===e?[]:Mavo.toArray(e).filter((e=>null!==e))).length!==this.liveData.length;this.children.forEach(((r,s)=>{var n,a;return i=null!==(n=r.render(null===(a=e)||void 0===a?void 0:a[s],t))&&void 0!==n?n:i}))}this.liveData.update()}},function(e,t){var i=Mavo.UI.Itembar=class{constructor(r){var s;if(this.item=r,this.element=t('.mv-item-bar:is(:not([mv-rel]), [mv-rel="'.concat(this.item.property,'"])'),this.item.element).filter((e=>e.closest(Mavo.selectors.multiple)==this.item.element&&!Mavo.data(e,"item")))[0],!this.element&&null!==(s=this.item.template)&&void 0!==s&&s.itembar)this.element=this.item.template.itembar.element.cloneNode(!0),this.dragHandle=e(".mv-drag-handle",this.element)||this.item.element;else{this.element=this.element||e.create({className:"mv-item-bar mv-ui"}),this.template=this.element.getAttribute("mv-item-bar")||this.item.element.getAttribute("mv-item-bar")||this.collection.element.getAttribute("mv-item-bar")||"";let t=Object.assign({},i.controls);t.move={...t.move,optional:this.item instanceof Mavo.Primitive},this.controls=Mavo.UI.Bar.getControls(this.template,t),e.set(this.element,{"mv-rel":this.item.property,contents:this.controls.map((t=>{let r=i.controls[t],s=e(".mv-".concat(t),this.element);return e.create(r.create.call(this,s))}))}),this.dragHandle=e(".mv-drag-handle",this.element)||this.item.element}this.element.setAttribute("hidden",""),e.bind([this.item.element,this.element],"focusin mouseover",this),e.bind(this.element,{mouseenter:()=>{this.item.element.classList.add("mv-highlight")},mouseleave:()=>{this.item.element.classList.remove("mv-highlight")}}),this.dragHandle.addEventListener("keydown",(e=>{e.target===this.dragHandle&&this.item.editing&&37<=e.keyCode&&40>=e.keyCode&&(this.collection.move(this.item,38>=e.keyCode?-1:1),e.stopPropagation(),e.preventDefault(),e.target.focus())})),this.dragHandle!==this.item.element&&this.dragHandle.addEventListener("click",(e=>e.target.focus())),Mavo.data(this.element,"item",this.item)}get collection(){return this.item.collection}get mavo(){return this.item.mavo}destroy(){this.hide()}show(t){i.visible.forEach((e=>{e!=this&&(!this.sticky||e.sticky)&&(clearTimeout(e.hideTimeout),e.hide(t,i.DELAY))})),i.visible.add(this),(this.element.hasAttribute("hidden")||t&&!this.sticky)&&(this.element.removeAttribute("hidden"),this.sticky=this.sticky||t,e.bind([this.item.element,this.element],"focusout mouseleave",this))}hide(t,r=0){(!this.sticky||t)&&(r?this.hideTimeout=setTimeout((()=>this.hide(t)),r):(this.element.setAttribute("hidden",""),e.unbind([this.item.element,this.element],"focusout mouseleave",this),this.sticky=!1,i.visible.delete(this)))}handleEvent(e){var t=-1===e.type.indexOf("mouse");this.isWithinItem(e.target)&&(clearTimeout(this.hideTimeout),-1<["mouseleave","focusout","blur"].indexOf(e.type)?!this.isWithinItem(e.relatedTarget)&&this.hide(t,i.DELAY):(this.show(t),e.stopPropagation()))}isWithinItem(e){if(!e)return!1;var t=e.closest(".mv-item-bar");return t?t===this.element:e.closest(Mavo.selectors.item)===this.item.element}add(){if(!this.element.parentNode&&!Mavo.revocably.add(this.element)){var t=this.item.element.nodeName.toLowerCase();if(t in i.container)var r=e(i.container[t],this.item.element);(r||this.item.element).appendChild(this.element)}this.dragHandle==this.item.element&&this.item.element.classList.add("mv-drag-handle")}remove(){Mavo.revocably.remove(this.element),this.dragHandle==this.item.element&&this.item.element.classList.remove("mv-drag-handle")}};e.Class(i,{live:{sticky:function(e){this.element.classList.toggle("mv-sticky",e)}},static:{DELAY:100,visible:new Set,container:{details:"summary"},controls:{delete:{create(t){let i=t||e.create("button",{type:"button",title:this.mavo._("delete-item",this.item),className:"mv-delete"});return Mavo.setAttributeShy(i,"mv-action","delete($item)"),i}},add:{create(t){let i=this.collection.bottomUp,r="$item".concat(i?", $index + 1":""),s=t||e.create("button",{type:"button",title:this.mavo._("add-item-".concat(i?"after":"before"),this.item),className:"mv-add"});return Mavo.setAttributeShy(s,"mv-action","if($cmd, add($item, ".concat(r,"), add(").concat(r,"))")),s}},move:{create(t){let i=t||e.create("button",{type:"button",title:this.mavo._("drag-to-reorder",this.item),className:"mv-move"});return i.classList.add("mv-drag-handle"),i}}}}})}(Bliss,Bliss.$),function(){var e=Mavo.Expression=class{constructor(e,t={}){this.options=t,this.expression=e}eval(e=Mavo.Data.stub){if(Mavo.hooks.run("expression-eval-beforeeval",this),this.function instanceof Error)return this.function;try{return this.function(e)}catch(t){return this.error("Something went wrong with the expression ".concat(this.expression),t.message,"Data was: ".concat(JSON.stringify(e))),Mavo.hooks.run("expression-eval-error",{context:this,error:t}),t}}error(e,...t){t=t.join("\n")}toString(){return this.expression}changedBy(t){return e.changedBy(this.identifiers,t)}};Bliss.Class(e,{live:{expression:function(e){try{this.function=Mavo.Script.compile(e,this.options)}catch(t){return this.error("There is something wrong with the expression ".concat(e),t.message,"Not an expression? See https://mavo.io/docs/expressions/#disabling-expressions for information on how to disable expressions."),Mavo.hooks.run("expression-compile-error",{context:this,error:t}),this.function=t,e}if(this.ast=this.options.ast,delete this.options.ast,this.ast){let e=new Set;Mavo.Script.walk(this.ast,((t,i)=>{"Identifier"===t.type&&"callee"!==i?e.add(t.name):"MemberExpression"===t.type&&(t.object.name&&e.add(t.object.name),e.add(t.property.name))})),this.identifiers=[...e]}}}}),e.Syntax=class{constructor(e,t){this.start=e,this.end=t,this.regex=RegExp("".concat(Mavo.escapeRegExp(e),"([\\S\\s]*?)").concat(Mavo.escapeRegExp(t)),"gi")}test(e){return this.regex.lastIndex=0,this.regex.test(e)}tokenize(e){var t,i=[],r=0;for(this.regex.lastIndex=0;null!==(t=this.regex.exec(e));)t.index>r&&i.push(e.substring(r,t.index)),r=this.regex.lastIndex,/\S/.test(t[1])?i.push(new Mavo.Expression(t[1])):i.push(t[0]);return r<e.length&&i.push(e.substring(r)),i}static create(t){if(t){var i=t.getAttribute("mv-expressions");if(i)return i=i.trim(),/\s/.test(i)?new e.Syntax(...i.split(/\s+/)):e.Syntax.ESCAPE}}},e.Syntax.ESCAPE=-1,e.Syntax.default=new e.Syntax("[","]")}(),function(e){const t=Element.prototype.getAttribute;var i=Mavo.DOMExpression=e.Class({async constructor(e={}){var r;this.mavo=e.mavo,this.template=(null===(r=e.template)||void 0===r?void 0:r.template)||e.template;for(let t of["item","path","syntax","fallback","attribute","originalAttribute","expression","parsed","identifiers"])this[t]=void 0===e[t]&&this.template?this.template[t]:e[t];if(this.node=e.node,this.node||(this.node=Mavo.elementPath(this.item.element,this.path)),this.element=this.node,this.attribute=this.attribute||null,Mavo.hooks.run("domexpression-init-start",this),/^mv-(value$|attr-)/.test(this.attribute)){var s;this.originalAttribute=this.attribute,"mv-value"==this.attribute?this.attribute=Mavo.Primitive.getValueAttribute(this.element):(this.attribute=this.attribute.replace("mv-attr-",""),["http://www.w3.org/2000/svg","http://www.w3.org/1998/Math/MathML"].includes(this.element.namespaceURI)&&(this.attribute=Mavo.getProperAttributeCase(this.element,this.attribute))),null!==(s=this.fallback)&&void 0!==s||(this.fallback=Mavo.Primitive.getValue(this.element,{attribute:this.attribute}));let e=this.element.getAttribute(this.originalAttribute);this.element.removeAttribute(this.originalAttribute),this.parsed=[new Mavo.Expression(e)],this.expression=e}if(3===this.node.nodeType&&this.element===this.node&&(this.element=this.node.parentNode,(!this.node.parentNode.children.length||this.attribute)&&(this.element.normalize(),(!this.node.parentNode||this.attribute)&&(this.node=this.element))),"string"!=typeof this.expression){if(this.attribute){let e=t.call(this.node,this.attribute);this.expression=(e||"").trim()}else{var n,a;if(this.node.normalize(),1===this.node.childNodes.length&&3===(null===(n=this.node)||void 0===n||null===(a=n.firstChild)||void 0===a?void 0:a.nodeType)){var o=this.node.firstChild.textContent.match(/^\s*|\s*$/g);o[1]&&(this.node.firstChild.splitText(this.node.firstChild.textContent.length-o[1].length),this.node.after(this.node.lastChild)),o[0]&&(this.node.firstChild.splitText(o[0].length),this.node.parentNode.insertBefore(this.node.firstChild,this.node))}this.expression=this.node.textContent}this.parsed=this.template?this.template.parsed:this.syntax.tokenize(this.expression)}this.oldValue=this.value=this.parsed.map((e=>e instanceof Mavo.Expression?"":e)),this.identifiers=this.identifiers||this.parsed.flatMap((e=>e.identifiers||[])),i.special.add(this),Mavo.hooks.run("domexpression-init-end",this),i.elements.set(this.element,[...i.elements.get(this.element)||[],this]),await this.mavo.treeBuilt,this.template||this.item||(this.item=Mavo.Node.getClosestItem(this.element)),"mv-value"==this.originalAttribute&&this.mavoNode&&this.mavoNode==this.item.collection&&this.item.expressions.delete(this),this.mavo.expressions.register(this),Mavo.hooks.run("domexpression-init-treebuilt",this)},destroy:function(){i.special.delete(this),this.mavo.expressions.unregister(this)},get isDynamicObject(){return"mv-value"==this.originalAttribute&&this.mavoNode&&!(this.mavoNode instanceof Mavo.Primitive)},changedBy:function(e){return this.isDynamicObject?!e||!this.mavoNode.contains(e.node):Mavo.Expression.changedBy(this.identifiers,e)},update:function(e){if(!1!==this.active){var t={context:this},i=t;if(this.item)var r=this.isDynamicObject?this.item.parent:this.item,s=this.data=r.getLiveData();else s=void 0===this.data?Mavo.Data.stub:this.data;Mavo.hooks.run("domexpression-update-start",t),this.oldValue=this.value;var n=!1;t.value=this.value=this.parsed.map(((e,t)=>{if(e instanceof Mavo.Expression){let a=Mavo.value(this.oldValue[t]);var r={context:this,expr:e,parentEnv:i,oldValue:a};Mavo.hooks.run("domexpression-update-beforeeval",r),r.value=Mavo.value(r.expr.eval(s)),Mavo.hooks.run("domexpression-update-aftereval",r),r.value instanceof Error&&(r.value=void 0===this.fallback?this.syntax.start+r.expr.expression+this.syntax.end:this.fallback),(void 0===r.value||null===r.value)&&(r.value="");let o=Mavo.value(r.value);return this.evaluated&&"object"!=typeof o&&o===a||(n=!0),this.evaluated=!0,r.value}return e})),(n||null!=e&&e.force)&&(t.value=1===t.value.length?t.value[0]:t.value.map((e=>Mavo.Primitive.format(e,{attribute:this.attribute,element:this.element}))).join(""),this.output(t.value),Mavo.hooks.run("domexpression-update-end",t))}},output:function(e){this.mavoNode?(Mavo.in(Mavo.isProxy,e)&&(e=Mavo.clone(e)),this.mavoNode.render(e,{live:!0})):(this.node.nodeType===Node.TEXT_NODE&&!this.node.parentNode&&(this.node=this.element),Mavo.Primitive.setValue(this.node,e,{attribute:this.attribute}))},live:{item:function(e){e&&this._item!=e&&(this._item&&this._item.expressions.delete(this),e.expressions=e.expressions||new Set,e.expressions.add(this))}},static:{elements:new WeakMap,search:function(e,t){if(null===e)return e;t&&!e.ownerDocument.xmlVersion&&(t=t.toLowerCase());var r=i.elements.get(e)||[];return 1<arguments.length?r.length&&r.filter((e=>e.attribute===t))[0]||null:r},special:{add:function(e,t){if(t){var i=this.vars[t],r=-1<e.identifiers.indexOf(t),s=t.startsWith("$")&&-1<e.identifiers.indexOf(t.substr(1));i&&(r||s)&&(i.all=i.all||new Set,i.all.add(e),1===i.all.size?i.observe():!i.all.size&&i.unobserve())}else for(var t in this.vars)this.add(e,t)},delete:function(e,t){if(t){var i=this.vars[t];i.all=i.all||new Set,i.all.delete(e),i.all.size||i.unobserve()}else for(var t in this.vars)this.delete(e,t)},update:function(){var e;null===(e=this.update)||void 0===e||e.call(this,...arguments),this.all.forEach((e=>e.update()))},event:function(t,{type:r,update:s,target:n=document}={}){this.vars[t]={observe:function(){this.callback=this.callback||i.special.update.bind(this),e.bind(n,r,this.callback)},unobserve:function(){e.unbind(n,r,this.callback)}},s&&(this.vars[t].update=function(e){Mavo.Functions[t]=s(e)})},vars:{$now:{observe:function(){var e=()=>{i.special.update.call(this),this.timer=requestAnimationFrame(e)};this.timer=requestAnimationFrame(e)},unobserve:function(){cancelAnimationFrame(this.timer)}}}}}});i.special.event("$mouse",{type:"mousemove",update:function(e){return{x:e.clientX,y:e.clientY}}}),i.special.event("$hash",{type:"hashchange",target:window})}(Bliss,Bliss.$),function(e,t){Mavo.attributes.push("mv-expressions");var i=Mavo.Expressions=e.Class({async constructor(e){this.mavo=e,this.active=!0,this.expressions=new Set,this.identifiers={};var t=Mavo.Expression.Syntax.create(this.mavo.element.closest("[mv-expressions]"))||Mavo.Expression.Syntax.default;this.traverse(this.mavo.element,void 0,t),this.scheduled={},await this.mavo.treeBuilt,this.expressions=new Set,this.update()},register:function(e){var t=this.identifiers;e.registeredApp=e.registeredApp||new Set,e.identifiers.forEach((i=>{t[i]instanceof Set||(t[i]=new Set),t[i].add(e),Mavo.all[i]instanceof Mavo&&Mavo.all[i]!==this.mavo&&!e.registeredApp.has(i)&&(e.registeredApp.add(i),Mavo.all[i].expressions.register(e))}))},unregister:function(e){var t=this.identifiers;e.identifiers.forEach((i=>{t[i]&&t[i].delete(e),i in Mavo.all&&"undefined"!=typeof domexpresssion&&Mavo.all[i].expressions.unregister(domexpresssion)}))},updateThrottled:function(e){if(this.active){var t=this.scheduled[e.action]=this.scheduled[e.action]||new Set;e.node.template?!t.has(e.node.template)&&(setTimeout((()=>{t.delete(e.node.template),this.update(e)}),i.THROTTLE),t.add(e.node.template)):requestAnimationFrame((()=>this.update(e)))}},update:function(e){if(this.active){var t,i;if(e instanceof Mavo.Node)i=e;else if(e instanceof Element)t=e.closest(Mavo.selectors.item),i=Mavo.Node.get(t);else{if(e){var r={updated:new Set};if(this.updateByIdThrottled(e.property,e,r),"propertychange"==e.action){var s;null!==(s=e.node)&&void 0!==s&&s.path&&this.updateByIdThrottled(e.node.path,e,r)}else{this.updateById(Object.keys(Mavo.Data.special),e,r);var n=e.node.collection||e.node;this.updateById(n.properties,e,r)}return}i=this.mavo.root}i.walk((t=>{var i;return!!t.expressionsEnabled&&void(null===(i=t.expressions)||void 0===i||i.forEach((t=>{e&&t.mavoNode===e||t.update()})))}))}},updateByIdThrottled:function(e,t,r){if(e)if(e.forEach)e.forEach((e=>this.updateByIdThrottled(e,t,r)));else{var s=this.scheduledIds=this.scheduledIds||new Set;s.has(e)||(setTimeout((()=>{s.delete(e),this.updateById(e,t,r)}),i.THROTTLE),s.add(e))}},updateById:function(e,t,i){if(e.forEach)e.forEach((e=>this.updateById(e,t,i)));else{var r=this.identifiers[e];r&&r.forEach((e=>{"mv-value"==e.originalAttribute&&e.mavoNode&&!(e.mavoNode instanceof Mavo.Primitive)&&e.mavoNode.contains(t.node)||!i.updated.has(e)&&e.update()}))}},extract:function(e,t,r,s=Mavo.Expression.Syntax.default){let n=null==t?void 0:t.name;(i.directives.some((e=>{var t;return(null===(t=e.test)||void 0===t?void 0:t.call(e,n))||e===n}))||s!==Mavo.Expression.Syntax.ESCAPE&&s.test(t?t.value:e.textContent))&&(void 0===r&&(r=Mavo.elementPath(e.closest(Mavo.selectors.scope),e)),this.expressions.add(new Mavo.DOMExpression({node:e,syntax:s,path:r,attribute:n,mavo:this.mavo})))},traverse:function(e,r=[],s){if(8!==e.nodeType)if(3===e.nodeType)this.extract(e,null,r,s);else{var n,a;e.normalize(),s=Mavo.Expression.Syntax.create(e)||s,e.matches(Mavo.selectors.scope)&&(r=[]);let u=new Set([...i.skip,...null!==(n=null===(a=e.getAttribute("mv-expressions-ignore"))||void 0===a?void 0:a.trim().split(/\s*,\s*/))&&void 0!==n?n:[]]),h=new Set(e.getAttributeNames());for(let e of h)if(u.has(e))h.delete(e);else if(e.startsWith("mv-attr-")){let t=e.replace("mv-attr-","");h.delete(t)}for(let t of h)this.extract(e,e.attributes[t],r,s);var o=-1,l=0;e.matches("script:not([mv-expressions])")||t(e.childNodes).forEach((e=>{if(1==e.nodeType?(l=0,o++):l++,1==e.nodeType||3==e.nodeType){var t=0<l?"".concat(o,".").concat(l):o;this.traverse(e,[...r||[],t],s)}}))}},static:{directives:["mv-value",/^mv\-attr\-/],skip:["mv-expressions","mv-action"],THROTTLE:50,directive:function(e,t){i.directives.push(e),Mavo.attributes.push(e),Mavo.Plugins.register(e,t)}}})}(Bliss,Bliss.$),function(e,t){Mavo.Expressions.directive("mv-if",{extend:{Primitive:{live:{hidden:function(e){this._hidden!==e&&(this._hidden=e,this.liveData.update(),this.dataChanged())}}},DOMExpression:{lazy:{childProperties:function(){var e=t(Mavo.selectors.property,this.element).filter((e=>e.closest("[mv-if]")==this.element)).map((e=>Mavo.Node.get(e)));return this.element.addEventListener("mv-change",(e=>{requestAnimationFrame((()=>{this.element.parentNode||this.item.element.dispatchEvent(e)}))})),e}}}},hooks:{"domexpression-init-start":function(){"mv-if"!=this.attribute||(!Mavo.Node.prototype.fromTemplate.call(this,"parsed","expression")&&(this.expression=this.element.getAttribute("mv-if"),this.parsed=[new Mavo.Expression(this.expression)],this.expression=this.syntax.start+this.expression+this.syntax.end),this.parentIf=this.element.parentNode&&Mavo.DOMExpression.search(this.element.parentNode.closest("[mv-if]"),"mv-if"),this.parentIf&&(this.parentIf.childIfs=(this.parentIf.childIfs||new Set).add(this)))},"domexpression-update-end":async function(){if("mv-if"===this.attribute){var e,t,i=this.value[0],r=this.oldValue[0];if(await this.item.mavo.treeBuilt,this.parentIf){var s=this.parentIf.value[0];this.value[0]=i=i&&s}if(!1!==s&&(i?Mavo.revocably.add(this.element):this.element.parentNode&&Mavo.revocably.remove(this.element,"mv-if")),i!==r)null===(e=this.childProperties)||void 0===e||e.forEach((e=>e.hidden=!i)),null===(t=this.childIfs)||void 0===t||t.forEach((e=>e.update()))}},"node-isdatanull":function(e){e.result=e.result||this.hidden&&e.options.live}}})}(Bliss,Bliss.$),function(e,t){var i=Math.round,r=Math.floor,s=Math.abs,n=Math.min;function a(e=""){return(e=t(e))||0===e?e+"":""}function o(e){return null===(e=Mavo.value(e))||!1===e||""===e}function l(e){return!t(e)}let u={numbers:(e,i)=>(e=Array.isArray(e)?e:i?$$(i):[e]).filter((e=>!isNaN(e)&&""!==t(e)&&null!==t(e))).map((e=>+e)),postProcess(t){var i,r=t.multiValued;if(!0===r||2===(null==r?void 0:r.length)?i=(...e)=>{var i=r[0]||0,s=r[1]||1;return Mavo.Script.binaryOperation(e[i],e[s],{scalar:(r,n)=>(i in e&&(e[i]=r),s in e&&(e[s]=n),t(...e)),...t})}:t.isAggregate&&(i=function(e){if(Mavo.in(Mavo.groupedBy,e))return e.map((e=>i(e.$items)));var r=t.call(this,...arguments);return void 0===r?e:r}),i&&(e.extend(i,t),i.original=t),t.alias)for(let e of Mavo.toArray(t.alias))Mavo.Functions[e]=i||t;return i},deprecatedFunction:(e,t,i)=>function(...r){var s;return null!==(s=i)&&void 0!==s||(i=Mavo.Functions[e]),Mavo.warn("".concat(t,"() is deprecated and will be removed in the next version of Mavo. Please use ").concat(e,"() instead.")),i(...r)}},h=Mavo.Functions={operators:{"=":"eq"},get:function(e,i,...r){if(1>=arguments.length)return e;let s;i=t(i);let n=Mavo.getCanonicalProperty(e,i);if(void 0!==n)s=e[n];else{if(!(Array.isArray(e)&&i&&isNaN(i)))return null;s=e.map((e=>h.get(e,i)))}return 0<r.length?h.get(s,...r):s},map:function(e,t){return Array.isArray(e)?e.map((e=>h.get(e,t))):e?h.get(e,t):void 0},url:(e,...t)=>{if(void 0===e)return location.href;t=Object.assign({},...t);let{url:i=location,type:r,case_sensitive:s,multiple:n}=t;if(e){if(i=new URL(i,"https://mavo.io"),"query"===r||!r){let t=i.searchParams,r=i.searchParams.getAll(e);if(0===r.length&&!s){r=[...t.keys()].filter((t=>t.toLowerCase()===e.toLowerCase())).flatMap((e=>t.getAll(e)))}if(0<r.length)return n?r:r[0]}if("path"===r||!r){let t=i.pathname.split("/"),r=s?t.indexOf(e):t.findIndex((t=>t.toLowerCase()===e.toLowerCase()));if(-1<r){var a;let e=null!==(a=t[r+1])&&void 0!==a?a:"";return e&&(e=decodeURIComponent(e)),n?Mavo.toArray(e):e}}}return n?[]:null},first:(e,t)=>{if(void 0===t&&(t=e,e=void 0),void 0===t)return null;if(!Array.isArray(t))return void 0===e?t:[t];if(0>e)return h.last(s(e),t);for(var i=[],n=void 0===e?1:r(e),a=0;a<t.length&&i.length<n;a++){let e=Mavo.value(t[a]);null!==e&&""!==e&&i.push(t[a])}return void 0===e?void 0===i[0]?null:i[0]:i},last:(e,t)=>{if(void 0===t&&(t=e,e=void 0),void 0===t)return null;if(!Array.isArray(t))return void 0===e?t:[t];if(0>e)return h.first(s(e),t);for(var i=[],n=void 0===e?1:r(e),a=t.length-1;0<=a&&i.length<n;a--){let e=Mavo.value(t[a]);null!==e&&""!==e&&i.push(t[a])}return void 0===e?void 0===i[0]?null:i[0]:i},condense:e=>h.first(e.length,e),unique:function(e){return Array.isArray(e)?[...new Set(e.map(t))]:e},intersects:function(e,i){if(e&&i){var r=new Set(Mavo.toArray(i).map(t));return!(e=Mavo.toArray(e).map(t)).every((e=>!r.has(e)))}},intersection:function(e,i){if(!e||!i)return null;e=Mavo.toArray(e),i=Mavo.toArray(i);let r=new Set(i.map(t));return e.filter((e=>r.has(Mavo.value(e))))},sum:e.extend((function(e){return u.numbers(e,arguments).reduce(((e,t)=>+e+(+t||0)),0)}),{isAggregate:!0}),average:e.extend((function(e){return(e=u.numbers(e,arguments)).length&&h.sum(e)/e.length}),{isAggregate:!0,alias:"avg"}),median:e.extend((function(e){var t=Math.ceil,i=((e=u.numbers(e,arguments).sort(((e,t)=>e-t))).length-1)/2;return[m1,m2]=[e[r(i)],e[t(i)]],(m1+m2)/2||0}),{isAggregate:!0}),min:e.extend((function(e){return n(...u.numbers(e,arguments))}),{isAggregate:!0}),max:e.extend((function(e){return Math.max(...u.numbers(e,arguments))}),{isAggregate:!0}),atan2:e.extend(((e,t)=>Math.atan2(e,t)),{multiValued:!0,rightUnary:e=>e,default:1}),pow:e.extend(((e,t)=>Math.pow(e,t)),{multiValued:!0,default:1}),imul:e.extend(((e,t)=>Math.imul(e,t)),{multiValued:!0,default:1}),count:e.extend((function(e){return Mavo.toArray(e).filter((e=>!o(e))).length}),{isAggregate:!0}),reverse:function(e){return Mavo.toArray(e).slice().reverse()},round:e.extend(((e,t)=>l(e)||l(t)||!isFinite(e)?i(e):+(+e).toLocaleString("en-US",{useGrouping:!1,maximumFractionDigits:t})),{multiValued:!0,rightUnary:e=>e,default:0}),ordinal:e.extend((e=>{if(o(e))return"";if(10>e||20<e)var t=["th","st","nd","rd","th"][e%10];return t||"th"}),{multiValued:!0,alias:"th"}),pluralize:e.extend((function(t,...i){if(o(t))return"";if(0===i.length)return t;let r=i.reduce(((t,i)=>(i=Mavo.value(i),"object"!==e.type(i)&&(i=t.one?Object.fromEntries(["zero","two","few","many","other"].map((e=>[e,i]))):{one:i}),Object.assign(t,i))),{}),s=r.lang||Mavo.locale,n=r[new Intl.PluralRules(s,{type:r.type||"cardinal"}).select(t)]||r.other||r.two||r.zero||r.few||r.many||r.one;return r.text_only?n:"ordinal"===r.type?"".concat(t).concat(n):"".concat(t," ").concat(n)}),{multiValued:!0,needsContext:!0}),digits:e.extend(((e,t,i)=>{if(void 0===i&&(i=t,t=void 0),isNaN(i))return null;var r=(i+"").split(".");return r[0]=r[0].slice(-e),void 0!==t&&r[1]&&(r[1]=r[1].slice(0,t)),(i=+r.join(".")).toLocaleString("en",{useGrouping:!1,minimumIntegerDigits:e,minimumFractionDigits:t,maximumFractionDigits:t||20})}),{multiValued:!0}),iff:function(e,i=e,r=null){return Array.isArray(e)?e.map(((e,s)=>{var a=t(e)?i:r;return Array.isArray(a)?a[n(s,a.length-1)]:a})):t(e)?i:r},group:(...e)=>Object.assign({},...e),list:(...e)=>e.flat(),random:e.extend(((e=0,t=100,i=1)=>{1==arguments.length&&(t=e,e=0);var s=Math.random();return r(s*((t-e)/i+1))*i+e}),{multiValued:!0}),range:(e,t,i)=>{void 0===i&&(void 0===t&&([e,t]=[0<=e?1:-1,e]),i=e<=t?1:-1);let s=r((t-e)/i+1);if(0>=s||!isFinite(s))return[e];let n=[];for(let t=0,r=e;t++<s;r+=i)n.push(r);return n},shuffle:e=>{if(Array.isArray(e)){for(var t=e.slice(),i=t.length-1;0<i;i--){var s=r(Math.random()*(i+1));[t[i],t[s]]=[t[s],t[i]]}return t}return e},sort(e,t=e,...i){var r;i=Object.assign({},...i);let s=Object.assign({numeric:!0},i),n=new Intl.Collator(i.lang||Mavo.locale,s);Array.isArray(t)||(t=h.get(e,t));let a=null===(r=i.order)||void 0===r?void 0:r.startsWith("desc"),o=e.map(((e,i)=>[e,t[i]]));return o=o.sort(((e,t)=>{let i=e[1],r=t[1];return n.compare(i,r)*(a?-1:1)})),o.map((e=>e[0]))},replace:e.extend(((e,t,i="",r=1)=>{if(!Mavo.value(e))return e;if(Array.isArray(e))return e.map((e=>h.replace(e,t,i)));for(var s,n=RegExp(Mavo.escapeRegExp(t),"g"),a=e,o=0;a!=s&&o++<r;)s=a,a=a.replace(n,i);return a}),{multiValued:!0}),len:e.extend((e=>a(e).length),{multiValued:!0}),contains:e.extend(((t,i)=>{let r,s=e.type(t);if("object"===e.type(i))return 0<=JSON.stringify(t).indexOf(JSON.stringify(i));if("object"!==s&&"array"!==s)return 0<=h.search(t,i);for(let e in t)if(r=h.contains(t[e],i),Array.isArray(r)&&(r=Mavo.Functions.or(r)),r)return!0;return r}),{multiValued:!0}),search:e.extend(((e,t)=>(e=a(e),t=a(t),e&&t?e.toLowerCase().indexOf(t.toLowerCase()):-1)),{multiValued:!0}),starts:e.extend(((e,t)=>0===h.search(a(e),a(t))),{multiValued:!0}),ends:e.extend(((e,t)=>{[e,t]=[a(e),a(t)];var i=h.search(e,t);return-1<i&&i===e.length-t.length}),{multiValued:!0}),join:function(e,t){return Mavo.toArray(e).filter((e=>!o(e))).join(a(t))},idify:e.extend((e=>a(e).normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s-]/g,"").trim().replace(/\s+/g,"-").toLowerCase()),{multiValued:!0}),readable:e.extend((e=>a(e).replace(/([a-z])([A-Z])(?=[a-z])/g,((e,t,i)=>t+" "+i.toLowerCase())).replace(/([a-z0-9])[_\/-](?=[a-z0-9])/g,"$1 ").replace(/^[a-z]/,(e=>e.toUpperCase()))),{multiValued:!0}),uppercase:e.extend((e=>a(e).toUpperCase()),{multiValued:!0}),lowercase:e.extend((e=>a(e).toLowerCase()),{multiValued:!0}),from:e.extend(((e,t)=>h.between(e,t)),{multiValued:!0}),from_last:e.extend(((e,t)=>h.between(e,t,"",!0)),{multiValued:!0}),fromlast:u.deprecatedFunction("from_last","fromlast"),to:e.extend(((e,t)=>h.between(e,"",t)),{multiValued:!0}),to_first:e.extend(((e,t)=>h.between(e,"",t,!0)),{multiValued:!0}),tofirst:u.deprecatedFunction("to_first","tofirst"),between:e.extend(((e,t,i,r)=>{[e,t,i]=[a(e),a(t),a(i)];let s=t?e[r?"lastIndexOf":"indexOf"](t):0,n=i?e[r?"indexOf":"lastIndexOf"](i):e.length;return-1===s||-1===n?"":r&&n<=s?e.slice(n+i.length,s):e.slice(s+t.length,n)}),{multiValued:!0}),phrase:e.extend((function(t,i,r){var s,n;2===arguments.length&&"string"===e.type(i)&&([r,i]=[i]);let a=r?Mavo.Locale.get(r):null!==(s=null==this||null===(n=this[Mavo.mavo])||void 0===n?void 0:n.locale)&&void 0!==s?s:Mavo.Locale.default;return a.phrase(t,i)}),{needsContext:!0}),filename:e.extend((e=>{var t;return null===(t=new URL(a(e),Mavo.base).pathname.match(/[^/]+?$/))||void 0===t?void 0:t[0]}),{multiValued:!0}),json:e=>Mavo.safeToJSON(e),split:e.extend(((e,t=/\s+/)=>e?(e=a(e)).split(t):[]),{multiValued:!0}),log:(...e)=>e[0],$mouse:{x:0,y:0},get $hash(){return location.hash.slice(1)},get $alt(){return!!h.$evt&&h.$evt.altKey},get $ctrl(){return!!h.$evt&&h.$evt.ctrlKey},get $shift(){return!!h.$evt&&h.$evt.shiftKey},get $cmd(){return!!h.$evt&&h.$evt[Mavo.superKey]},util:u};Mavo.ready.then((()=>{Object.getOwnPropertyNames(Mavo.Functions).forEach((e=>{var t=u.postProcess(Mavo.Functions[e]);t&&(Mavo.Functions[e]=t)})),Object.getOwnPropertyNames(Math).forEach((e=>{1!==Math[e].length||Mavo.Functions.hasOwnProperty(e)||(Mavo.Functions[e]=t=>Mavo.Script.unaryOperation(t,(t=>Math[e](t))))}))}))}(Bliss,Mavo.value),function(e,t,i,r=i.util){var s=Math.floor,n=Math.abs;function a(e){var t;e=(null===(t=e)||void 0===t?void 0:t.trim())||"";let i=Object.keys(o).reverse(),r={};do{p=i.shift(),r[p]=!0}while(!RegExp(p+"?").test(e)&&0<i.length);return"ms"==e&&(r.ms=!0),r}var o={seconds:1,minutes:60};o.hours=60*o.minutes,o.days=24*o.hours,o.weeks=7*o.days,o.months=30.4368*o.days,o.years=52*o.weeks;var l={year:e=>e.getFullYear(),month:e=>e.getMonth()+1,day:e=>e.getDate(),weekday:e=>e.getDay()||7,hour:e=>e.getHours(),minute:e=>e.getMinutes(),second:e=>e.getSeconds(),ms:e=>e.getMilliseconds()};for(let t in e.extend(i,{get $now(){return new Date},$startup:new Date,get $today(){return i.date(new Date)},year:e.extend((function(){return r.dateComponent("year",...arguments)}),{multiValued:!0}),month:e.extend((function(){return r.dateComponent("month",...arguments)}),{multiValued:!0}),week:()=>1e3*o.weeks,day:e.extend((function(){return r.dateComponent("day",...arguments)}),{multiValued:!0}),weekday:e.extend((function(){return r.dateComponent("weekday",...arguments)}),{multiValued:!0}),hour:e.extend((function(){return r.dateComponent("hour",...arguments)}),{multiValued:!0}),minute:e.extend((function(){return r.dateComponent("minute",...arguments)}),{multiValued:!0}),second:e.extend((function(){return r.dateComponent("second",...arguments)}),{multiValued:!0}),ms:e.extend((function(){return r.dateComponent("ms",...arguments)}),{multiValued:!0}),datetime:e.extend(((e,t,s)=>{var n;if(!(e=r.date(e)))return"";let l;void 0!==t&&(function(e){if(!e)return!1;if("ms"==e)return!0;let t=e.replace(/s$/,""),i=e.replace(/s?$/,"s");return t in o||i in o}(t)?[t,s]=[,t]:l=!0),null!==(n=s)&&void 0!==n||(s="minutes");let u=a(s),h=i.date(e,s);return u.hours?(h+=l?Mavo.value(t)?"T".concat(i.time(t,s)):"":"T".concat(i.time(e,s)),h):h}),{multiValued:!0}),date:e.extend(((e,t="days")=>{if(!(e=r.date(e)))return"";let s=a(t),n=[];return s.years&&n.push(i.year(e)),s.months&&n.push(i.month(e,"00")),s.days&&n.push(i.day(e,"00")),n.join("-")}),{multiValued:!0}),time:e.extend(((e,t="minutes")=>{if(!(e=r.date(e)))return"";let s=a(t),n="";return s.hours&&(n+=i.hour(e,"00")+":"+(s.minutes?i.minute(e,"00"):"00"),s.seconds&&(n+=":"+i.second(e,"00"),s.ms&&(n+="."+i.ms(e,"000")))),n}),{multiValued:!0}),readable_datetime:e.extend(((e,...t)=>{t=t.map((e=>"string"==typeof e||e instanceof String?{precision:e}:e));let r=a((t=Object.assign({},...t)).precision),s=t.month||r.days?"shortname":"long",n=[];return r.days&&n.push(i.day(e)),r.months&&n.push(i.month(e,s)),r.years&&n.push(i.year(e)),r.hours&&n.push(i.time(e,t.precision)),n.join(" ")}),{multiValued:!0}),localTimezone:-(new Date).getTimezoneOffset()}),i.msTo=(e,t)=>s(n(t)/(1e3*o[e]))||0,o)i[t]=e.extend((function(e){return 0===arguments.length?1e3*o[t]:i.msTo(t,e)}),{multiValued:!0});i.duration=e.extend((function(e,t){let r=0>e?-1:1;if(e=n(e),t&&isNaN(t)){let n="ms"==t?t:t.replace(/s?$/,""),a=t.replace(/s?$/,"s");if(!(a in o))throw new TypeError("Unknown duration unit ".concat(t,". Please use one of ").concat(Object.keys(o).join(", ")));let l=s(e/o[a]/1e3),u=1===l&&"ms"!==a?n:a;return r*l+" "+i.phrase.call(this,u)}(0==e||void 0===t)&&(t=1);let a=e,l=[];if(0==e)l=["0 ms"];else{let e=[...Object.keys(o).reverse(),"ms"];for(let n,u=0;n=e[u];u++){let e=n in o?1e3*o[n]:1,u=s(a/e);if(a%=e,0<u&&l.length<t){let e=1===u&&"ms"!==n?n.slice(0,-1):n;l.push(r*u+" "+i.phrase.call(this,e))}else if(0<l.length)break}}return 1===arguments.length?l[0]:l}),{needsContext:!0,multiValued:!0}),e.extend(i.util,{fixDateString:function(e){e=e.trim();var t=/^\d{4}-\d{2}(-\d{2})?/.test(e),r=-1<e.indexOf(":");return t||r?(e=t?e.replace(/^(\d{4}-\d{2})(?!-\d{2})/,"$1-01"):i.$today+" "+e,r?e=e.replace(/\-(\d{2})\s+(?=\d{2}:)/,"-$1T"):e+="T00:00:00",e=e.replace(/\s+/g,"")):null},dateComponent:function(e,t,s,n=Mavo.locale){if(1===arguments.length&&e+"s"in o)return i[e+"s"]();var a=r.date(t);if("year"===e){t=t&&t.match?t:t+"";var u=a?a.getFullYear()+"":(t.match(/\b[1-9]\d\d\b|\d+/)||[])[0]}if(!u&&!a)return"";u=u||l[e](a);return s?/^0+$/.test(s)?(u+"").padStart(s.length,"0").slice(-s.length):(s={name:"long",shortname:"short"}[s]||s,u=(u=a.toLocaleString(n,{[e]:s})).replace(/\u200e/g,"")):"year"===e?u:+u},date:function(i){var s;if(!(i=t(i)))return null;var n=new Date(i);if("string"!==e.type(i)||!isNaN(n)&&n+""==i)return n;if(null===(i=r.fixDateString(i)))return null;if(null===(s=i.match(/[+-]\d{2}:?\d{2}|Z$/))||void 0===s?void 0:s[0])i=new Date(i);else{var a=i.match(/\d+/g);i=new Date(a[0],(a[1]||1)-1,a[2]||1,a[3]||0,a[4]||0,a[5]||0,a[6]||0)}return isNaN(i)?null:i}})}(Bliss,Mavo.value,Mavo.Functions),function(e,t,i){var r=Math.max,s=Mavo.Script={$fn:self.Proxy?new Proxy({[Symbol.unscopables]:{undefined:!0}},{get:(e,t)=>{var i,r,s,n=null!==(i=null==t||null===(r=t.toLowerCase)||void 0===r?void 0:r.call(t))&&void 0!==i?i:t;return n in Mavo.Actions.Functions&&(s=Mavo.Actions.running?Mavo.Actions.Functions[n]:Mavo.Actions.nope),void 0===s&&(s=n in Mavo.Functions?Mavo.Functions[n]:Math[t]||Math[n]),s},has:(e,t)=>{var i=t.toLowerCase();return i in Mavo.Functions||i in Mavo.Actions.Functions||t in Math||i in Math}}):Mavo.Functions,addUnaryOperator:function(e,i){return i.symbol&&Mavo.toArray(i.symbol).forEach((t=>{s.unarySymbols[t]=e,jsep.addUnaryOp(t)})),e=>s.unaryOperation(e,(e=>i.scalar(t(e))))},unaryOperation:function(e,t){return Array.isArray(e)?e.map(t):t(e)},binaryOperation:function(e,t,i={}){var s;if(i.scalar="function"==typeof i?i:i.scalar,Array.isArray(t))if(Array.isArray(e)){s=[];var n=r(e.length,t.length),a=i.leftUnary||i.unary,o=i.rightUnary||i.unary,l=void 0===i.leftDefault?i.default:i.leftDefault,u=void 0===i.rightDefault?i.default:i.rightDefault;for(let r=0;r<n;r++)s[r]=!i.comparison||void 0!==e[r]&&void 0!==t[r]?void 0===e[r]?o?o(t[r]):i.scalar(l,t[r]):void 0===t[r]?a?a(e[r]):i.scalar(e[r],u):i.scalar(e[r],t[r]):i.default}else s=t.map((t=>i.scalar(e,t)));else s=Array.isArray(e)?e.map((e=>i.scalar(e,t))):i.scalar(e,t);return s},addBinaryOperator:function(e,r){return r.symbol&&Mavo.toArray(r.symbol).forEach((t=>{s.symbols[t]=e,r.precedence&&jsep.addBinaryOp(t,r.precedence)})),r.default=void 0===r.default?0:r.default,r.code||function(...e){1===e.length&&Array.isArray(e[0])&&(e=[...e[0]]),r.raw||(e=e.map(t));var n=!!r.comparison||e[0];for(let t=1;t<e.length;t++){let o=r.comparison?e[t-1]:n,l=e[t];Array.isArray(l)&&"number"==typeof r.default&&(l=i.numbers(l));var a=s.binaryOperation(o,l,r);n=r.comparison?s.binaryOperation(n,a,s.operators.and):a}return n}},symbols:{},unarySymbols:{},getOperatorName:(e,t)=>s[t?"unarySymbols":"symbols"][e]||e,isComparisonOperator:e=>{if(e){let t=s.operators[s.symbols[e]];return t&&t.comparison}},isStatic:e=>{if("Identifier"===e.type)return!1;for(let t of s.childProperties)if(e[t]&&"callee"!==t&&!s.isStatic(e[t]))return!1;return!0},operators:{not:{symbol:"!",scalar:e=>!t(e)},multiply:{scalar:(e,t)=>e*t,default:1,symbol:"*"},divide:{scalar:(e,t)=>e/t,rightUnary:e=>e,default:1,symbol:"/"},addition:{scalar:(e,t)=>{if(isNaN(e)||isNaN(t)){var r=i.date(e),s=i.date(t);if(r||s)return+r+ +s}return+e+ +t},symbol:"+"},plus:{scalar:e=>+e,symbol:"+"},subtract:{scalar:(e,t)=>{if(isNaN(e)||isNaN(t)){var r=i.date(e),s=i.date(t);if(r&&s)return r-s}return e-t},symbol:"-"},minus:{scalar:e=>-e,symbol:"-"},mod:{scalar:(e,t)=>{var i=e%t;return i+=0>i?t:0},symbol:"mod",precedence:10},lte:{comparison:!0,scalar:(e,t)=>([e,t]=s.getNumericalOperands(e,t),e<=t),default:!1,symbol:"<="},lt:{comparison:!0,scalar:(e,t)=>([e,t]=s.getNumericalOperands(e,t),e<t),default:!1,symbol:"<"},gte:{comparison:!0,scalar:(e,t)=>([e,t]=s.getNumericalOperands(e,t),e>=t),default:!1,symbol:">="},gt:{comparison:!0,scalar:(e,t)=>([e,t]=s.getNumericalOperands(e,t),e>t),default:!1,symbol:">"},eq:{comparison:!0,scalar:(e,t)=>e==t||Mavo.safeToJSON(e)===Mavo.safeToJSON(t),symbol:["=","=="],default:!1,precedence:7},neq:{comparison:!0,scalar:(e,t)=>e!=t&&Mavo.safeToJSON(e)!==Mavo.safeToJSON(t),symbol:["!="],default:!0,precedence:7},and:{scalar:(e,t)=>e&&t,default:!1,symbol:["&&","and"],precedence:2},or:{scalar:(e,t)=>e||t,default:!1,symbol:["||","or"],precedence:2},concatenate:{symbol:"&",default:"",scalar:(e,t)=>{var i,r;return""+(e=null!==(i=Mavo.value(e))&&void 0!==i?i:"")+(t=null!==(r=Mavo.value(t))&&void 0!==r?r:"")},precedence:10},keyvalue:{symbol:":",code:(...e)=>{for(var t=e.length-1,i=e[t];t--;)i={[e[t]]:i};return i},transformation:e=>{"Identifier"==e.left.type&&(e.left={type:"Literal",value:e.left.name,raw:JSON.stringify(e.left.name)})},precedence:4},filter:{symbol:"where",code:(e,...i)=>{for(let r of i)Array.isArray(e)?Array.isArray(r)?e=e.map(((e,i)=>t(r[i])?e:null)):(r=t(r),e="boolean"==typeof r?r?e:e.map((()=>null)):e.map((e=>e==r?e:null))):e=t(r)?e:null;return e},precedence:1,postFlattenTransformation:e=>{var t=e.arguments[0];for(let i=1;i<e.arguments.length;i++)s.isStatic(e.arguments[i])||(e.arguments[i]=Object.assign(s.parse("scope()"),{arguments:[t,e.arguments[i]]}))}},range:{symbol:"..",scalar:(e,t)=>Mavo.Functions.range(e,t),precedence:2,export:!1},has:{symbol:"in",code:function(i,...r){var s;return r.map((r=>{if(Array.isArray(r))var n=i=>{var s="object"===e.type(t(i))?Mavo.safeToJSON:t;return-1<r.map(s).indexOf(s(i))};else if("object"===e.type(r))n=e=>Mavo.in(t(e),r);else n=e=>Mavo.Functions.eq(e,r);var a=Mavo.Script.unaryOperation(i,n);s=void 0===s?a:Mavo.Functions.and(a,s)})),s},precedence:3},group_by:{symbol:"by",code:(t,i)=>{var r,s;t=Mavo.toArray(t);var n=(i=Mavo.toArray(i))[Mavo.as]||(null===(r=i[0])||void 0===r||null===(s=r[Mavo.toNode])||void 0===s?void 0:s.property),a=new Mavo.BucketMap({arrays:!0}),o=[];return o[Mavo.groupedBy]=!0,t.forEach(((e,t)=>{let r=t<i.length?Mavo.value(i[t]):null;a.set(r,e)})),Mavo.in(Mavo.route,t)&&(o[Mavo.route]=Object.assign({},t[Mavo.route])),a.forEach(((i,r)=>{var s={$value:r,[n||"$value"]:r,$items:i};Mavo.in(Mavo.route,t)&&(i[Mavo.route]=s[Mavo.route]=Object.assign({},t[Mavo.route]),s[Mavo.route]=e.each(i[Mavo.route],(()=>new Set(["$items"])))),o.push(s)})),Mavo.Data.proxify(o)},precedence:2},groupby:{code:i.deprecatedFunction("group_by","groupby"),precedence:2},as:{symbol:"as",code:(t,i)=>{if(void 0!==t&&"array"===e.type(t)&&void 0!==i){var r,s,n,a,o,l,u=t.slice();return Array.isArray(i)||void 0===(null==i||null===(r=i[Mavo.toNode])||void 0===r?void 0:r.property)?"string"===e.type(i)?(u[Mavo.as]=i,u):void 0!==(null===(s=i[0])||void 0===s||null===(n=s[Mavo.toNode])||void 0===n?void 0:n.property)?(u[Mavo.as]=null===(o=i[0])||void 0===o||null===(l=o[Mavo.toNode])||void 0===l?void 0:l.property,u):t:(u[Mavo.as]=null==i||null===(a=i[Mavo.toNode])||void 0===a?void 0:a.property,u)}return t},precedence:3}},getNumericalOperands:function(e,t){if(isNaN(e)||isNaN(t)){var r=i.date(e),s=i.date(t);if(r&&s)return[r,s]}return[e,t]},childProperties:["arguments","callee","left","right","argument","elements","test","consequent","alternate","object","property","body"],walk:function(e,t,i={},r,n){if(!i.type||e.type===i.type)var a=t(e,r,n);if(!i.ignore||-1===i.ignore.indexOf(e.type))if(Array.isArray(e))for(let n of e)s.walk(n,t,i,r,e);else s.childProperties.forEach((r=>{e[r]&&s.walk(e[r],t,i,r,e)}));return void 0!==a&&n&&(n[r]=a),a},serializers:{BinaryExpression:e=>"".concat(s.serialize(e.left,e)," ").concat(e.operator," ").concat(s.serialize(e.right,e)),UnaryExpression:e=>"".concat(e.operator).concat(s.serialize(e.argument,e)),CallExpression:e=>{e.callee;let t=e.callee,i=e,r="callee";for(;"MemberExpression"===t.type;)i=t,t=t.object,r="object";if("MemberExpression"===e.callee.type&&"Identifier"===e.callee.property.type&&"call"===e.callee.property.name&&e.callee.object,"Identifier"===t.type){var n=t.name;if("scope"===n)return s.serializeScopeCall(e.arguments);n in Mavo.Script.$fn&&(i[r]={type:"MemberExpression",computed:!1,object:{type:"Identifier",name:"$fn"},property:t})}var a=s.serialize(e.callee,e),o=e.arguments.map((t=>s.serialize(t,e)));return"".concat(a,"(").concat(o.join(", "),")")},ConditionalExpression:e=>"".concat(s.serialize(e.test,e),"? ").concat(s.serialize(e.consequent,e)," : ").concat(s.serialize(e.alternate,e)),MemberExpression:e=>{let t,i=e;do{if("CallExpression"===i.type&&i.callee===t)break;t=i}while(i=i.parent);if(i){var r=e.computed?"[".concat(s.serialize(e.property,e),"]"):".".concat(e.property.name);return"".concat(s.serialize(e.object,e)).concat(r)}i=e;let n,a,o=[];for(;"MemberExpression"===i.type;){let e=i.computed?s.serialize(i.property,i):'"'.concat(i.property.name,'"');o.push(e),a=i,n=i=i.object}return"$fn.get(".concat(s.serialize(n,a),", ").concat(o.reverse().join(", "),")")},ArrayExpression:e=>"[".concat(e.elements.map((t=>s.serialize(t,e))).join(", "),"]"),Literal:e=>{let t=e.raw[0];if("'"===t||'"'===t){let i=e.raw.slice(1,-1);return i=i.replace(/\r/g,"\\r").replace(/\n/g,"\\n"),i=i.replaceAll(t,"\\"+t),t+i+t}return e.raw},Identifier:e=>e.name,ThisExpression:()=>"this",Compound:e=>e.body.map((t=>s.serialize(t,e))).join(", ")},transformations:{BinaryExpression:e=>{var t,i;let r=s.getOperatorName(e.operator),n=s.operators[r];null===(t=n.transformation)||void 0===t||t.call(n,e);var a=e,o={type:"CallExpression",arguments:[],callee:{type:"Identifier",name:r}};if(n.comparison){let e=[];do{let t=s.getOperatorName(a.operator);e.unshift({comparison:t,operand:a.right}),a=a.left}while(!1!==n.flatten&&s.isComparisonOperator(a.operator));let t=!1;for(let i=0;i<e.length-1;i++)if(e[i].comparison!=e[i+1].comparison){t=!0;break}o.arguments.push(a),t?(o.callee.name="compare",e.forEach((e=>{o.arguments.push({type:"Literal",value:e.comparison,raw:'"'.concat(e.comparison,'"')}),o.arguments.push(e.operand)}))):e.forEach((e=>{o.arguments.push(e.operand)}))}else{do{o.arguments.unshift(a.right),a=a.left}while(!1!==n.flatten&&a.right&&s.getOperatorName(a.operator)===r);o.arguments.unshift(a)}return null===(i=n.postFlattenTransformation)||void 0===i||i.call(n,o),o},UnaryExpression:e=>{var t=s.getOperatorName(e.operator,!0);if(t)return{type:"CallExpression",arguments:[e.argument],callee:{type:"Identifier",name:t}}},CallExpression:e=>{if("Identifier"==e.callee.type)if("if"==e.callee.name){e.callee.name="iff";var t=e.arguments[0];for(let i=1;i<e.arguments.length;i++)2==i&&(t=s.parse("not()")).arguments.push(e.arguments[0]),s.walk(e.arguments[i],(e=>{var i=e.callee.name;Mavo.Actions.Functions.hasOwnProperty(i)&&!/if$/.test(i)&&(e.callee.name+="if",e.arguments.unshift(t))}),{type:"CallExpression"})}else if("delete"==e.callee.name)e.callee.name="clear";else{var i=Mavo.Functions[e.callee.name];i&&i.needsContext&&(e.callee={type:"MemberExpression",computed:!1,object:e.callee,property:{type:"Identifier",name:"call"}},e.arguments.unshift({type:"Identifier",name:"$this"}))}},ThisExpression:()=>({type:"Identifier",name:"$this"})},closest(e,t){let i=e;do{if(i.type===t)return i}while(i=i.parent);return null},serialize:(e,t)=>{var i,r;if("string"==typeof e)return e;t&&(e.parent=t);var n=null===(i=(r=s.transformations)[e.type])||void 0===i?void 0:i.call(r,e,t);if("object"==typeof n&&null!=n&&n.type)e=n;else if(void 0!==n)return n;if(!e.type||!s.serializers[e.type])throw new TypeError("Cannot understand this expression at all ");return s.serializers[e.type](e,t)},rewrite:function(e,t){let i=s.parse(e);return t&&(t.ast=i),s.serialize(i)},compile:function(e,t){return/\S/.test(e)?(e=s.rewrite(e,t),e="with (Mavo.Data.stub)\n\twith (data || {}) {\n\t\tlet $fn = Mavo.Script.$fn;\n\t\treturn (".concat(e,");\n\t}"),null!=t&&t.actions&&(e="\nMavo.Actions._running = Mavo.Actions.running;\nMavo.Actions.running = true;\n".concat(e,"\nMavo.Actions.running = Mavo.Actions._running;")),new Function("data",e)):()=>""},parse:self.jsep,serializeScopeCall:e=>{var t="with (Mavo.Script.subScope(scope, $this) || {}) { return (".concat(s.serialize(e[1]),"); }");return"(function() {\n\tvar scope = ".concat(s.serialize(e[0]),";\n\tif (Array.isArray(scope)) {\n\t\treturn scope.map(function(scope) {\n\t\t\t").concat(t,"\n\t\t});\n\t}\n\n\t").concat(t,"\n})()")},subScope:(e,t)=>{var i=Object.keys(t).reduce(((e,t)=>(e[t]=!0,e)),{$this:!0});return e&&"object"==typeof e?new Proxy(e,{get:(e,t,r)=>t===Symbol.unscopables?i:Reflect.get(e,t,r)}):e}};for(let e in s.serializers.LogicalExpression=s.serializers.BinaryExpression,s.transformations.LogicalExpression=s.transformations.BinaryExpression,s.operators){var n;let t=s.operators[e];if(2>(null===(n=t.scalar)||void 0===n?void 0:n.length))var a=s.addUnaryOperator(e,t);else a=s.addBinaryOperator(e,t);t.code=t.code||a,a&&!1!==t.export&&(Mavo.Functions[e]=a)}Mavo.Functions.compare=function(...e){let t=!0;for(let i=2;i<e.length;i+=2){let r=e[i-2],n=e[i-1],a=e[i],o=s.binaryOperation(r,a,Mavo.Script.operators[n]);t=s.binaryOperation(t,o,Mavo.Script.operators.and)}return t}}(Bliss,Mavo.value,Mavo.Functions.util),function(e){Mavo.attributes.push("mv-action");let t=Mavo.Actions={listener:e=>{let i="submit"===e.type?"form":":not(form)",r=e.target.closest(i+"[mv-action]");if(r){let i=Mavo.Node.get(r);i&&i.editing&&"edit"!==i.modes||("submit"===e.type&&e.preventDefault(),r&&t.run(r.getAttribute("mv-action"),r,e))}},run:(e,t,i)=>{if(e){let r=Mavo.Node.getClosest(t);if(r){let t=new Mavo.Expression(e,{actions:!0}),s=Mavo.Functions.$evt;Mavo.Functions.$evt=i;let n=t.eval(r.getLiveData());return Mavo.Functions.$evt=s,n}}},getNodes:e=>{let i=t.getNode(e);return i?[i]:Mavo.toArray(e).map((e=>t.getNode(e))).filter((e=>void 0!==e))},getNode:e=>e instanceof Mavo.Node?e:null!=e&&e[Mavo.toNode]?e[Mavo.toNode]:void 0,getCollection:e=>{var i;let r=t.getNode(e);return r instanceof Mavo.Collection?r:null!==(i=null==r?void 0:r.collection)&&void 0!==i?i:null},nope:()=>{let e=Object.keys(t.Functions).map((e=>"".concat(e,"()")));Mavo.warn("Mavo actions (".concat(e,") can only be used in the mv-action attribute."))},Functions:{add:Object.assign((function(e,i,r){let s,n=[...arguments];if(3>arguments.length&&(1>=arguments.length?[e,i]=[void 0,e]:2===arguments.length&&(s=t.getCollection(i),!s&&(s=t.getCollection(e),s&&([e,i,r]=[void 0,e,i])))),i){if(s=s||t.getCollection(i),s||(s=t.getCollection(this),s&&([e,r]=n)),!s)return Mavo.warn("No collection or collection item provided to add().",{once:!1}),e;if(void 0===r){let e=t.getNode(i);e&&e.collection===s&&(r=e.index)}return(Array.isArray(e)?e:[e]).map((e=>{let t=s.add(void 0,r);return void 0!==e&&t.render(e),s.editing&&s.editItem(t),t.getLiveData()}))}}),{needsContext:!0}),move:(i,r,s)=>{var n;if(!i||void 0===r)return;let a=t.getNode(r);"number"!=e.type(r)||null!==(n=a)&&void 0!==n&&n.collection||([s,r]=[r],a=void 0);let o=Mavo.toArray(i).map(t.getNode).filter((e=>null==e?void 0:e.closestCollection)),l=(a||o[0]).closestCollection;if(!o.length)return l?(Mavo.warn("First parameter of move() was not a collection or collection item, using add() instead.",{once:!1}),t.Functions.add(i,l,s)):(Mavo.warn("You need to provide at least one collection or collection item for move() to have something to do.",{once:!1}),i);let u=t.Functions.add(i,l,s);return Mavo.Collection.delete(o,{silent:!0}),u},clear:(...e)=>{if(!e.length||!e[0])return;let i=t.getNodes(e.flat()),r=[];return i.forEach((e=>{e&&(e instanceof Mavo.Collection?r.push(...e.children):e.collection?r.push(e):e.walk((i=>{i instanceof Mavo.Primitive?i.value=null:i!==e&&t.Functions.clear(i)})))})),Mavo.Collection.delete(r),i.map((e=>e.getLiveData()))},clearif:(e,...i)=>(i=i.map((t=>Mavo.Functions.iff(e,t))),t.Functions.clear(...i)),set:(e,i)=>{if(e){let r=t.getNode(e);if(r)r.render(i);else{let r=Array.isArray(e),s=t.getNodes(e);s.length?Mavo.Script.binaryOperation(r?s:s[0],i,{scalar:(e,t)=>e?e.render(t):null}):Mavo.warn("The first parameter of set() needs to be one or more existing properties, ".concat(Mavo.safeToJSON(e)," is not."))}return i}}}};for(let e in t.Functions){let i=e+"if";i in t.Functions||(t.Functions[i]=(i,r,...s)=>(r=Mavo.Functions.iff(i,r),Mavo.value(i)?t.Functions[e](r,...s):null))}t.Functions.deleteif=t.Functions.clearif}(Bliss,Bliss.$),function(e){var t=Mavo.Data=e.Class(class{constructor(e,t){this.node=e,void 0!==t&&(this.data=t)}get parent(){var e,t=this.node.parent;return null!==(e=null==t?void 0:t.liveData)&&void 0!==e?e:null}get collection(){return this.node.collection}get key(){return this._key=this.collection?this.node.index:this.node.property}proxify(){return t.proxify(this.data)}update(){if(this.node instanceof Mavo.Collection||this.node instanceof Mavo.ImplicitCollection){this.data.length=0;for(var e=0;e<this.node.children.length;e++)this.data[e]=this.node.children[e].liveData.data;if(this.node instanceof Mavo.ImplicitCollection){for(e=0;e<this.data.length;e++)null===Mavo.value(this.data[e])&&(this.data.splice(e,1),e--);this.updateParent()}}else if(this.node instanceof Mavo.Primitive){var i=this.node.value;this.node.isDataNull({live:!0})&&(i=null),this.data=Mavo.objectify(i),(Mavo.isPlainObject(i)||Array.isArray(i))&&t.computeRoutes(this.data),this.updateParent()}}updateParent(){if(this.parent)if(this.node instanceof Mavo.ImplicitCollection){var e=1===this.data.length?this.data[0]:this.data;this.parent.set(this.node.property,e,!0)}else if(this.collection instanceof Mavo.ImplicitCollection)this.parent.update();else{var t=this.key,i=!1;this.collection instanceof Mavo.Collection&&(i=this.collection.children[this.node.index]!==this.node),void 0===t||i||this.parent.set(t,this.data,!0)}}set(e,i,r){this.data[e]=i,t["computeRoute"+(r?"":"s")](i,e,this.data)}updateKey(){var e=this._key;this.parent[e]===this.data&&delete this.parent[e],this.updateParent()}resolve(e){return t.resolve(e,this.data)}},{live:{data:function(e){var t;if(e!==this._data)return this.isArray=Array.isArray(e),this._data=e,e[Mavo.toNode]=this.node,e[Mavo.parent]=null===(t=this.parent)||void 0===t?void 0:t.data,e[Mavo.mavo]=this.node.mavo,this.proxy=this.proxify(),this.updateParent(),this._data}},static:{stub:self.Proxy?new Proxy({[Symbol.unscopables]:{data:!0,undefined:!0}},{get:(e,t)=>{var i=Reflect.get(e,t);if(void 0!==i||"string"!=typeof t)return i;var r=t.toLowerCase();if("$"===r[0]&&r in Mavo.Functions)return Mavo.Functions[r];var s=t.toUpperCase();if(s in Math)return Math[s];if("undefined"!=typeof window&&window.hasOwnProperty(t))return window[t];if("$"!==t[0]){var n="$"+t.toLowerCase();if(n in Mavo.Functions)return Mavo.Functions[n]}return t},has:(e,t)=>Reflect.has(e,t)||"string"==typeof t}):Mavo.Functions,isItem:e=>Array.isArray(null==e?void 0:e[Mavo.parent]),isCollection:e=>Array.isArray(e)&&(null==e?void 0:e[Mavo.toNode])instanceof Mavo.Collection,closest(e,t){var i=[];do{if(t(e))return{value:e,path:i};i.push(e[Mavo.property])}while(e=e[Mavo.parent]);return{value:null,path:i}},root:e=>t.closest(e,(e=>!e[Mavo.parent])),closestItem:e=>t.closest(e,t.isItem),closestArray:e=>t.closest(e,Array.isArray),getProperty:e=>(t.isItem(e)?e[Mavo.parent]:e)[Mavo.property],find(e,i,r={}){if(i&&r.exclude!==i){if(Mavo.in(e,i)&&r.exclude!==i[e])return i[e];if(!i[Mavo.route]||!Mavo.in(e,i[Mavo.route])){if(i[Mavo.property]===e)return i;if(t.isItem(i)&&t.getProperty(i)===e)return i;if(Array.isArray(i))if((s=i.map((i=>t.find(e,i))).filter((e=>void 0!==e))).length)return s.flat();return}var s,n=[],a=Array.isArray(i);n[Mavo.route]={},n[Mavo.mavo]=i[Mavo.mavo];var o=s=>{var o=t.find(e,i[s],r);if(void 0!==o){if(Mavo.in(Mavo.route,o))for(var l in o[Mavo.route])n[Mavo.route][l]=!0;Array.isArray(o)?(n.push(...o),a=!0):n.push(o)}};if(Array.isArray(i)||!0===i[Mavo.route][e])for(var l in i)o(l);else i[Mavo.route][e].forEach(o);return a||1<n.length?n:n[0]}},findUp(e,i){let r,s=i,n=t.isCollection(i);do{if(!t.isCollection(s)||n){let i=t.find(e,s,{exclude:r});if(void 0!==i)return i;if(t.getProperty(s)===e)return s}r=s,s=s[Mavo.parent]}while(s)},resolve(e,i){if(e===Mavo.isProxy)return!0;if("symbol"==typeof e)return i[e];var r,s=!isNaN(e);if(e in i)r=i[e];else{if(t.isCollection(i)&&i[Mavo.property]===e)return i;if(!s)if(e in t.special)r=t.special[e](i);else if(i[Mavo.mavo]){var n=i[Mavo.mavo].root.liveData.data[Mavo.route];Mavo.in(e,n)&&(r=t.findUp(e,i))}else Mavo.in(Mavo.route,i)&&Mavo.in(e,i[Mavo.route])&&(r=t.find(e,i))}if(!s)var a=e.toLowerCase();if(void 0!==r)return null!==r&&"object"==typeof r&&(Mavo.route in r||Mavo.toNode in r)?t.proxify(r):r;if(!s){var o,l;if(isNaN(e)&&null!==(o=Mavo.all)&&void 0!==o&&null!==(l=o[e])&&void 0!==l&&l.root)return Mavo.all[e].root.getLiveData();if("$"!==e[0]){var u="$"+a;if(u in t.special)return t.resolve(u,i)}}},has(e,i){if(e===Mavo.isProxy)return!0;if("string"!=typeof e)return Reflect.has(i,e);if(t.getProperty(i)===e)return!0;var r=[i,Mavo.all,t.special];if(r.some((t=>e in t)))return!0;if("string"==typeof e){var s=e.toLowerCase();if(s!==e&&r.some((e=>s in e)))return!0;if("$"!==s[0]&&"$"+s in t.special)return!0}return i[Mavo.mavo]?Mavo.in(e,i[Mavo.mavo].root.liveData.data[Mavo.route]):void 0},proxify:e=>e&&"object"==typeof e&&self.Proxy&&!e[Mavo.isProxy]?new Proxy(e,{get:(e,i)=>t.resolve(i,e),has:(e,i)=>t.has(i,e),set:function(e,t="",i){return"symbol"==typeof t?Reflect.set(e,t,i):(Mavo.warn("You cannot set data via expressions. Attempt to set ".concat(t.toString()," to ").concat(i," ignored.")),i)}}):e,computeMetadata(e,t,i){e&&"object"==typeof e&&(void 0!==t&&(e[Mavo.property]=t),i&&!e[Mavo.parent]&&(e[Mavo.parent]=i))},computeRoute(i,r,s){if("function"!=typeof i&&(t.computeMetadata(i,r,s),(Mavo.isPlainObject(i)||Array.isArray(i))&&!i[Mavo.route]&&(i[Mavo.route]={}),"number"!==e.type(r)))for(var n=i;s;){var a;s[Mavo.route]||(s[Mavo.route]={});var o=null===(a=n)||void 0===a?void 0:a[Mavo.property];if(o&&!0!==s[Mavo.route][r]){if(s[Mavo.route][r]||(s[Mavo.route][r]=new Set),s[Mavo.route][r].has(o))break;s[Mavo.route][r].add(o)}else s[Mavo.route][r]=!0;n=s,s=s[Mavo.parent]}},computeRoutes(e,i,r){t.traverse(t.computeRoute,e,i,r)},traverseDown(e,i){if(Array.isArray(i))i.forEach(((r,s)=>t.traverse(e,r,s,i)));else if(Mavo.isPlainObject(i))for(var r in i)t.traverse(e,i[r],r,i)},traverse(e,i,r,s){e(i,r,s),t.traverseDown(e,i,r,s)},special:{$index:function(e){var i=t.closestItem(e).value;if(!i)return-1;var r=i[Mavo.property];return isNaN(r)?i[Mavo.parent].indexOf(i):r},$item:function(e){return t.closestItem(e).value},$all:function(i){var r,s=t.closestArray(i);let n,a=s.path.reverse();[n,...a]=a;var o=s.value.map((t=>e.value(t,...a)));return 0<o.length&&null!=o&&null!==(r=o[0])&&void 0!==r&&r[Mavo.route]&&(o[Mavo.route]=e.each(o[0][Mavo.route],(()=>!0)),o[Mavo.mavo]=o[0][Mavo.mavo]),e.lazy(o,{$previous:function(){return o.slice(0,n)},$next:function(){return o.slice(n)}}),o},$next:function(i){var r,s=t.closestArray(i),n=s.path.reverse(),a=s.path[0];n=n.slice(1);var o=null===(r=s.value)||void 0===r?void 0:r[a+1];return o?e.value(o,...n):null},$previous:function(i){var r,s=t.closestArray(i),n=s.path.reverse(),a=s.path[0];n=n.slice(1);var o=null===(r=s.value)||void 0===r?void 0:r[a-1];return o?e.value(o,...n):null},$this:function(e){return e}}}})}(Bliss,Bliss.$),function(e){function t(e){return new Promise((t=>setTimeout(t,e)))}var i,r;let s=Mavo.Backend.register((r=i=class extends Mavo.Backend{constructor(e,t){super(e,t),_defineProperty(this,"id","Github"),_defineProperty(this,"oAuthParams",(()=>"&scope=repo")),this.permissions.on(["login","read"]),this.login(!0)}update(t,i){super.update(t,i);let r=this.format.constructor.extensions[0]||".json";for(const e in this.defaults={repo:"mv-data",filename:"".concat(this.mavo.id).concat(r)},this.info=s.parseURL(this.source,this.defaults),i)if(!["format","mavo"].includes(e)){if("graphql"===this.info.apiCall&&"query"===e){this.info.apiData={query:i.query};continue}this.info[e]=i[e]}e.extend(this,this.info)}async get(e){if(this.isAuthenticated()||!this.path||e){let r=e?s.parseURL(e):this.info;if(r.apiData)return this.request(r.apiCall,r.apiData,"POST").then((e=>{var t;return null!==(t=e.errors)&&void 0!==t&&t.length?Promise.reject(e.errors.map((e=>e.message)).join("\n")):e.data}));let n=void 0!==r.apiParams,a={responseType:n?"response":"json",headers:{Accept:"application/vnd.github.squirrel-girl-preview"}},o=await this.request(r.apiCall,{ref:this.branch},"GET",a);if(n){let e=await o.json(),s=new URL(r.apiCall,this.constructor.apiDomain).searchParams,n=s.get("max_pages")-1;if(0<n&&null===s.get("page")&&Array.isArray(e)){let r;do{var t,i;if(r=null===(t=o.headers.get("Link"))||void 0===t||null===(i=t.match(/<(.+?)>; rel="next"/))||void 0===i?void 0:i[1],!r)break;if(o=await this.request(r,{ref:this.branch},"GET",a),!o.ok)break;{let t=await o.json();if(!Array.isArray(t))break;e.push(...t)}}while(0<--n)}return e}return r.repo&&o.content?s.atob(o.content):o}{(e=new URL("https://raw.githubusercontent.com/".concat(this.username,"/").concat(this.repo,"/").concat(this.branch||"main","/").concat(this.path))).searchParams.set("timestamp",Date.now());let t=await fetch(e.href);return t.ok?(this.branch=this.branch||"main",t.text()):404===t.status&&!this.branch&&(e.pathname="/".concat(this.username,"/").concat(this.repo,"/master/").concat(this.path),t=await fetch(e.href),t.ok)?(this.branch="master",t.text()):null}}upload(e,t=this.path){return Mavo.readFile(e).then((e=>{let i=e.slice(5),r=i.match(/^\w+\/[\w+]+/)[0];return r=r.replace("+","\\+"),i=i.replace(RegExp("^".concat(r,"(;base64)?,")),""),t=this.path.replace(/[^/]+$/,"")+t,this.put(i,t,{isEncoded:!0})})).then((e=>this.getURL(t,e.commit.sha)))}async put(e,i=this.path,r={}){if(!i)return;let n="repos/".concat(this.username,"/").concat(this.repo),a="".concat(n,"/contents/").concat(i),o=this.mavo.element.getAttribute("mv-github-commit-prefix")||"";e=r.isEncoded?e:s.btoa(e);let l,u=await this.repoInfo;if(!u||u.owner.login!==this.username||u.name!==this.repo)try{var h;u=await this.request(n),null!==(h=this.branch)&&void 0!==h||(this.branch=u.default_branch)}catch(e){var d;if(404===e.status)u=this.repoInfo=await this.request("user/repos",{name:this.repo,private:null!==(d=this.options.private)&&void 0!==d?!!d:!!r.private},"POST")}if(!this.canPush()){let e,r=await this.request("".concat(n,"/forks"),{name:this.repo},"POST");a="repos/".concat(r.full_name,"/contents/").concat(i),this.forkInfo=r;do{await t(1e3),e=await this.request("repos/".concat(r.full_name,"/commits"),{until:"1970-01-01T00:00:00Z"},"HEAD")}while(!e);u=r=e}try{l=await this.request(a,{ref:this.branch}),l=await this.request(a,{message:o+this.mavo._("gh-updated-file",{name:l.name||"file"}),content:e,branch:this.branch,sha:l.sha},"PUT")}catch(t){404==t.status&&(l=await this.request(a,{message:o+"Created file",content:e,branch:this.branch},"PUT"))}const c={context:this,fileInfo:l};return Mavo.hooks.run("gh-after-commit",c),c.fileInfo}login(e){return this.oAuthenticate(e).then((()=>this.getUser())).catch((e=>{401==e.status&&this.logout()})).then((()=>{if(this.user&&(this.permissions.on("logout"),this.info.path&&this.permissions.on(["edit","save"]),this.repo))return this.request("repos/".concat(this.username,"/").concat(this.repo)).then((e=>{var t;return null!==(t=this.branch)&&void 0!==t||(this.branch=e.default_branch),this.repoInfo=e,this.mavo.source||this.canPush()?e:this.user.info.public_repos<e.forks?this.request("https://api.github.com/graphql",{query:"query {\n\t\t\t\t\t\t\t\t\t\t\t\t\t  viewer {\n\t\t\t\t\t\t\t\t\t\t\t\t\t    name\n\t\t\t\t\t\t\t\t\t\t\t\t\t      repositories(last: 100, isFork: true) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t      nodes {\n\t\t\t\t\t\t\t\t\t\t\t\t\t        url\n\t\t\t\t\t\t\t\t\t\t\t\t\t        parent {\n\t\t\t\t\t\t\t\t\t\t\t\t\t          nameWithOwner\n\t\t\t\t\t\t\t\t\t\t\t\t\t        }\n\t\t\t\t\t\t\t\t\t\t\t\t\t      }\n\t\t\t\t\t\t\t\t\t\t\t\t\t    }\n\t\t\t\t\t\t\t\t\t\t\t\t\t  }\n\t\t\t\t\t\t\t\t\t\t\t\t\t}"},"POST").then((t=>{let i=t.data.viewer.repositories.nodes;for(let t in i)if(i[t].parent.nameWithOwner===e.full_name)return this.switchToMyForkDialog(i[t].url),e;return e})):this.request(e.forks_url).then((t=>{for(let i in t)if(t[i].owner.login===this.user.username)return this.switchToMyForkDialog(t[i].html_url),e;return e}))})).then((e=>{const t={context:this,repoInfo:e};return Mavo.hooks.run("gh-after-login",t),t.repoInfo}))}))}canPush(){var e,t;return this.repoInfo?this.repoInfo.permissions.push:(null===(e=this.user)||void 0===e||null===(t=e.username)||void 0===t?void 0:t.toLowerCase())==this.username.toLowerCase()}logout(){return this.oAuthLogout().then((()=>{this.user=null}))}getUser(){return this.user?Promise.resolve(this.user):this.request("user").then((t=>{this.user={username:t.login,name:t.name||t.login,avatar:t.avatar_url,url:"https://github.com/"+t.login,info:t},e.fire(this,"mv-login")}))}getURL(e=this.path,t){let i=this.forkInfo||this.repoInfo,r=i.full_name;return e=e.replace(/ /g,"%20"),i.pagesInfo=i.pagesInfo||this.request("repos/".concat(r,"/pages"),{},"GET",{headers:{Accept:"application/vnd.github.mister-fantastic-preview+json"}}),i.pagesInfo.then((t=>t.html_url+e)).catch((()=>"https://cdn.jsdelivr.net/gh/".concat(r,"@").concat(t||this.branch||"latest","/").concat(e)))}switchToMyForkDialog(e){let t=new URL(location).searchParams;return t.append("".concat(this.mavo.id,"-storage"),e+"/"+this.path),this.notice=this.mavo.message("\n\t\t\t".concat(this.mavo._("gh-login-fork-options"),'\n\t\t\t<form onsubmit="return false">\n\t\t\t\t<a href="').concat(location.pathname,"?").concat(t,'"><button>').concat(this.mavo._("gh-use-my-fork"),"</button></a>\n\t\t\t</form>"),{classes:"mv-inline",dismiss:["button","submit"]}),void this.notice.closed.then((e=>{e&&(history.pushState({},"","".concat(location.pathname,"?").concat(t)),location.replace("".concat(location.pathname,"?").concat(t)))}))}static test(e){return e=new URL(e,Mavo.base),/^((api\.)?github\.com|raw\.githubusercontent\.com)/.test(e.host)}static parseURL(e,t={}){const i={};Object.defineProperties(i,{apiCall:{get(){var e,t;let i="repos/".concat(this.username,"/").concat(this.repo,"/").concat(null!==(e=this.resources)&&void 0!==e?e:"contents");const r=this.path;return r&&(i+="/".concat(r)),i+(null!==(t=this.apiParams)&&void 0!==t?t:"")},set(e){delete this.apiCall,this.apiCall=e},configurable:!0,enumerable:!0},path:{get(){return this.filename?(this.filepath?this.filepath+"/":"")+this.filename:this.filepath},set(e){delete this.path,this.path=e},configurable:!0,enumerable:!0}});const r=new URL(e,Mavo.base);let s=r.pathname.slice(1).split("/");if(i.username=s.shift(),i.repo=s.shift()||t.repo,/raw.githubusercontent.com$/.test(r.host))i.branch=s.shift();else if(/api.github.com$/.test(r.host)){delete i.username,delete i.repo,i.apiParams=r.search,i.apiData=Mavo.Functions.from(e,"#");const t=r.pathname.slice(1)+i.apiParams;if("graphql"==t)return i.apiCall=t,i.apiData={query:i.apiData},i;s=r.pathname.slice(1).split("/");if("repos"!=s.shift())return i.apiCall=t,i;i.username=s.shift(),i.repo=s.shift(),i.resources=s.shift()}else"blob"==s[0]&&(s.shift(),i.branch=s.shift());const n=s[s.length-1];return/\.\w+$/.test(n)?(i.filename=n,s.splice(s.length-1,1)):i.filename=i.hasOwnProperty("apiParams")?"":t.filename,i.filepath=s.join("/")||t.filepath||"",i}},_defineProperty(i,"apiDomain","https://api.github.com/"),_defineProperty(i,"oAuth","https://github.com/login/oauth/authorize"),_defineProperty(i,"key","7e08e016048000bc594e"),_defineProperty(i,"btoa",(e=>btoa(unescape(encodeURIComponent(e))))),_defineProperty(i,"atob",(e=>decodeURIComponent(escape(window.atob(e))))),r))}(Bliss,Bliss.$);